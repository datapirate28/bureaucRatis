<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bureaucRatis</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Your vocabulary learning companion with spaced repetition">
    <meta name="theme-color" content="#6366f1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="bureaucRatis">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- App Icons -->
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">

    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. React & ReactDOM Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>

    <!-- 3. Babel for JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Smooth fade for elements */
        .fade-enter {
            opacity: 0;
            transform: translateY(10px);
        }

        .fade-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 300ms, transform 300ms;
        }

        /* Creative Nav Blur - Light */
        .nav-glass-light {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }

        /* Creative Nav Blur - Dark (Redesigned) */
        .nav-glass-dark {
            background: rgba(10, 10, 10, 0.5);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5);
        }

        /* Content Glass Panels */
        .glass-panel-light {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .glass-panel-dark {
            background: rgba(20, 20, 25, 0.6);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .text-shadow {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Custom Animations */
        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        .animate-float {
            animation: float 6s ease-in-out infinite;
        }

        .animate-float-delayed {
            animation: float 6s ease-in-out 3s infinite;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-up {
            animation: slideUp 0.8s ease-out forwards;
        }

        /* Stagger Delays */
        .delay-100 {
            animation-delay: 100ms;
        }

        .delay-200 {
            animation-delay: 200ms;
        }

        .delay-300 {
            animation-delay: 300ms;
        }

        .delay-500 {
            animation-delay: 500ms;
        }

        .delay-700 {
            animation-delay: 700ms;
        }

        .delay-1000 {
            animation-delay: 1000ms;
        }

        /* Messenger Animations */
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .animate-message-in {
            animation: messageSlideIn 0.3s ease-out forwards;
        }

        @keyframes messageSent {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }

            100% {
                transform: scale(1);
            }
        }

        .animate-message-sent {
            animation: messageSent 0.3s ease-out;
        }

        @keyframes messengerOpen {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .animate-messenger-open {
            animation: messengerOpen 0.35s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes typing {

            0%,
            60%,
            100% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-4px);
            }
        }

        .animate-typing-dot {
            animation: typing 1s ease-in-out infinite;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        .animate-pulse-ring::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            border: 2px solid currentColor;
            animation: pulse-ring 1.5s ease-out infinite;
        }

        /* Smooth scrollbar for messenger */
        .messenger-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .messenger-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .messenger-scroll::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.3);
            border-radius: 3px;
        }

        .messenger-scroll::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 102, 241, 0.5);
        }

        /* Peers Post Animations */
        @keyframes likeHeart {
            0% {
                transform: scale(1);
            }

            25% {
                transform: scale(1.3);
            }

            50% {
                transform: scale(0.95);
            }

            100% {
                transform: scale(1);
            }
        }

        .animate-like-heart {
            animation: likeHeart 0.4s ease-out;
        }

        /* Lightbox Styles */
        .lightbox-overlay {
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(8px);
        }

        .lightbox-image {
            max-width: 90vw;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        @keyframes lightboxZoomIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-lightbox-in {
            animation: lightboxZoomIn 0.3s ease-out forwards;
        }

        @keyframes postSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .animate-post-in {
            animation: postSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        .animate-shimmer {
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
    </style>
</head>

<body class="font-sans overflow-x-hidden transition-colors duration-500">
    <div id="root"></div>

    <!-- Service Worker Registration & Install Prompt -->
    <script>
        // Store the install prompt for later use
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('beforeinstallprompt fired');
            e.preventDefault();
            deferredPrompt = e;
            // Show your own install button or notification here if desired
            console.log('App is installable!');
        });

        window.addEventListener('appinstalled', () => {
            console.log('App was installed');
            deferredPrompt = null;
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('SW registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('SW registration failed:', error);
                    });
            });
        }
    </script>

    <!-- Error Handler -->
    <script>
        window.onerror = function (message, source, lineno, colno, error) {
            if (document.getElementById('root').innerHTML === "") {
                console.error(message);
            }
        };
    </script>

    <!-- 4. Application Logic -->
    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import {
            BookOpen, Repeat, Link as LinkIcon, ArrowLeftRight, MessageCircle,
            Plus, Check, X, Save, Trash2, Brain, TrendingUp, Clock,
            Search, Sparkles, Zap, Layers, Loader2, AlertTriangle, User,
            LogOut, ShieldCheck, LogIn, ChevronDown, Play, ArrowLeft, Trophy,
            Book, Mic, Volume2, Wand2, Star, ChevronRight, Activity, Grid, List,
            Moon, Sun, Upload, Pencil, Send, Users, MessageSquare, Circle, Heart, UserPlus, UserMinus, UserCheck,
            CheckCheck, Image as ImageIcon, MessagesSquare, Share2, Inbox, Gift, Package, FileText, ExternalLink, Eye,
            Shield, Ban, Mail, AlertCircle, RefreshCw, Copy
        } from 'lucide-react';

        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import {
            getAuth,
            signInAnonymously,
            onAuthStateChanged,
            signInWithCustomToken,
            GoogleAuthProvider,
            signInWithPopup,
            linkWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            query,
            onSnapshot,
            deleteDoc,
            doc,
            getDoc,
            getDocs,
            setDoc,
            updateDoc,
            serverTimestamp,
            orderBy,
            where,
            limit
        } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        // --- FIREBASE SETUP ---
        const getFirebaseConfig = () => {
            if (typeof __firebase_config !== 'undefined') {
                return JSON.parse(__firebase_config);
            }
            // Fallback for demo/dev if config not injected
            return {
                apiKey: "AIzaSyDHD8AhAFmlH9Cr06dBGTS9Lpvqvs9jNtM",
                authDomain: "bureaucratis-6a362.firebaseapp.com",
                projectId: "bureaucratis-6a362",
                storageBucket: "bureaucratis-6a362.firebasestorage.app",
                messagingSenderId: "310102127551",
                appId: "1:310102127551:web:bb5994c0e73b952804a70a",
                measurementId: "G-PEGW7J88ZW"
            };
        };

        const firebaseConfig = getFirebaseConfig();
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'fluency-flow-standalone';

        // --- ADMIN CONFIG ---
        const ADMIN_EMAIL = 'codingsprint.com@gmail.com';
        const isAdmin = (user) => user?.email === ADMIN_EMAIL;

        // --- UTILS ---
        const calculateNextReview = (rating, previousInterval, previousEasiness) => {
            let newInterval;
            let newEasiness = previousEasiness + (0.1 - (5 - rating) * (0.08 + (5 - rating) * 0.02));
            if (newEasiness < 1.3) newEasiness = 1.3;
            if (rating < 3) { newInterval = 1; }
            else {
                if (previousInterval === 0) newInterval = 1;
                else if (previousInterval === 1) newInterval = 6;
                else newInterval = Math.round(previousInterval * newEasiness);
            }
            return { interval: newInterval, easiness: newEasiness };
        };

        const getRelativeTime = (timestamp) => {
            const diff = timestamp - Date.now();
            if (diff < 0) return 'Ready now';
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            if (days > 0) return `in ${days}d`;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            return `in ${hours}h`;
        };

        const speakText = (text, onError) => {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                window.speechSynthesis.speak(utterance);
                return true;
            } else {
                if (onError) onError("Text-to-speech is not supported in this browser.");
                return false;
            }
        };

        const getMasteryStars = (interval) => {
            if (interval > 21) return 5;
            if (interval > 10) return 4;
            if (interval > 4) return 3;
            if (interval > 1) return 2;
            return 1;
        };

        // --- COMPONENTS ---

        const ItemCard = ({ title, subtitle, icon: Icon, colorClass, onDelete, onSpeak, onEdit, onShare, interval, type, theme, sharedBy }) => {
            const gradients = {
                voca: "from-indigo-500 to-blue-500",
                synonym: "from-violet-500 to-purple-500",
                antonym: "from-rose-500 to-pink-500",
                phrase: "from-amber-400 to-orange-500"
            };

            const bgGradient = gradients[type] || "from-slate-500 to-slate-600";

            // Modern Dark Mode Card: Darker bg, subtle border, deeper shadow
            const cardClass = theme === 'dark'
                ? "bg-[#16161a]/60 border-white/5 shadow-lg hover:bg-[#1c1c21]/80 hover:shadow-indigo-500/10 hover:border-white/10"
                : "bg-white border-slate-100 shadow-[0_4px_20px_-4px_rgba(0,0,0,0.05)] hover:shadow-[0_8px_30px_-4px_rgba(0,0,0,0.1)]";

            const textMain = theme === 'dark' ? "text-gray-100" : "text-slate-800";
            const textSub = theme === 'dark' ? "text-gray-400" : "text-slate-500";
            const btnBg = theme === 'dark' ? "bg-white/5 hover:bg-indigo-500/20 text-gray-400 hover:text-indigo-300" : "bg-slate-50 hover:bg-indigo-50 text-slate-400 hover:text-indigo-600";

            return (
                <div className={`${cardClass} p-4 rounded-3xl border flex items-center gap-5 transition-all duration-300 group`}>
                    <div className={`w-20 h-20 rounded-2xl bg-gradient-to-br ${bgGradient} flex items-center justify-center text-white shadow-md shrink-0 relative`}>
                        <Icon className="w-8 h-8" />
                        {sharedBy && (
                            <div className="absolute -bottom-1 -right-1 w-6 h-6 rounded-full bg-emerald-500 border-2 border-white dark:border-slate-800 flex items-center justify-center" title={`Shared by ${sharedBy.displayName}`}>
                                <Share2 className="w-3 h-3 text-white" />
                            </div>
                        )}
                    </div>
                    <div className="flex-1 min-w-0">
                        <h4 className={`text-xl font-bold ${textMain} truncate`}>{title}</h4>
                        <p className={`${textSub} text-sm font-medium mt-1 truncate`}>{subtitle}</p>
                        {sharedBy && (
                            <div className="flex items-center gap-1.5 mt-2">
                                {sharedBy.photoURL ? (
                                    <img src={sharedBy.photoURL} className="w-4 h-4 rounded-full" alt="" />
                                ) : (
                                    <div className="w-4 h-4 rounded-full bg-emerald-500/20 flex items-center justify-center">
                                        <User className="w-2.5 h-2.5 text-emerald-500" />
                                    </div>
                                )}
                                <span className="text-xs font-medium text-emerald-500">
                                    Shared by {sharedBy.displayName}
                                </span>
                            </div>
                        )}
                    </div>
                    <div className="flex flex-col gap-2">
                        {onSpeak && (
                            <button onClick={onSpeak} className={`w-10 h-10 rounded-full flex items-center justify-center transition-colors ${btnBg}`}>
                                <Volume2 className="w-5 h-5" />
                            </button>
                        )}
                        {onShare && (
                            <button onClick={onShare} className={`w-10 h-10 rounded-full flex items-center justify-center transition-colors ${theme === 'dark' ? 'bg-white/5 hover:bg-emerald-500/20 text-gray-400 hover:text-emerald-300' : 'bg-emerald-50 hover:bg-emerald-100 text-emerald-500 hover:text-emerald-600'}`} title="Share to Peers">
                                <Share2 className="w-5 h-5" />
                            </button>
                        )}
                        {onEdit && (
                            <button onClick={onEdit} className={`w-10 h-10 rounded-full flex items-center justify-center transition-colors ${btnBg}`}>
                                <Pencil className="w-5 h-5" />
                            </button>
                        )}
                        {onDelete && (
                            <button onClick={onDelete} className={`w-10 h-10 rounded-full flex items-center justify-center transition-colors ${theme === 'dark' ? 'bg-white/5 hover:bg-rose-500/20 text-rose-400 hover:text-rose-300' : 'bg-rose-50 hover:bg-rose-100 text-rose-500 hover:text-rose-600'}`}>
                                <Trash2 className="w-5 h-5" />
                            </button>
                        )}
                    </div>
                </div>
            );
        };

        // --- LOGIN PAGE DESIGN (RESPONSIVE) ---
        const LoginPage = ({ onLogin, error }) => (
            <div className="min-h-screen flex flex-col items-center justify-center font-sans bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 relative overflow-hidden p-4 sm:p-6 md:p-8">

                {/* Background decorative elements */}
                <div className="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
                    <div className="absolute top-[10%] left-[10%] w-64 h-64 bg-white/40 rounded-full blur-3xl animate-pulse"></div>
                    <div className="absolute bottom-[10%] right-[10%] w-80 h-80 bg-purple-300/30 rounded-full blur-3xl animate-float"></div>
                    <div className="absolute top-[40%] left-[60%] w-40 h-40 bg-pink-300/30 rounded-full blur-3xl"></div>
                </div>

                {/* Main Content Container - switched to lg:flex-row for better tablet/desktop spacing */}
                <div className="relative z-10 w-full max-w-7xl flex flex-col lg:flex-row items-center justify-between gap-10 lg:gap-16">

                    {/* Left/Top Side: Visuals & Brand */}
                    <div className="flex-1 w-full flex flex-col items-center lg:items-start text-center lg:text-left">

                        {/* Brand Logo - Centered on mobile, Left on Desktop */}
                        <div className="mb-6 md:mb-10 animate-slide-up self-center lg:self-start">
                            {/* PLACEHOLDER FOR LOGO IMAGE - UPLOAD YOUR LOGO HERE */}
                            <img src="2.png" alt="FluencyFlow Logo" className="h-16 md:h-20 w-auto object-contain rounded-full shadow-2xl" />
                        </div>

                        <h2 className="font-black text-slate-900 mb-4 md:mb-6 leading-tight animate-slide-up delay-100 flex flex-col gap-2">
                            {/* Responsive Text Sizes: starts smaller on mobile, grows on larger screens */}
                            <span className="text-5xl sm:text-6xl md:text-7xl lg:text-8xl font-black text-slate-900 tracking-tight">bureaucRatis</span>
                            <span className="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-bold">The Smart Way</span>
                        </h2>

                        <p style={{ marginBottom: '1.5rem', color: 'gray' }}>Join 100s of students learning English vocabulary with bureaucRatis scientifically.</p>



                        {/* Call to Action Section */}
                        <div className="w-full max-w-md animate-slide-up delay-300">
                            <div className="bg-white/60 backdrop-blur-xl border border-white/60 p-6 md:p-8 rounded-[2rem] shadow-xl relative overflow-hidden group hover:bg-white/70 transition-all duration-300">
                                <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>

                                <p className="text-center text-slate-800 font-bold text-base md:text-lg mb-6">
                                    Continue with Google â€” <span className="text-indigo-600 block sm:inline">Make a free account.</span>
                                </p>

                                <button onClick={onLogin} className="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 md:py-4 rounded-xl flex items-center justify-center gap-3 transition-all hover:scale-[1.02] shadow-lg active:scale-95 group-hover:shadow-indigo-500/20 text-sm md:text-base">
                                    <div className="p-1 md:p-1.5 bg-white rounded-full">
                                        <svg className="w-4 h-4 md:w-5 md:h-5" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" /><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" /><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" /><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" /></svg>
                                    </div>
                                    <span>Continue with Google</span>
                                </button>

                                {error && <div className="mt-4 p-3 bg-red-50 text-red-600 text-xs font-bold rounded-lg text-center border border-red-100">{error}</div>}
                            </div>
                        </div>
                    </div>

                    {/* Right/Bottom Side: Animation */}
                    <div className="flex-1 flex justify-center items-center relative animate-float-delayed w-full mt-10 lg:mt-0">
                        {/* Abstract 3D-ish Composition - Responsive sizes */}
                        <div className="relative w-64 h-64 sm:w-80 sm:h-80 md:w-96 md:h-96">

                            {/* Main Purple Block (Brain) */}
                            <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-40 h-40 sm:w-48 sm:h-48 bg-gradient-to-br from-indigo-500 to-violet-600 rounded-[2rem] shadow-2xl flex items-center justify-center z-20 animate-float border-4 border-white/20">
                                <Brain className="w-20 h-20 sm:w-24 sm:h-24 text-white stroke-[1.5]" />
                            </div>

                            {/* Floating Elements mimicking screenshot - Repositioned for responsiveness */}

                            {/* Pink Circle */}
                            <div className="absolute top-0 left-4 sm:left-10 w-12 h-12 sm:w-16 sm:h-16 bg-pink-400 rounded-full shadow-lg opacity-90 animate-float-delayed" style={{ animationDuration: '5s' }}></div>

                            {/* White Square (Book) */}
                            <div className="absolute top-4 right-4 sm:right-10 w-16 h-16 sm:w-20 sm:h-20 bg-white rounded-2xl shadow-xl flex items-center justify-center animate-float" style={{ animationDuration: '7s', animationDelay: '1s' }}>
                                <BookOpen className="w-8 h-8 sm:w-10 sm:h-10 text-indigo-500" />
                            </div>

                            {/* White Square (Link) */}
                            <div className="absolute bottom-6 sm:bottom-10 left-0 w-16 h-16 sm:w-20 sm:h-20 bg-white rounded-2xl shadow-xl flex items-center justify-center animate-float-delayed" style={{ animationDuration: '6s', animationDelay: '0.5s' }}>
                                <LinkIcon className="w-8 h-8 sm:w-10 sm:h-10 text-violet-500" />
                            </div>

                            {/* Blue Diamond */}
                            <div className="absolute bottom-16 sm:bottom-20 right-4 w-10 h-10 sm:w-14 sm:h-14 bg-indigo-400 rounded-xl shadow-lg transform rotate-45 animate-float" style={{ animationDuration: '4s', animationDelay: '1.5s' }}></div>
                        </div>
                    </div>
                </div>
            </div>
        );

        const Navigation = ({ activeTab, setActiveTab, user, onLogout, items, streak, theme, toggleTheme, setIsMessengerOpen, totalUnreadMessages, setIsShareModalOpen, setIsSharingInboxOpen, shareRequestCount, setIsProfileModalOpen }) => {
            // Build nav items - include Admin tab only for admin user
            const navItems = [
                { id: 'dashboard', label: 'Dashboard', icon: Grid },
                { id: 'mylearning', label: 'My Learning', icon: Book },
                { id: 'peers', label: 'Peers', icon: Users },
                // Admin tab - only visible to admin
                ...(isAdmin(user) ? [{ id: 'admin', label: 'Admin', icon: Shield }] : [])
            ];
            const level = Math.floor((items?.length || 0) / 5) + 1;

            // State for mobile tap-to-expand icons
            const [iconsExpanded, setIconsExpanded] = React.useState(false);
            const iconsContainerRef = React.useRef(null);

            // Handle click outside to collapse icons on mobile
            React.useEffect(() => {
                const handleClickOutside = (event) => {
                    if (iconsContainerRef.current && !iconsContainerRef.current.contains(event.target)) {
                        setIconsExpanded(false);
                    }
                };
                if (iconsExpanded) {
                    document.addEventListener('mousedown', handleClickOutside);
                    document.addEventListener('touchstart', handleClickOutside);
                }
                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                    document.removeEventListener('touchstart', handleClickOutside);
                };
            }, [iconsExpanded]);

            // Handle messenger button click - expand first on mobile, then open
            const handleMessengerClick = () => {
                // Check if it's a touch device (mobile)
                const isTouchDevice = window.matchMedia('(hover: none)').matches;
                if (isTouchDevice && !iconsExpanded) {
                    setIconsExpanded(true);
                } else {
                    setIsMessengerOpen(true);
                    setIconsExpanded(false);
                }
            };

            // Handle share button click
            const handleShareClick = () => {
                setIsShareModalOpen(true);
                setIconsExpanded(false);
            };

            // Handle inbox button click
            const handleInboxClick = () => {
                setIsSharingInboxOpen(true);
                setIconsExpanded(false);
            };

            const navClass = theme === 'dark' ? 'nav-glass-dark' : 'nav-glass-light';
            // Dark Mode: White text for base. Light Mode: Slate 600.
            const textBase = theme === 'dark' ? 'text-gray-300' : 'text-slate-600';
            const textHover = theme === 'dark' ? 'hover:text-white hover:bg-white/10' : 'hover:text-slate-900 hover:bg-white/40';
            // Dark Mode Active: Bright Indigo gradient or solid punchy color.
            const activeClass = theme === 'dark'
                ? 'bg-gradient-to-r from-indigo-600 to-violet-600 text-white shadow-[0_0_15px_rgba(99,102,241,0.5)] border border-white/10'
                : 'bg-slate-900 text-white shadow-xl';

            const logoColor = theme === 'dark' ? 'text-indigo-400' : 'text-indigo-600';
            // Dark Mode Logo: Lighter gradient to pop against dark bg
            const logoGradient = theme === 'dark' ? 'bg-gradient-to-r from-indigo-300 via-purple-300 to-pink-300' : 'bg-gradient-to-r from-indigo-600 to-violet-600';

            return (
                <>
                    <div className="fixed top-0 left-0 right-0 z-50 px-2 sm:px-4 py-3 md:py-4 md:px-8">
                        <div className={`max-w-6xl mx-auto ${navClass} rounded-full px-3 sm:px-4 md:px-6 py-2.5 md:py-3 flex justify-between items-center transition-all duration-300`}>
                            <div className={`flex items-center gap-1.5 sm:gap-2 font-black text-lg sm:text-xl md:text-2xl cursor-pointer shrink-0 tracking-tight text-transparent bg-clip-text ${logoGradient}`} onClick={() => setActiveTab('landing')}>
                                <img src="2.png" alt="bureaucRatis Logo" className="w-8 h-8 sm:w-9 sm:h-9 md:w-[40px] md:h-[40px] rounded-full" />
                                <span className="hidden lg:inline">bureaucRatis</span>
                            </div>

                            <div className="flex space-x-0.5 sm:space-x-1 overflow-x-auto no-scrollbar mx-1 sm:mx-2 md:mx-4">
                                {navItems.map((item) => (
                                    <button
                                        key={item.id}
                                        onClick={() => setActiveTab(item.id)}
                                        className={`flex items-center gap-1 sm:gap-1.5 md:gap-2 px-2.5 sm:px-3 md:px-4 lg:px-5 py-2 sm:py-2.5 rounded-full text-xs sm:text-sm font-bold transition-all duration-300 ${activeTab === item.id
                                            ? `${activeClass} scale-105`
                                            : `${textBase} ${textHover}`
                                            }`}
                                    >
                                        <item.icon className="w-3.5 h-3.5 sm:w-4 sm:h-4" /> <span className="hidden md:inline">{item.label}</span>
                                    </button>
                                ))}
                            </div>

                            <div className="relative group z-50">
                                {user?.isAnonymous ? (
                                    <button onClick={onLogout} className="flex items-center gap-2 text-xs font-bold bg-white/20 px-4 py-2 rounded-full hover:bg-white/30 transition-colors border border-white/20 text-current"><User className="w-4 h-4" /><span className="hidden sm:inline">Guest</span></button>
                                ) : (
                                    <div>
                                        <button className={`flex items-center gap-2 text-xs font-bold ${textBase} sm:bg-white/5 sm:border border-white/10 px-1 sm:px-3 py-1.5 rounded-full sm:hover:bg-white/10 transition-all sm:backdrop-blur-md sm:shadow-sm`}>
                                            <img src={user?.photoURL} className="w-7 h-7 rounded-full border-0 sm:border border-white/20" onError={(e) => e.target.style.display = 'none'} />
                                            <span className="hidden sm:inline">{user?.displayName?.split(' ')[0] || 'User'}</span><ChevronDown className="w-3 h-3 opacity-70 hidden sm:inline" />
                                        </button>
                                        <div className="absolute right-0 top-full mt-3 w-64 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform origin-top-right">
                                            <div className={`${theme === 'dark' ? 'bg-[#0f172a]/95 border-white/10' : 'bg-white/90 border-white'} backdrop-blur-xl rounded-3xl shadow-[0_20px_50px_-12px_rgba(0,0,0,0.5)] border p-5 overflow-hidden relative`}>
                                                <div className="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-indigo-500 to-purple-500"></div>
                                                <div className="flex items-center gap-3 mb-4">
                                                    <div className={`w-12 h-12 ${theme === 'dark' ? 'bg-white/10 text-indigo-300' : 'bg-indigo-50 text-indigo-600'} rounded-2xl flex items-center justify-center text-2xl shadow-sm animate-pulse`}>ðŸ¦Š</div>
                                                    <div><div className={`text-[10px] font-bold uppercase tracking-wider ${theme === 'dark' ? 'text-gray-400' : 'text-slate-400'}`}>Level {level} Scholar</div><div className={`font-bold text-sm ${theme === 'dark' ? 'text-white' : 'text-slate-800'}`}>Hi, {user?.displayName?.split(' ')[0]}!</div></div>
                                                </div>
                                                <div className={`${theme === 'dark' ? 'bg-white/5 border-white/5' : 'bg-slate-50 border-slate-100'} rounded-2xl p-3 mb-4 flex items-center justify-between border`}>
                                                    <div className="text-left"><div className="text-[10px] text-slate-500 font-bold uppercase">Words</div><div className={`text-xl font-black leading-none ${theme === 'dark' ? 'text-indigo-400' : 'text-indigo-600'}`}>{items?.length || 0}</div></div>
                                                    <div className={`text-left border-l ${theme === 'dark' ? 'border-white/10' : 'border-slate-200'} pl-3`}><div className="text-[10px] text-slate-500 font-bold uppercase">Streak</div><div className="text-xl font-black text-orange-500 leading-none">ðŸ”¥ {streak}</div></div>
                                                </div>
                                                <div className="space-y-2">
                                                    <button onClick={() => setIsProfileModalOpen(true)} className={`w-full flex items-center justify-center gap-2 py-3 rounded-xl font-bold text-xs transition-all hover:scale-[1.02] ${theme === 'dark' ? 'bg-white/5 border border-white/10 text-white hover:bg-white/10' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}`}><User className="w-3 h-3" /> View Profile</button>
                                                    <button onClick={onLogout} className={`w-full flex items-center justify-center gap-2 py-3 rounded-xl font-bold text-xs transition-all hover:scale-[1.02] shadow-lg ${theme === 'dark' ? 'bg-indigo-600 text-white hover:bg-indigo-500' : 'bg-slate-900 text-white hover:bg-slate-800'}`}><LogOut className="w-3 h-3" /> Sign Out</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                    {/* Floating Icons - Left side horizontal, Right side theme toggle */}
                    <div className="fixed top-[84px] sm:top-[88px] md:top-24 left-0 right-0 z-40 px-2 sm:px-4 md:px-8">
                        <div className="max-w-6xl mx-auto flex justify-between items-start px-1 sm:px-2 md:px-6">
                            {/* Left Side - Icons displayed horizontally */}
                            <div ref={iconsContainerRef} className="flex flex-row items-center gap-1.5 sm:gap-2">
                                {/* Messenger Button */}
                                <button
                                    onClick={handleMessengerClick}
                                    className={`relative p-2 sm:p-2.5 rounded-lg sm:rounded-xl shadow-md transition-all duration-200 ease-out hover:scale-110 hover:shadow-lg active:scale-95 ${theme === 'dark'
                                        ? 'bg-gradient-to-br from-indigo-500 to-violet-600'
                                        : 'bg-gradient-to-br from-indigo-500 to-violet-500'
                                        }`}
                                    title="Open Messages"
                                >
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="sm:w-[22px] sm:h-[22px]">
                                        {/* Modern chat bubble */}
                                        <path d="M12 3C7.03 3 3 6.58 3 11C3 13.39 4.32 15.5 6.4 16.83L5 21L9.73 18.76C10.47 18.91 11.23 19 12 19C16.97 19 21 15.42 21 11C21 6.58 16.97 3 12 3Z" fill="white" fillOpacity="0.95" />
                                        {/* Typing dots */}
                                        <circle cx="8" cy="11" r="1.5" fill="#6366f1" />
                                        <circle cx="12" cy="11" r="1.5" fill="#8b5cf6" />
                                        <circle cx="16" cy="11" r="1.5" fill="#a855f7" />
                                    </svg>
                                    {/* Notification Badge */}
                                    {totalUnreadMessages > 0 && (
                                        <span className="absolute -top-1 -right-1 min-w-[16px] h-[16px] sm:min-w-[18px] sm:h-[18px] px-0.5 sm:px-1 bg-gradient-to-r from-red-500 to-pink-500 text-white text-[8px] sm:text-[9px] font-bold rounded-full flex items-center justify-center shadow-md border-2 border-white">
                                            {totalUnreadMessages > 99 ? '99+' : totalUnreadMessages}
                                        </span>
                                    )}
                                </button>

                                {/* Share Button */}
                                <button
                                    onClick={handleShareClick}
                                    className={`relative p-2 sm:p-2.5 rounded-lg sm:rounded-xl shadow-md transition-all duration-200 ease-out hover:scale-110 hover:shadow-lg active:scale-95 ${theme === 'dark'
                                        ? 'bg-gradient-to-br from-emerald-600 to-teal-600 border border-white/10'
                                        : 'bg-gradient-to-br from-emerald-500 to-teal-500'
                                        }`}
                                    title="Share Vocabulary"
                                >
                                    <Share2 className="w-[18px] h-[18px] sm:w-[22px] sm:h-[22px] text-white" />
                                </button>

                                {/* Sharing Inbox Button */}
                                <button
                                    onClick={handleInboxClick}
                                    className={`relative p-2 sm:p-2.5 rounded-lg sm:rounded-xl shadow-md transition-all duration-200 ease-out hover:scale-110 hover:shadow-lg active:scale-95 ${theme === 'dark'
                                        ? 'bg-gradient-to-br from-amber-600 to-orange-600 border border-white/10'
                                        : 'bg-gradient-to-br from-amber-500 to-orange-500'
                                        }`}
                                    title="Sharing Inbox"
                                >
                                    <Inbox className="w-[18px] h-[18px] sm:w-[22px] sm:h-[22px] text-white" />
                                    {/* Notification Badge */}
                                    {shareRequestCount > 0 && (
                                        <span className="absolute -top-1 -right-1 min-w-[16px] h-[16px] sm:min-w-[18px] sm:h-[18px] px-0.5 sm:px-1 bg-gradient-to-r from-red-500 to-pink-500 text-white text-[8px] sm:text-[9px] font-bold rounded-full flex items-center justify-center shadow-md border-2 border-white">
                                            {shareRequestCount > 99 ? '99+' : shareRequestCount}
                                        </span>
                                    )}
                                </button>
                            </div>

                            {/* Right Side - Theme Toggle */}
                            <div className="animate-slide-up delay-500">
                                <button
                                    onClick={toggleTheme}
                                    className={`p-2 sm:p-3 rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl hover:scale-105 active:scale-95 ${theme === 'dark'
                                        ? 'bg-gradient-to-br from-slate-700/90 to-slate-800/90 text-indigo-300 hover:from-slate-600 hover:to-slate-700 border border-white/10'
                                        : 'bg-gradient-to-br from-indigo-100/95 to-purple-100/95 text-indigo-600 hover:from-indigo-50 hover:to-purple-50'
                                        }`}
                                    title={theme === 'dark' ? "Switch to Light Mode" : "Switch to Dark Mode"}
                                >
                                    {theme === 'dark' ? <Sun className="w-[18px] h-[18px] sm:w-5 sm:h-5" /> : <Moon className="w-[18px] h-[18px] sm:w-5 sm:h-5" />}
                                </button>
                            </div>
                        </div>
                    </div>
                </>
            );
        };

        // ... LandingPage, Dashboard, VocaManager ...
        // (Applying theme props to all of them)

        const LandingPage = ({ setActiveTab, theme }) => {
            const textColor = theme === 'dark' ? 'text-white' : 'text-slate-800';
            const subTextColor = theme === 'dark' ? 'text-gray-300' : 'text-slate-600';
            const cardBgClass = theme === 'dark' ? 'glass-panel-dark' : 'glass-panel-light';
            const iconBg = theme === 'dark' ? 'bg-slate-800 text-indigo-400' : 'bg-indigo-100 text-indigo-600';

            // Dark mode Hero text gradient: Brighter to stand out
            const heroGradient = theme === 'dark' ? 'from-indigo-300 via-cyan-300 to-emerald-300' : 'from-indigo-100 to-purple-200';

            return (
                <div className="flex flex-col min-h-screen pt-40 sm:pt-36 md:pt-44 pb-12 px-3 sm:px-4 relative z-10">
                    <div className="flex-1 flex flex-col items-center justify-center text-center space-y-6 sm:space-y-8 mb-16 sm:mb-20">
                        <h1 className="text-5xl sm:text-5xl md:text-6xl lg:text-8xl font-black text-white tracking-tighter drop-shadow-sm leading-tight max-w-5xl mx-auto opacity-0 animate-slide-up">
                            Solidify Your <br />
                            <span className={`text-transparent bg-clip-text bg-gradient-to-r ${heroGradient}`}>Vocabulary</span>
                        </h1>
                        <p className="text-base sm:text-lg md:text-xl lg:text-2xl text-white/90 max-w-3xl mx-auto font-light leading-relaxed opacity-0 animate-slide-up delay-200 px-2">
                            The simple way to master words, phrases, synonyms, and antonyms. Don't just learn new vocabularyâ€”keep it forever.
                        </p>
                        <div className="mt-6 sm:mt-8 opacity-0 animate-slide-up delay-300">
                            <button onClick={() => setActiveTab('dashboard')} className="group px-8 sm:px-10 md:px-12 py-4 sm:py-5 rounded-2xl font-bold text-base sm:text-lg md:text-xl bg-white text-indigo-900 shadow-xl hover:shadow-white/30 hover:scale-105 active:scale-95 transition-all flex items-center gap-2 sm:gap-3 relative overflow-hidden">
                                <span className="relative z-10">Start Learning Now</span>
                                <ArrowLeft className="w-4 h-4 sm:w-5 sm:h-5 rotate-180 relative z-10 group-hover:translate-x-1 transition-transform" />
                                <div className="absolute inset-0 bg-gradient-to-r from-white via-indigo-50 to-white opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                            </button>
                        </div>
                    </div>

                    {/* Key Features Section */}
                    <div className="max-w-7xl mx-auto w-full mb-16 sm:mb-20">
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 md:gap-8">
                            <div className={`${cardBgClass} p-6 sm:p-8 rounded-[1.5rem] sm:rounded-[2rem] hover:transform hover:-translate-y-2 transition-all duration-500 hover:shadow-2xl opacity-0 animate-slide-up delay-500`}>
                                <div className={`w-12 h-12 sm:w-14 sm:h-14 rounded-xl sm:rounded-2xl flex items-center justify-center mb-4 sm:mb-6 animate-float ${theme === 'dark' ? 'bg-indigo-500/20 text-indigo-300' : 'bg-indigo-100 text-indigo-600'}`}>
                                    <Book className="w-6 h-6 sm:w-8 sm:h-8" />
                                </div>
                                <h3 className={`text-xl sm:text-2xl font-bold mb-2 sm:mb-3 ${textColor}`}>Build Your Dictionary</h3>
                                <p className={`${subTextColor} leading-relaxed text-sm sm:text-base`}>Save every new word and phrase you encounter in one organized, beautiful place.</p>
                            </div>
                            <div className={`${cardBgClass} p-6 sm:p-8 rounded-[1.5rem] sm:rounded-[2rem] hover:transform hover:-translate-y-2 transition-all duration-500 hover:shadow-2xl opacity-0 animate-slide-up delay-700`}>
                                <div className={`w-12 h-12 sm:w-14 sm:h-14 rounded-xl sm:rounded-2xl flex items-center justify-center mb-4 sm:mb-6 animate-float-delayed ${theme === 'dark' ? 'bg-purple-500/20 text-purple-300' : 'bg-purple-100 text-purple-600'}`}>
                                    <LinkIcon className="w-6 h-6 sm:w-8 sm:h-8" />
                                </div>
                                <h3 className={`text-xl sm:text-2xl font-bold mb-2 sm:mb-3 ${textColor}`}>Connect the Dots</h3>
                                <p className={`${subTextColor} leading-relaxed text-sm sm:text-base`}>Link words to their synonyms and antonyms so you understand the exact meaning and nuance.</p>
                            </div>
                            <div className={`${cardBgClass} p-6 sm:p-8 rounded-[1.5rem] sm:rounded-[2rem] hover:transform hover:-translate-y-2 transition-all duration-500 hover:shadow-2xl opacity-0 animate-slide-up delay-1000 sm:col-span-2 lg:col-span-1`}>
                                <div className={`w-12 h-12 sm:w-14 sm:h-14 rounded-xl sm:rounded-2xl flex items-center justify-center mb-4 sm:mb-6 animate-float ${theme === 'dark' ? 'bg-emerald-500/20 text-emerald-300' : 'bg-emerald-100 text-emerald-600'}`}>
                                    <Brain className="w-6 h-6 sm:w-8 sm:h-8" />
                                </div>
                                <h3 className={`text-xl sm:text-2xl font-bold mb-2 sm:mb-3 ${textColor}`}>Test Your Memory</h3>
                                <p className={`${subTextColor} leading-relaxed text-sm sm:text-base`}>Use our built-in tools to practice and ensure you never forget what you have learned.</p>
                            </div>
                        </div>
                    </div>

                    {/* How It Works Section */}
                    <div className="max-w-5xl mx-auto w-full mb-16 sm:mb-20 text-center">
                        <h2 className="text-2xl sm:text-3xl md:text-4xl font-bold text-white mb-8 sm:mb-12 opacity-0 animate-slide-up delay-1000">How It Works</h2>
                        <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-6 md:gap-8">
                            <div className="bg-white/10 backdrop-blur-sm p-4 sm:p-6 rounded-2xl sm:rounded-3xl border border-white/10 opacity-0 animate-slide-up delay-[1100ms] hover:bg-white/20 transition-colors duration-300">
                                <div className="text-4xl sm:text-5xl font-black text-white/20 mb-3 sm:mb-4">01</div>
                                <h4 className="text-lg sm:text-xl font-bold text-white mb-2">Add</h4>
                                <p className="text-white/80 text-sm sm:text-base">Input a new word or phrase quickly.</p>
                            </div>
                            <div className="bg-white/10 backdrop-blur-sm p-4 sm:p-6 rounded-2xl sm:rounded-3xl border border-white/10 opacity-0 animate-slide-up delay-[1200ms] hover:bg-white/20 transition-colors duration-300">
                                <div className="text-4xl sm:text-5xl font-black text-white/20 mb-3 sm:mb-4">02</div>
                                <h4 className="text-lg sm:text-xl font-bold text-white mb-2">Refine</h4>
                                <p className="text-white/80 text-sm sm:text-base">Add details like definitions, synonyms, and antonyms.</p>
                            </div>
                            <div className="bg-white/10 backdrop-blur-sm p-4 sm:p-6 rounded-2xl sm:rounded-3xl border border-white/10 opacity-0 animate-slide-up delay-[1300ms] hover:bg-white/20 transition-colors duration-300">
                                <div className="text-4xl sm:text-5xl font-black text-white/20 mb-3 sm:mb-4">03</div>
                                <h4 className="text-lg sm:text-xl font-bold text-white mb-2">Solidify</h4>
                                <p className="text-white/80 text-sm sm:text-base">Practice regularly until it sticks.</p>
                            </div>
                        </div>
                    </div>

                    {/* Footer CTA */}
                    <div className="text-center py-8 sm:py-10 border-t border-white/10 opacity-0 animate-slide-up delay-[1400ms] px-2">
                        <h3 className="text-base sm:text-lg md:text-xl lg:text-2xl font-bold text-white mb-4 sm:mb-6"> "My words fly up, my thoughts remain below. Words without thoughts never to heaven go."</h3>
                        <p className="text-white/80 mb-4 sm:mb-6 text-sm sm:text-base">â€” William Shakespeare</p>
                    </div>
                </div>
            )
        }

        // Generic Container for all managers to handle Theme
        const ManagerContainer = ({ children, title, subtitle, theme, headerAction }) => {
            const containerClass = theme === 'dark' ? 'glass-panel-dark' : 'glass-panel-light';
            const titleColor = theme === 'dark' ? 'text-white' : 'text-slate-800';
            const subColor = theme === 'dark' ? 'text-gray-400' : 'text-slate-600';

            return (
                <div className={`${containerClass} p-8 rounded-[2rem] shadow-xl transition-all duration-500`}>
                    <div className="mb-8 flex items-start justify-between">
                        <div>
                            <h3 className={`text-3xl font-black ${titleColor} tracking-tight mb-2`}>{title}</h3>
                            <p className={`${subColor} font-medium`}>{subtitle}</p>
                        </div>
                        {headerAction && <div className="flex items-center gap-2">{headerAction}</div>}
                    </div>
                    {children}
                </div>
            );
        };

        // --- GAME MANAGER COMPONENT ---


        const GameManager = ({ user, onClose, items, theme }) => {
            const [view, setView] = useState('menu'); // menu, lobby, game, waiting, results
            const [gameId, setGameId] = useState('');
            const [players, setPlayers] = useState([]);
            const [currentQIndex, setCurrentQIndex] = useState(0); // Local state only
            const [questions, setQuestions] = useState([]);
            const [isHost, setIsHost] = useState(false);
            const [status, setStatus] = useState('waiting');
            const [inputCode, setInputCode] = useState('');
            const [selectedAnswer, setSelectedAnswer] = useState(null);
            const [lastAnswerCorrect, setLastAnswerCorrect] = useState(null);
            const [score, setScore] = useState(0);
            const [timeLeft, setTimeLeft] = useState(null);
            const [endTime, setEndTime] = useState(null);

            // Listen to Game State
            useEffect(() => {
                if (!gameId) return;
                const unsub = onSnapshot(doc(db, 'artifacts', appId, 'games', gameId), (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setStatus(data.status);
                        setQuestions(data.questions || []);
                        setPlayers(data.players || []);
                        if (data.endTime) setEndTime(data.endTime);

                        // Sync my score (in case of re-join or other device updates)
                        const myPlayer = data.players?.find(p => p.uid === user.uid);
                        if (myPlayer) setScore(myPlayer.score);

                        // Auto-advance to game if status changes to playing AND we are still in lobby
                        if (data.status === 'playing' && view === 'lobby') {
                            setView('game');
                            setCurrentQIndex(0);
                        }
                        // Auto-advance to results if game finished
                        if (data.status === 'finished') {
                            setView('results');
                        }
                    } else {
                        if (view !== 'menu') {
                            alert('Game ended or invalid code.');
                            onClose();
                        }
                    }
                });
                return () => unsub();
            }, [gameId, view, user.uid]);

            // Timer Logic
            useEffect(() => {
                if (status === 'playing' && endTime) {
                    const interval = setInterval(() => {
                        const now = Date.now();
                        const remaining = Math.max(0, Math.ceil((endTime - now) / 1000));
                        setTimeLeft(remaining);

                        if (remaining <= 0) {
                            clearInterval(interval);
                            // If timer hits 0, game over.
                            // Ideally Host triggers this update to DB, but clients should also react.
                            // We rely on the snapshot listener to switch view to 'results' when host updates DB.
                            if (isHost) {
                                updateDoc(doc(db, 'artifacts', appId, 'games', gameId), { status: 'finished' });
                            }
                        }
                    }, 1000);
                    return () => clearInterval(interval);
                }
            }, [status, endTime, isHost, gameId]);

            // Host checks for "All Finished" condition
            useEffect(() => {
                if (isHost && status === 'playing' && players.length > 0) {
                    const allFinished = players.every(p => p.finished);
                    if (allFinished) {
                        updateDoc(doc(db, 'artifacts', appId, 'games', gameId), { status: 'finished' });
                    }
                }
            }, [players, isHost, status, gameId]);


            const generateQuestions = () => {
                const pool = items.filter(i => i.mainText && i.type !== 'phrase');
                if (pool.length < 4) return [];

                const qList = [];
                for (let i = 0; i < 10; i++) {
                    const target = pool[Math.floor(Math.random() * pool.length)];
                    const wrongOptions = pool.filter(p => p.id !== target.id)
                        .sort(() => 0.5 - Math.random())
                        .slice(0, 3)
                        .map(p => p.mainText);
                    const options = [...wrongOptions, target.mainText].sort(() => 0.5 - Math.random());

                    let type = 'definition';
                    let text = `What matches this definition: "${target.context || 'Definition unavailable'}"?`;

                    if (target.type === 'synonym' && Math.random() > 0.5) {
                        type = 'synonym';
                        text = `Which word is a synonym for "${target.related?.[0] || '...'}"?`;
                    } else if (target.type === 'antonym' && Math.random() > 0.5) {
                        type = 'antonym';
                        text = `Which word is an antonym for "${target.related?.[0] || '...'}"?`;
                    }

                    qList.push({
                        id: Date.now() + i,
                        text,
                        correctAnswer: target.mainText,
                        options
                    });
                }
                return qList;
            };

            const handleHost = async () => {
                const code = Math.floor(1000 + Math.random() * 9000).toString();
                const newQuestions = generateQuestions();
                if (newQuestions.length === 0) {
                    alert("Not enough vocabulary items! Add at least 4 items.");
                    return;
                }

                await setDoc(doc(db, 'artifacts', appId, 'games', code), {
                    hostId: user.uid,
                    status: 'waiting',
                    players: [{ uid: user.uid, name: user.displayName || 'Host', score: 0, finished: false }],
                    questions: newQuestions,
                    timestamp: serverTimestamp()
                });
                setGameId(code);
                setIsHost(true);
                setView('lobby');
            };

            const handleJoin = async () => {
                if (inputCode.length !== 4) return;
                const gameRef = doc(db, 'artifacts', appId, 'games', inputCode);
                const docSnap = await getDoc(gameRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.status !== 'waiting') {
                        alert("Game already started or finished.");
                        return;
                    }
                    const currentPlayers = data.players || [];
                    if (!currentPlayers.find(p => p.uid === user.uid)) {
                        await updateDoc(gameRef, {
                            players: [...currentPlayers, { uid: user.uid, name: user.displayName || 'Guest', score: 0, finished: false }]
                        });
                    }
                    setGameId(inputCode);
                    setIsHost(data.hostId === user.uid);
                    setView('lobby');
                } else {
                    alert("Game not found!");
                }
            };

            const startGame = async () => {
                if (!isHost) return;
                const duration = 60 * 1000; // 60 seconds
                await updateDoc(doc(db, 'artifacts', appId, 'games', gameId), {
                    status: 'playing',
                    endTime: Date.now() + duration
                });
            };

            const submitAnswer = async (ans) => {
                if (selectedAnswer) return;
                setSelectedAnswer(ans);

                const currentQ = questions[currentQIndex];
                const isCorrect = ans === currentQ.correctAnswer;
                setLastAnswerCorrect(isCorrect);

                if (isCorrect) {
                    const newScore = score + 100;
                    setScore(newScore); // Optimistic

                    const gameRef = doc(db, 'artifacts', appId, 'games', gameId);
                    // Update score in DB
                    const freshSnap = await getDoc(gameRef);
                    if (freshSnap.exists()) {
                        const freshData = freshSnap.data();
                        const updatedPlayers = freshData.players.map(p =>
                            p.uid === user.uid ? { ...p, score: newScore } : p
                        );
                        await updateDoc(gameRef, { players: updatedPlayers });
                    }
                }
            };

            const nextQuestion = async () => {
                const nextIdx = currentQIndex + 1;

                if (nextIdx >= questions.length) {
                    // Player Finished!
                    setView('waiting');

                    // Mark as finished in DB
                    const gameRef = doc(db, 'artifacts', appId, 'games', gameId);
                    const freshSnap = await getDoc(gameRef);
                    if (freshSnap.exists()) {
                        const freshData = freshSnap.data();
                        const updatedPlayers = freshData.players.map(p =>
                            p.uid === user.uid ? { ...p, finished: true } : p
                        );
                        await updateDoc(gameRef, { players: updatedPlayers });
                    }
                } else {
                    // Next Question Local
                    setCurrentQIndex(nextIdx);
                    setSelectedAnswer(null);
                    setLastAnswerCorrect(null);
                }
            };

            const cardClass = theme === 'dark' ? 'bg-[#1e1e24] text-white border-white/10' : 'bg-white text-slate-800 border-slate-200';

            return (
                <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/80 backdrop-blur-md p-4 animate-in fade-in">
                    <div className={`${cardClass} w-full max-w-2xl rounded-2xl sm:rounded-3xl p-4 sm:p-8 shadow-2xl relative flex flex-col max-h-[90vh] overflow-hidden`}>
                        <button onClick={onClose} className="absolute top-4 right-4 opacity-50 hover:opacity-100 p-2 z-10"><X className="w-6 h-6" /></button>

                        {/* HEADER */}
                        <div className="text-center mb-6 flex-shrink-0 relative">
                            <div className="inline-flex p-3 rounded-2xl bg-gradient-to-br from-yellow-400 to-orange-500 text-white mb-3 shadow-lg">
                                <Trophy className="w-8 h-8" />
                            </div>
                            <h2 className="text-3xl font-black tracking-tight">Vocabulary Showdown</h2>
                            {timeLeft !== null && view === 'game' && (
                                <div className={`absolute top-0 right-0 sm:right-10 bg-slate-900 text-white px-3 py-1 rounded-full font-mono font-bold ${timeLeft < 10 ? 'bg-red-500 animate-pulse' : ''}`}>
                                    {Math.floor(timeLeft / 60)}:{(timeLeft % 60).toString().padStart(2, '0')}
                                </div>
                            )}
                        </div>

                        {/* COMMON SCROLL CONTAINER */}
                        <div className="flex-1 overflow-y-auto overflow-x-hidden custom-scrollbar -mx-2 px-2">

                            {/* VIEW: MENU */}
                            {view === 'menu' && (
                                <div className="min-h-full flex flex-col justify-center gap-6 py-4">
                                    <button onClick={handleHost} className="w-full py-4 sm:py-5 rounded-2xl bg-indigo-600 hover:bg-indigo-500 text-white font-bold text-lg sm:text-xl shadow-lg transition-transform hover:scale-[1.02] flex items-center justify-center gap-3">
                                        <Play className="w-6 h-6" /> Host Game
                                    </button>
                                    <div className="flex flex-col sm:flex-row gap-3">
                                        <input
                                            type="text"
                                            placeholder="Enter 4-digit Code"
                                            className={`flex-1 px-6 py-4 sm:py-0 rounded-2xl font-bold text-center tracking-widest text-xl outline-none focus:ring-2 ring-indigo-500 ${theme === 'dark' ? 'bg-white/5' : 'bg-slate-100'}`}
                                            maxLength={4}
                                            value={inputCode}
                                            onChange={e => setInputCode(e.target.value)}
                                        />
                                        <button onClick={handleJoin} className="px-8 py-5 rounded-2xl bg-emerald-500 hover:bg-emerald-400 text-white font-bold text-lg shadow-lg">
                                            Join
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* VIEW: LOBBY */}
                            {view === 'lobby' && (
                                <div className="min-h-full flex flex-col justify-center text-center space-y-6 py-4">
                                    <div className="bg-slate-900 text-white py-3 px-6 sm:py-4 sm:px-8 rounded-2xl inline-block mx-auto">
                                        <div className="text-xs sm:text-sm opacity-70 font-bold uppercase tracking-wider">Game Code</div>
                                        <div className="text-4xl sm:text-5xl font-black tracking-widest">{gameId}</div>
                                    </div>
                                    <div className="p-4 rounded-2xl bg-white/5 border border-white/10">
                                        <h3 className="font-bold mb-3 opacity-70">Players ({players.length})</h3>
                                        <div className="flex flex-wrap justify-center gap-2">
                                            {players.map(p => (
                                                <div key={p.uid} className="bg-indigo-500/20 text-indigo-400 px-3 py-1 rounded-full font-bold text-sm border border-indigo-500/30">
                                                    {p.name}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="pt-4">
                                        {isHost ? (
                                            <button onClick={startGame} className="w-full py-4 rounded-xl bg-green-500 hover:bg-green-400 text-white font-bold text-lg shadow-lg animate-pulse">
                                                Start Race (60s)
                                            </button>
                                        ) : (
                                            <div className="text-lg font-bold animate-pulse">Waiting for host to start...</div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* VIEW: GAME */}
                            {view === 'game' && questions[currentQIndex] && (
                                <div className="flex flex-col min-h-full py-2">
                                    <div className="flex justify-between items-center mb-6 text-sm font-bold opacity-70 bg-black/5 p-2 rounded-lg">
                                        <span>Q{currentQIndex + 1}/{questions.length}</span>
                                        <span className="text-indigo-500">Score: {score}</span>
                                    </div>

                                    <div className="flex-1 flex flex-col justify-center text-center">
                                        <h3 className="text-xl sm:text-3xl font-bold mb-6 sm:mb-8 leading-tight">
                                            {questions[currentQIndex].text}
                                        </h3>

                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 pb-4">
                                            {questions[currentQIndex].options.map((opt, idx) => {
                                                let btnClass = theme === 'dark' ? 'bg-white/5 hover:bg-white/10' : 'bg-slate-50 hover:bg-slate-100';
                                                if (selectedAnswer === opt) {
                                                    btnClass = opt === questions[currentQIndex].correctAnswer
                                                        ? 'bg-green-500 text-white ring-4 ring-green-500/30'
                                                        : 'bg-red-500 text-white ring-4 ring-red-500/30';
                                                } else if (selectedAnswer && opt === questions[currentQIndex].correctAnswer) {
                                                    btnClass = 'bg-green-500/50 text-white';
                                                }

                                                return (
                                                    <button
                                                        key={idx}
                                                        disabled={!!selectedAnswer}
                                                        onClick={() => submitAnswer(opt)}
                                                        className={`p-4 sm:p-6 rounded-2xl font-bold text-base sm:text-lg transition-all transform active:scale-95 text-left border-2 border-transparent ${btnClass}`}
                                                    >
                                                        {opt}
                                                    </button>
                                                );
                                            })}
                                        </div>
                                    </div>

                                    {/* Everyone has Next button now */}
                                    <div className="mt-4 pt-4 border-t border-white/10">
                                        <button
                                            onClick={nextQuestion}
                                            disabled={!selectedAnswer}
                                            className={`w-full py-3 rounded-xl font-bold flex items-center justify-center gap-2 ${selectedAnswer ? 'bg-slate-900 text-white hover:bg-slate-800' : 'bg-slate-200 text-slate-400 cursor-not-allowed'}`}
                                        >
                                            Next Question <ChevronRight className="w-4 h-4" />
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* VIEW: WAITING (Finished) */}
                            {view === 'waiting' && (
                                <div className="min-h-full flex flex-col items-center justify-center space-y-6 text-center">
                                    <div className="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center animate-bounce">
                                        <Check className="w-10 h-10" />
                                    </div>
                                    <div className="space-y-2">
                                        <h2 className="text-2xl font-black">All Done!</h2>
                                        <p className="opacity-70">Waiting for other players to finish...</p>
                                    </div>
                                    {timeLeft !== null && (
                                        <div className="text-4xl font-black font-mono">
                                            {Math.floor(timeLeft / 60)}:{(timeLeft % 60).toString().padStart(2, '0')}
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* VIEW: RESULTS */}
                            {view === 'results' && (
                                <div className="min-h-full flex flex-col items-center justify-center space-y-8 py-4 text-center">
                                    <Trophy className="w-20 h-20 text-yellow-400 animate-bounce" />
                                    <div className="space-y-2">
                                        <h2 className="text-3xl sm:text-4xl font-black">Time's Up!</h2>
                                        <p className="opacity-70 font-bold">Leaderboard</p>
                                    </div>

                                    <div className="w-full max-w-sm bg-black/10 rounded-2xl p-4 overflow-y-auto max-h-[40vh]">
                                        {players.sort((a, b) => b.score - a.score).map((p, i) => (
                                            <div key={p.uid} className={`flex justify-between items-center p-3 rounded-xl mb-2 ${p.uid === user.uid ? 'bg-indigo-500 text-white shadow-lg' : 'bg-white/5'}`}>
                                                <div className="flex items-center gap-3">
                                                    <span className={`font-black w-6 text-center ${i === 0 ? 'text-yellow-400 text-xl' : 'opacity-50'}`}>#{i + 1}</span>
                                                    <span className="font-bold">{p.name}</span>
                                                </div>
                                                <div className="text-right">
                                                    <div className="font-mono font-bold">{p.score}</div>
                                                    {p.finished && <div className="text-[10px] uppercase font-bold text-emerald-500">Done</div>}
                                                </div>
                                            </div>
                                        ))}
                                    </div>

                                    <button onClick={onClose} className="px-8 py-3 bg-white text-black font-bold rounded-full shadow-lg hover:scale-105 transition-transform">Close Game</button>
                                </div>
                            )}

                        </div>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ items, onReview, dueCount, onLoadDemo, isAdding, onFlashcards, theme, onStartGame }) => {
            const stats = useMemo(() => {
                const total = items.length;
                const mastered = items.filter(i => i.interval > 21).length;
                const learning = total - mastered;
                return { total, mastered, learning };
            }, [items]);

            const [showFlashcardModal, setShowFlashcardModal] = useState(false);
            const [showReviewModal, setShowReviewModal] = useState(false);
            const dueItems = items.filter(i => i.nextReview < Date.now());
            const vocaDue = dueItems.filter(i => i.type === 'voca').length;
            const synonymDue = dueItems.filter(i => i.type === 'synonym').length;
            const antonymDue = dueItems.filter(i => i.type === 'antonym').length;
            const phraseDue = dueItems.filter(i => i.type === 'phrase').length;

            const cardBg = theme === 'dark' ? 'glass-panel-dark' : 'glass-panel-light';
            const textColor = theme === 'dark' ? 'text-white' : 'text-slate-800';
            const subText = theme === 'dark' ? 'text-gray-400' : 'text-slate-500';

            return (
                <div className="space-y-6 sm:space-y-8 animate-in fade-in duration-500 pb-10 pt-32 sm:pt-36 md:pt-40 max-w-6xl mx-auto px-3 sm:px-4">
                    {/* Flashcard Modal */}
                    {showFlashcardModal && (
                        <div className="fixed inset-0 z-[150] flex items-center justify-center bg-black/60 backdrop-blur-md p-3 sm:p-4 animate-in fade-in zoom-in-95">
                            <div className={`${theme === 'dark' ? 'bg-[#0f172a] border-white/10' : 'bg-white'} border rounded-2xl sm:rounded-3xl p-6 sm:p-8 max-w-sm w-full shadow-2xl relative max-h-[90vh] overflow-y-auto`}>
                                <button onClick={() => setShowFlashcardModal(false)} className={`absolute top-4 right-4 ${theme === 'dark' ? 'text-gray-400 hover:text-white' : 'text-slate-400 hover:text-slate-600'}`}><X className="w-6 h-6" /></button>
                                <div className="text-center mb-6">
                                    <div className="w-16 h-16 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mx-auto mb-4"><Layers className="w-8 h-8" /></div>
                                    <h3 className={`text-2xl font-black ${theme === 'dark' ? 'text-white' : 'text-slate-800'}`}>Flashcard Practice</h3>
                                    <p className="text-slate-500 mt-2">Drill 20 random cards. No grading.</p>
                                </div>
                                <div className="space-y-2">
                                    <button onClick={() => { onFlashcards('voca'); setShowFlashcardModal(false); }} className="w-full bg-indigo-50 hover:bg-indigo-100 text-indigo-700 font-bold py-3 rounded-xl flex items-center justify-center gap-3 transition-colors border border-indigo-100"><Book className="w-5 h-5" /> Vocabulary</button>
                                    <button onClick={() => { onFlashcards('recieved'); setShowFlashcardModal(false); }} className="w-full bg-emerald-50 hover:bg-emerald-100 text-emerald-700 font-bold py-3 rounded-xl flex items-center justify-center gap-3 transition-colors border border-emerald-100"><Share2 className="w-5 h-5" /> Recieved Words</button>
                                    <button onClick={() => { onFlashcards('synonym'); setShowFlashcardModal(false); }} className="w-full bg-indigo-50 hover:bg-indigo-100 text-indigo-700 font-bold py-3 rounded-xl flex items-center justify-center gap-3 transition-colors border border-indigo-100"><LinkIcon className="w-5 h-5" /> Synonyms</button>
                                    <button onClick={() => { onFlashcards('antonym'); setShowFlashcardModal(false); }} className="w-full bg-rose-50 hover:bg-rose-100 text-rose-700 font-bold py-3 rounded-xl flex items-center justify-center gap-3 transition-colors border border-rose-100"><ArrowLeftRight className="w-5 h-5" /> Antonyms</button>
                                    <button onClick={() => { onFlashcards('phrase'); setShowFlashcardModal(false); }} className="w-full bg-indigo-50 hover:bg-indigo-100 text-indigo-700 font-bold py-3 rounded-xl flex items-center justify-center gap-3 transition-colors border border-indigo-100"><MessageCircle className="w-5 h-5" /> Phrases</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Review Modal */}
                    {showReviewModal && (
                        <div className="fixed inset-0 z-[150] flex items-center justify-center bg-black/60 backdrop-blur-md p-4 animate-in fade-in zoom-in-95">
                            <div className={`${theme === 'dark' ? 'bg-[#0f172a] border-white/10' : 'bg-white'} border rounded-3xl p-8 max-w-sm w-full shadow-2xl relative`}>
                                <button onClick={() => setShowReviewModal(false)} className={`absolute top-4 right-4 ${theme === 'dark' ? 'text-gray-400 hover:text-white' : 'text-slate-400 hover:text-slate-600'}`}><X className="w-6 h-6" /></button>
                                <div className="text-center mb-6">
                                    <div className="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4"><Repeat className="w-8 h-8" /></div>
                                    <h3 className={`text-2xl font-black ${theme === 'dark' ? 'text-white' : 'text-slate-800'}`}>Spaced Repetition</h3>
                                    <p className="text-slate-500 mt-2">Review due words and grade yourself.</p>
                                </div>
                                <div className="space-y-3">
                                    <button onClick={() => { onReview('all'); setShowReviewModal(false); }} className="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-4 rounded-xl flex items-center justify-center gap-3 transition-colors border border-slate-200"><Brain className="w-5 h-5" /> Review All ({dueItems.length})</button>
                                    <div className="grid grid-cols-2 gap-2">
                                        <button onClick={() => { onReview('voca'); setShowReviewModal(false); }} disabled={vocaDue === 0} className="bg-indigo-50 hover:bg-indigo-100 text-indigo-700 font-bold py-3 rounded-xl flex flex-col items-center justify-center gap-1 transition-colors border border-indigo-100 disabled:opacity-50"><Book className="w-4 h-4" /> <span className="text-xs">Vocab({vocaDue})</span></button>
                                        <button onClick={() => { onReview('synonym'); setShowReviewModal(false); }} disabled={synonymDue === 0} className="bg-indigo-50 hover:bg-indigo-100 text-indigo-700 font-bold py-3 rounded-xl flex flex-col items-center justify-center gap-1 transition-colors border border-indigo-100 disabled:opacity-50"><LinkIcon className="w-4 h-4" /> <span className="text-xs">Syn ({synonymDue})</span></button>
                                        <button onClick={() => { onReview('antonym'); setShowReviewModal(false); }} disabled={antonymDue === 0} className="bg-rose-50 hover:bg-rose-100 text-rose-700 font-bold py-3 rounded-xl flex flex-col items-center justify-center gap-1 transition-colors border border-rose-100 disabled:opacity-50"><ArrowLeftRight className="w-4 h-4" /> <span className="text-xs">Ant ({antonymDue})</span></button>
                                        <button onClick={() => { onReview('phrase'); setShowReviewModal(false); }} disabled={phraseDue === 0} className="bg-indigo-50 hover:bg-indigo-100 text-indigo-700 font-bold py-3 rounded-xl flex flex-col items-center justify-center gap-1 transition-colors border border-indigo-100 disabled:opacity-50"><MessageCircle className="w-4 h-4" /> <span className="text-xs">Phr ({phraseDue})</span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Welcome Banner */}
                    <div className="relative overflow-hidden bg-gradient-to-br from-violet-600 via-indigo-600 to-blue-600 rounded-[1.5rem] sm:rounded-[2rem] md:rounded-[2.5rem] p-5 sm:p-7 md:p-10 text-white shadow-2xl">
                        <div className="absolute top-0 right-0 -mt-10 -mr-10 w-40 sm:w-60 h-40 sm:h-60 bg-white/10 rounded-full blur-3xl"></div>
                        <div className="absolute bottom-0 left-0 -mb-10 -ml-10 w-40 sm:w-60 h-40 sm:h-60 bg-purple-500/20 rounded-full blur-3xl"></div>
                        <div className="relative z-10">
                            <h2 className="text-2xl sm:text-3xl md:text-4xl font-bold mb-2 sm:mb-3 tracking-tight">Welcome back!</h2>
                            <p className="opacity-90 mb-5 sm:mb-8 text-indigo-100 text-sm sm:text-base md:text-lg max-w-lg">You have <span className="font-bold text-white bg-white/20 px-2 sm:px-3 py-0.5 sm:py-1 rounded-lg backdrop-blur-sm">{dueCount} cards</span> waiting for review.</p>
                            <div className="flex flex-col sm:flex-row flex-wrap gap-2 sm:gap-3 md:gap-4">
                                <button onClick={() => setShowReviewModal(true)} disabled={dueCount === 0} className={`flex items-center justify-center gap-2 px-5 sm:px-6 md:px-8 py-3 sm:py-3.5 md:py-4 rounded-xl sm:rounded-2xl font-bold text-sm sm:text-base transition-all shadow-lg transform active:scale-95 ${dueCount > 0 ? 'bg-white text-indigo-600 hover:bg-indigo-50 cursor-pointer' : 'bg-black/20 text-white/50 cursor-not-allowed'}`}><Repeat className="w-4 h-4 sm:w-5 sm:h-5" /> {dueCount > 0 ? 'Start Review Session' : 'All Caught Up!'}</button>
                                <button onClick={() => setShowFlashcardModal(true)} className="flex items-center justify-center gap-2 px-5 sm:px-6 md:px-8 py-3 sm:py-3.5 md:py-4 rounded-xl sm:rounded-2xl font-bold text-sm sm:text-base bg-white/10 text-white hover:bg-white/20 border border-white/20 transition-all shadow-lg backdrop-blur-sm"><Layers className="w-4 h-4 sm:w-5 sm:h-5" /> Flashcards</button>
                                <button onClick={onStartGame} className="flex items-center justify-center gap-2 px-5 sm:px-6 md:px-8 py-3 sm:py-3.5 md:py-4 rounded-xl sm:rounded-2xl font-bold text-sm sm:text-base bg-gradient-to-r from-yellow-400 to-orange-500 text-white hover:opacity-90 border border-white/20 transition-all shadow-lg hover:scale-105 active:scale-95"><Trophy className="w-4 h-4 sm:w-5 sm:h-5" /> Play Game</button>
                                {items.length === 0 && (
                                    <button onClick={onLoadDemo} disabled={isAdding} className="flex items-center justify-center gap-2 px-4 sm:px-6 py-3 sm:py-4 rounded-xl sm:rounded-2xl font-bold text-sm sm:text-base bg-indigo-500/30 text-white hover:bg-indigo-500/40 border border-white/20 transition-all disabled:opacity-50">{isAdding ? <Loader2 className="w-4 h-4 sm:w-5 sm:h-5 animate-spin" /> : <Sparkles className="w-4 h-4 sm:w-5 sm:h-5" />} Load Example Data</button>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4 md:gap-6">
                        <div className={`${cardBg} p-4 sm:p-5 md:p-6 rounded-[1.5rem] sm:rounded-[2rem] flex items-center gap-3 sm:gap-4 md:gap-5 shadow-lg`}>
                            <div className="bg-blue-500/10 p-3 sm:p-4 rounded-xl sm:rounded-2xl"><Layers className="w-6 h-6 sm:w-7 sm:h-7 md:w-8 md:h-8 text-blue-500" /></div>
                            <div><div className={`text-2xl sm:text-3xl md:text-4xl font-black ${textColor}`}>{stats.total}</div><div className={`text-xs sm:text-sm font-bold uppercase tracking-wider ${subText}`}>Total Items</div></div>
                        </div>
                        <div className={`${cardBg} p-4 sm:p-5 md:p-6 rounded-[1.5rem] sm:rounded-[2rem] flex items-center gap-3 sm:gap-4 md:gap-5 shadow-lg`}>
                            <div className="bg-green-500/10 p-3 sm:p-4 rounded-xl sm:rounded-2xl"><Check className="w-6 h-6 sm:w-7 sm:h-7 md:w-8 md:h-8 text-green-500" /></div>
                            <div><div className={`text-2xl sm:text-3xl md:text-4xl font-black ${textColor}`}>{stats.mastered}</div><div className={`text-xs sm:text-sm font-bold uppercase tracking-wider ${subText}`}>Mastered</div></div>
                        </div>
                        <div className={`${cardBg} p-4 sm:p-5 md:p-6 rounded-[1.5rem] sm:rounded-[2rem] flex items-center gap-3 sm:gap-4 md:gap-5 shadow-lg`}>
                            <div className="bg-amber-500/10 p-3 sm:p-4 rounded-xl sm:rounded-2xl"><Zap className="w-6 h-6 sm:w-7 sm:h-7 md:w-8 md:h-8 text-amber-500" /></div>
                            <div><div className={`text-2xl sm:text-3xl md:text-4xl font-black ${textColor}`}>{stats.learning}</div><div className={`text-xs sm:text-sm font-bold uppercase tracking-wider ${subText}`}>Learning</div></div>
                        </div>
                    </div>

                    <div className={`${cardBg} p-5 sm:p-6 md:p-8 rounded-[1.5rem] sm:rounded-[2rem] md:rounded-[2.5rem] shadow-xl border ${theme === 'dark' ? 'border-white/5' : 'border-white/50'}`}>
                        <div className="flex items-center justify-between mb-5 sm:mb-6 md:mb-8"><h3 className={`font-bold text-lg sm:text-xl md:text-2xl ${textColor} flex items-center gap-2 sm:gap-3`}><Clock className="w-5 h-5 sm:w-6 sm:h-6 text-indigo-500" /> Recently Added</h3><span className={`text-[10px] sm:text-xs font-bold ${subText} uppercase tracking-widest hidden sm:inline`}>Status</span></div>
                        <div className="space-y-3 sm:space-y-4">
                            {items.slice(0, 5).map(item => (
                                <div key={item.id} className={`group flex items-center justify-between p-3 sm:p-4 md:p-5 rounded-xl sm:rounded-2xl border border-transparent transition-all cursor-default ${theme === 'dark' ? 'hover:bg-white/5 hover:border-white/10' : 'hover:bg-slate-50 hover:border-slate-200'}`}>
                                    <div className="flex items-center gap-3 sm:gap-4 md:gap-5 min-w-0 flex-1">
                                        <div className={`w-1.5 sm:w-2 h-10 sm:h-12 rounded-full shrink-0 ${item.type === 'synonym' ? 'bg-indigo-400' : item.type === 'antonym' ? 'bg-rose-400' : item.type === 'voca' ? 'bg-indigo-400' : 'bg-indigo-400'}`}></div>
                                        <div className="min-w-0">
                                            <div className={`font-bold text-base sm:text-lg ${textColor} truncate`}>{item.mainText}</div>
                                            <div className={`text-[10px] sm:text-xs font-bold uppercase tracking-wide flex gap-1 sm:gap-2 ${subText}`}>{item.type} {item.context && <span className="text-indigo-500 truncate">â€¢ {item.context}</span>}</div>
                                        </div>
                                    </div>
                                    <div className="text-right shrink-0 ml-2"><div className={`text-xs sm:text-sm font-bold ${item.nextReview < Date.now() ? 'text-rose-500' : 'text-emerald-500'}`}>{getRelativeTime(item.nextReview)}</div><div className={`text-[10px] sm:text-xs font-bold ${subText} hidden sm:block`}>Next Review</div></div>
                                </div>
                            ))}
                            {items.length === 0 && (<div className={`text-center py-8 sm:py-12 rounded-2xl sm:rounded-3xl border border-dashed ${theme === 'dark' ? 'border-slate-700 text-slate-500' : 'border-slate-200 text-slate-400'}`}><p className="text-sm sm:text-base">Your mind palace is empty.</p><p className="text-xs sm:text-sm mt-2">Add items or click "Load Example Data" above.</p></div>)}
                        </div>
                    </div>
                </div>
            );
        };

        const VocaManager = ({ items, onAdd, onDelete, onDeleteAll, onUpdate, theme }) => {
            const [formData, setFormData] = useState({ word: '', pos: 'noun', ipa: '', definition: '', example: '', collocations: '' });
            const [isFetchingIPA, setIsFetchingIPA] = useState(false);
            const [isFetchingExample, setIsFetchingExample] = useState(false);
            const [isFetchingCollo, setIsFetchingCollo] = useState(false);
            const [isUploading, setIsUploading] = useState(false);
            const [uploadProgress, setUploadProgress] = useState({ current: 0, total: 0 });
            const [editingItem, setEditingItem] = useState(null);
            const [editFormData, setEditFormData] = useState({ word: '', pos: 'noun', ipa: '', definition: '', example: '', collocations: '' });
            const fileInputRef = useRef(null);

            const openEditModal = (item) => {
                setEditingItem(item);
                setEditFormData({
                    word: item.mainText || '',
                    pos: item.pos || 'noun',
                    ipa: item.ipa || '',
                    definition: item.context || '',
                    example: item.example || '',
                    collocations: item.collocations || ''
                });
            };

            const handleEditChange = (e) => { const { name, value } = e.target; setEditFormData(prev => ({ ...prev, [name]: value })); };

            const handleEditSubmit = (e) => {
                e.preventDefault();
                if (!editFormData.word.trim() || !editingItem) return;
                onUpdate(editingItem.id, {
                    mainText: editFormData.word,
                    context: editFormData.definition,
                    pos: editFormData.pos,
                    ipa: editFormData.ipa,
                    example: editFormData.example,
                    collocations: editFormData.collocations
                });
                setEditingItem(null);
            };

            const generateWordDataWithAI = async (word) => {
                try {
                    const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyDHD8AhAFmlH9Cr06dBGTS9Lpvqvs9jNtM', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: `Analyze the English word "${word}" and provide the following information in JSON format only (no markdown, no code blocks, just raw JSON):
{
  "pos": "part of speech (noun, verb, adjective, adverb, or idiom)",
  "ipa": "IPA pronunciation notation",
  "definition": "clear and concise definition (1-2 sentences)",
  "example": "example sentence using the word",
  "collocations": "3-5 common word pairings separated by commas"
}
Respond with ONLY the JSON object, nothing else.`
                                }]
                            }]
                        })
                    });
                    const data = await response.json();
                    const text = data?.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
                    const cleanJson = text.replace(/```json\n?|```\n?/g, '').trim();
                    return JSON.parse(cleanJson);
                } catch (error) {
                    console.error('AI word analysis failed:', error);
                    return { pos: 'noun', ipa: '', definition: 'Definition not available', example: '', collocations: '' };
                }
            };

            const generateIPAWithAI = async (word) => {
                // First try the free dictionary API
                try {
                    const dictResponse = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`);
                    if (dictResponse.ok) {
                        const dictData = await dictResponse.json();
                        if (Array.isArray(dictData) && dictData.length > 0) {
                            const entry = dictData[0];
                            let foundIPA = entry.phonetic;
                            if (!foundIPA && entry.phonetics?.length > 0) {
                                foundIPA = entry.phonetics.find(p => p.text)?.text;
                            }
                            if (foundIPA) return foundIPA;
                        }
                    }
                } catch (dictError) {
                    console.log('Dictionary API failed, trying AI:', dictError);
                }

                // Fallback to AI for IPA generation
                try {
                    const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyDHD8AhAFmlH9Cr06dBGTS9Lpvqvs9jNtM', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: `Give me ONLY the IPA phonetic transcription for the English word "${word}". Return ONLY the IPA symbols inside slashes like /stÊŒnt/. No explanation, no other text.`
                                }]
                            }]
                        })
                    });
                    const data = await response.json();
                    const ipaText = data?.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || '';
                    // Clean up any extra text, keep only the IPA in slashes
                    const ipaMatch = ipaText.match(/\/[^\/]+\//);
                    return ipaMatch ? ipaMatch[0] : ipaText;
                } catch (error) {
                    console.error('AI IPA generation failed:', error);
                    return '';
                }
            };

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsUploading(true);

                try {
                    const content = await file.text();
                    // Split by blank lines to separate word entries
                    const entries = content.split(/\n\s*\n/).map(entry => entry.trim()).filter(entry => entry !== '');
                    setUploadProgress({ current: 0, total: entries.length });

                    for (let i = 0; i < entries.length; i++) {
                        const entry = entries[i];
                        const lines = entry.split(/[\n\r]+/).map(line => line.trim()).filter(line => line !== '');

                        if (lines.length >= 1) {
                            // Parse first line: "word [pos]"
                            const firstLineMatch = lines[0].match(/^(.+?)\s*\[(.+?)\]\s*$/);
                            if (firstLineMatch) {
                                const word = firstLineMatch[1].trim();
                                const pos = firstLineMatch[2].trim().toLowerCase();

                                // Parse Definition line
                                let definition = '';
                                const defLine = lines.find(l => l.toLowerCase().startsWith('definition:'));
                                if (defLine) {
                                    definition = defLine.replace(/^definition:\s*/i, '').trim();
                                }

                                // Parse Sentence line
                                let example = '';
                                const sentLine = lines.find(l => l.toLowerCase().startsWith('sentence:'));
                                if (sentLine) {
                                    example = sentLine.replace(/^sentence:\s*/i, '').trim();
                                }

                                // Generate IPA pronunciation using AI
                                const ipa = await generateIPAWithAI(word);

                                onAdd({
                                    type: 'voca',
                                    mainText: word,
                                    context: definition,
                                    pos: pos,
                                    ipa: ipa,
                                    example: example,
                                    collocations: '',
                                    easiness: 2.5,
                                    interval: 0,
                                    nextReview: Date.now()
                                });
                            }
                        }
                        setUploadProgress({ current: i + 1, total: entries.length });
                    }
                } catch (error) {
                    console.error('File parsing error:', error);
                }

                setIsUploading(false);
                setUploadProgress({ current: 0, total: 0 });
                e.target.value = '';
            };

            const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value })); };
            const handleSubmit = (e) => { e.preventDefault(); if (!formData.word.trim()) return; onAdd({ type: 'voca', mainText: formData.word, context: formData.definition, pos: formData.pos, ipa: formData.ipa, example: formData.example, collocations: formData.collocations, easiness: 2.5, interval: 0, nextReview: Date.now() }); setFormData({ word: '', pos: 'noun', ipa: '', definition: '', example: '', collocations: '' }); };

            // AI Handlers
            const handleAutoData = async (fieldToUpdate) => {
                if (!formData.word) return;
                if (fieldToUpdate === 'ipa') setIsFetchingIPA(true);
                if (fieldToUpdate === 'example') setIsFetchingExample(true);
                try {
                    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${formData.word}`);
                    const data = await res.json();
                    if (Array.isArray(data) && data.length > 0) {
                        const entry = data[0];
                        if (fieldToUpdate === 'ipa') {
                            let foundIPA = entry.phonetic;
                            if (!foundIPA && entry.phonetics?.length > 0) foundIPA = entry.phonetics.find(p => p.text)?.text;
                            if (foundIPA) setFormData(prev => ({ ...prev, ipa: foundIPA }));
                            if (!formData.definition && entry.meanings?.[0]?.definitions?.[0]?.definition) {
                                setFormData(prev => ({ ...prev, definition: entry.meanings[0].definitions[0].definition }));
                            }
                        }
                        if (fieldToUpdate === 'example') {
                            let foundExample = '';
                            for (const meaning of entry.meanings) {
                                for (const def of meaning.definitions) {
                                    if (def.example) { foundExample = def.example; break; }
                                }
                                if (foundExample) break;
                            }
                            if (foundExample) setFormData(prev => ({ ...prev, example: foundExample }));
                        }
                    }
                } catch (e) { console.error(e); }
                setIsFetchingIPA(false);
                setIsFetchingExample(false);
            };

            const handleAutoCollocations = async () => {
                if (!formData.word) return;
                setIsFetchingCollo(true);
                try {
                    const res = await fetch(`https://api.datamuse.com/words?rel_jja=${formData.word}&max=5`);
                    let data = await res.json();
                    if (data.length === 0) {
                        const res2 = await fetch(`https://api.datamuse.com/words?rel_trg=${formData.word}&max=5`);
                        data = await res2.json();
                    }
                    if (data.length > 0) {
                        const words = data.map(item => item.word).join(', ');
                        setFormData(prev => ({ ...prev, collocations: words }));
                    }
                } catch (e) { console.error(e); }
                setIsFetchingCollo(false);
            };

            const vocaItems = items.filter(i => i.type === 'voca');
            const inputClass = theme === 'dark'
                ? 'bg-slate-950/50 border border-slate-700 text-slate-100 placeholder:text-slate-500 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/50 shadow-inner backdrop-blur-sm'
                : 'bg-white border border-slate-200 text-slate-800 placeholder:text-slate-400 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/50 shadow-sm';

            const labelClass = theme === 'dark' ? 'text-slate-400 font-bold' : 'text-slate-500 font-bold';

            return (
                <div className="space-y-8 sm:space-y-12 animate-in slide-in-from-right-4 duration-500 pt-32 sm:pt-36 md:pt-40 pb-12 max-w-6xl mx-auto px-3 sm:px-4">
                    <ManagerContainer title="New Entry" subtitle="Add a new word to your collection." theme={theme}>
                        <form onSubmit={handleSubmit} className="space-y-4 sm:space-y-6">
                            <div className="grid sm:grid-cols-3 gap-4 sm:gap-6">
                                <div className="sm:col-span-2 space-y-2">
                                    <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Word</label>
                                    <div className="relative"><input name="word" value={formData.word} onChange={handleChange} placeholder="e.g. Serendipity" className={`w-full p-3 sm:p-4 rounded-xl sm:rounded-2xl outline-none font-bold transition-all pr-10 sm:pr-12 text-sm sm:text-base ${inputClass}`} /><Volume2 className="absolute right-3 sm:right-4 top-3 sm:top-4 w-4 h-4 sm:w-5 sm:h-5 text-indigo-500 opacity-50" /></div>
                                </div>
                                <div className="space-y-2">
                                    <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Type</label>
                                    <select name="pos" value={formData.pos} onChange={handleChange} className={`w-full p-3 sm:p-4 rounded-xl sm:rounded-2xl outline-none font-bold transition-all appearance-none cursor-pointer text-sm sm:text-base ${inputClass}`}><option value="noun">Noun</option><option value="verb">Verb</option><option value="adjective">Adjective</option><option value="adverb">Adverb</option><option value="idiom">Idiom</option></select>
                                </div>
                            </div>

                            {/* Row 2: IPA and Collocations */}
                            <div className="grid sm:grid-cols-2 gap-4 sm:gap-6">
                                <div className="space-y-2">
                                    <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>IPA (Pronunciation)</label>
                                    <div className="relative">
                                        <input name="ipa" value={formData.ipa} onChange={handleChange} placeholder="/.../" className={`w-full p-3 sm:p-4 rounded-xl sm:rounded-2xl outline-none font-mono text-sm transition-all pr-10 sm:pr-12 ${inputClass}`} />
                                        <button type="button" onClick={() => handleAutoData('ipa')} disabled={isFetchingIPA} className="absolute right-1.5 sm:right-2 top-1.5 sm:top-2 p-1.5 sm:p-2 bg-indigo-500/10 text-indigo-500 rounded-lg sm:rounded-xl hover:bg-indigo-500/20 transition-colors" title="Auto-Detect IPA">
                                            {isFetchingIPA ? <Loader2 className="w-3.5 h-3.5 sm:w-4 sm:h-4 animate-spin" /> : <Wand2 className="w-3.5 h-3.5 sm:w-4 sm:h-4" />}
                                        </button>
                                    </div>
                                </div>
                                <div className="space-y-2">
                                    <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Collocations</label>
                                    <div className="relative">
                                        <input name="collocations" value={formData.collocations} onChange={handleChange} placeholder="strong coffee, heavy rain..." className={`w-full p-3 sm:p-4 rounded-xl sm:rounded-2xl outline-none font-medium transition-all pr-10 sm:pr-12 text-sm sm:text-base ${inputClass}`} />
                                        <button type="button" onClick={handleAutoCollocations} disabled={isFetchingCollo} className="absolute right-1.5 sm:right-2 top-1.5 sm:top-2 p-1.5 sm:p-2 bg-indigo-500/10 text-indigo-500 rounded-lg sm:rounded-xl hover:bg-indigo-500/20 transition-colors" title="Find Collocations">
                                            {isFetchingCollo ? <Loader2 className="w-3.5 h-3.5 sm:w-4 sm:h-4 animate-spin" /> : <Wand2 className="w-3.5 h-3.5 sm:w-4 sm:h-4" />}
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div className="space-y-2"><label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Definition</label><textarea name="definition" value={formData.definition} onChange={handleChange} rows="2" placeholder="What does it mean?" className={`w-full p-3 sm:p-4 rounded-xl sm:rounded-2xl outline-none font-medium resize-none transition-all text-sm sm:text-base ${inputClass}`} /></div>

                            {/* Row 4: Example Sentence */}
                            <div className="space-y-2">
                                <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Example Sentence</label>
                                <div className="relative">
                                    <textarea name="example" value={formData.example} onChange={handleChange} rows="2" placeholder="Use it in a sentence..." className={`w-full p-3 sm:p-4 rounded-xl sm:rounded-2xl outline-none font-medium resize-none transition-all pr-10 sm:pr-12 text-sm sm:text-base ${inputClass}`} />
                                    <button type="button" onClick={() => handleAutoData('example')} disabled={isFetchingExample} className="absolute right-2 sm:right-3 top-2 sm:top-3 p-1.5 sm:p-2 bg-indigo-500/10 text-indigo-500 rounded-lg sm:rounded-xl hover:bg-indigo-500/20 transition-colors" title="Generate Example">
                                        {isFetchingExample ? <Loader2 className="w-3.5 h-3.5 sm:w-4 sm:h-4 animate-spin" /> : <Wand2 className="w-3.5 h-3.5 sm:w-4 sm:h-4" />}
                                    </button>
                                </div>
                            </div>

                            <div className="flex justify-end"><button type="submit" className="bg-slate-900 text-white px-6 sm:px-10 py-3 sm:py-4 rounded-xl sm:rounded-2xl font-bold text-sm sm:text-base hover:bg-slate-800 transition-all shadow-lg hover:shadow-xl active:scale-95 flex items-center gap-2"><Plus className="w-4 h-4 sm:w-5 sm:h-5" /> Add Card</button></div>
                        </form>
                    </ManagerContainer>
                    <ManagerContainer title="Vocabulary" subtitle={`${vocaItems.length} items`} theme={theme} headerAction={
                        <div className="flex items-center gap-1.5 sm:gap-2">
                            <input type="file" accept=".txt" ref={fileInputRef} onChange={handleFileUpload} className="hidden" disabled={isUploading} />
                            {isUploading ? (
                                <div className={`flex items-center gap-1.5 sm:gap-2 px-2 sm:px-3 py-1.5 sm:py-2 rounded-lg sm:rounded-xl ${theme === 'dark' ? 'bg-indigo-500/20 text-indigo-400' : 'bg-indigo-100 text-indigo-600'}`}>
                                    <Loader2 className="w-3.5 h-3.5 sm:w-4 sm:h-4 animate-spin" />
                                    <span className="text-[10px] sm:text-xs font-bold">{uploadProgress.current}/{uploadProgress.total}</span>
                                </div>
                            ) : (
                                <>
                                    <button onClick={() => fileInputRef.current?.click()} title="Upload words from TXT file" className={`p-1.5 sm:p-2 rounded-lg sm:rounded-xl transition-all hover:scale-105 active:scale-95 ${theme === 'dark' ? 'bg-indigo-500/20 text-indigo-400 hover:bg-indigo-500/30' : 'bg-indigo-100 text-indigo-600 hover:bg-indigo-200'}`}>
                                        <Upload className="w-4 h-4 sm:w-5 sm:h-5" />
                                    </button>
                                    {vocaItems.length > 0 && (
                                        <button onClick={() => onDeleteAll('voca')} title="Delete all vocabulary items" className={`p-1.5 sm:p-2 rounded-lg sm:rounded-xl transition-all hover:scale-105 active:scale-95 ${theme === 'dark' ? 'bg-red-500/20 text-red-400 hover:bg-red-500/30' : 'bg-red-100 text-red-600 hover:bg-red-200'}`}>
                                            <Trash2 className="w-4 h-4 sm:w-5 sm:h-5" />
                                        </button>
                                    )}
                                </>
                            )}
                        </div>
                    }>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-5">
                            {vocaItems.map(item => (<ItemCard key={item.id} type="voca" title={item.mainText} theme={theme} subtitle={<span><span className="font-bold text-indigo-500 uppercase text-[10px] tracking-wider mr-2 bg-indigo-500/10 px-1.5 py-0.5 rounded">{item.pos}</span>{item.context || "No definition"}</span>} icon={Book} onDelete={() => onDelete(item.id)} onEdit={() => openEditModal(item)} interval={item.interval} sharedBy={item.sharedBy} />))}
                        </div>
                    </ManagerContainer>

                    {/* Edit Modal for Vocabulary */}
                    {editingItem && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-3 sm:p-4" onClick={() => setEditingItem(null)}>
                            <div className={`${theme === 'dark' ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'} p-5 sm:p-6 md:p-8 rounded-2xl sm:rounded-3xl max-w-2xl w-full shadow-2xl border animate-in zoom-in-95 max-h-[90vh] overflow-y-auto`} onClick={e => e.stopPropagation()}>
                                <h3 className={`text-xl sm:text-2xl font-black mb-4 sm:mb-6 ${theme === 'dark' ? 'text-white' : 'text-slate-800'}`}>Edit Vocabulary</h3>
                                <form onSubmit={handleEditSubmit} className="space-y-4 sm:space-y-5">
                                    <div className="grid sm:grid-cols-2 gap-3 sm:gap-4">
                                        <div className="space-y-2">
                                            <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Word</label>
                                            <input name="word" value={editFormData.word} onChange={handleEditChange} className={`w-full p-3 sm:p-4 rounded-xl sm:rounded-2xl outline-none font-bold transition-all text-sm sm:text-base ${inputClass}`} />
                                        </div>
                                        <div className="space-y-2">
                                            <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Type</label>
                                            <select name="pos" value={editFormData.pos} onChange={handleEditChange} className={`w-full p-3 sm:p-4 rounded-xl sm:rounded-2xl outline-none font-bold transition-all appearance-none cursor-pointer text-sm sm:text-base ${inputClass}`}>
                                                <option value="noun">Noun</option><option value="verb">Verb</option><option value="adjective">Adjective</option><option value="adverb">Adverb</option><option value="idiom">Idiom</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div className="grid sm:grid-cols-2 gap-3 sm:gap-4">
                                        <div className="space-y-2">
                                            <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>IPA (Pronunciation)</label>
                                            <input name="ipa" value={editFormData.ipa} onChange={handleEditChange} className={`w-full p-3 sm:p-4 rounded-xl sm:rounded-2xl outline-none font-mono text-sm transition-all ${inputClass}`} />
                                        </div>
                                        <div className="space-y-2">
                                            <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Collocations</label>
                                            <input name="collocations" value={editFormData.collocations} onChange={handleEditChange} className={`w-full p-3 sm:p-4 rounded-xl sm:rounded-2xl outline-none font-medium transition-all text-sm sm:text-base ${inputClass}`} />
                                        </div>
                                    </div>
                                    <div className="space-y-2">
                                        <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Definition</label>
                                        <textarea name="definition" value={editFormData.definition} onChange={handleEditChange} rows="2" className={`w-full p-3 sm:p-4 rounded-xl sm:rounded-2xl outline-none font-medium resize-none transition-all text-sm sm:text-base ${inputClass}`} />
                                    </div>
                                    <div className="space-y-2">
                                        <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Example Sentence</label>
                                        <textarea name="example" value={editFormData.example} onChange={handleEditChange} rows="2" className={`w-full p-3 sm:p-4 rounded-xl sm:rounded-2xl outline-none font-medium resize-none transition-all text-sm sm:text-base ${inputClass}`} />
                                    </div>
                                    <div className="flex justify-end gap-2 sm:gap-3 pt-2">
                                        <button type="button" onClick={() => setEditingItem(null)} className={`px-4 sm:px-6 py-2.5 sm:py-3 rounded-lg sm:rounded-xl font-bold text-sm sm:text-base transition-all ${theme === 'dark' ? 'bg-slate-700 text-slate-300 hover:bg-slate-600' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>Cancel</button>
                                        <button type="submit" className="bg-indigo-600 text-white px-4 sm:px-6 py-2.5 sm:py-3 rounded-lg sm:rounded-xl font-bold text-sm sm:text-base hover:bg-indigo-700 transition-all flex items-center gap-2"><Save className="w-4 h-4" /> Save Changes</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const SynonymManager = ({ items, onAdd, onDelete, onDeleteAll, onUpdate, theme }) => {
            const [word, setWord] = useState('');
            const [synonyms, setSynonyms] = useState('');
            const [isUploading, setIsUploading] = useState(false);
            const [uploadProgress, setUploadProgress] = useState({ current: 0, total: 0 });
            const [editingItem, setEditingItem] = useState(null);
            const [editWord, setEditWord] = useState('');
            const [editSynonyms, setEditSynonyms] = useState('');
            const fileInputRef = useRef(null);

            const openEditModal = (item) => {
                setEditingItem(item);
                setEditWord(item.mainText || '');
                setEditSynonyms(item.related?.join(', ') || '');
            };

            const handleEditSubmit = (e) => {
                e.preventDefault();
                if (!editWord.trim() || !editingItem) return;
                const synList = editSynonyms.split(',').map(s => s.trim()).filter(s => s);
                onUpdate(editingItem.id, { mainText: editWord, related: synList });
                setEditingItem(null);
            };

            const generateSynonymsWithAI = async (wordText) => {
                try {
                    const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyDHD8AhAFmlH9Cr06dBGTS9Lpvqvs9jNtM', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: `For the word "${wordText}", provide 4-6 synonyms. Respond with ONLY the synonyms separated by commas, nothing else. Example: joyful, cheerful, elated, content, pleased`
                                }]
                            }]
                        })
                    });
                    const data = await response.json();
                    const generatedSynonyms = data?.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
                    return generatedSynonyms ? generatedSynonyms.split(',').map(s => s.trim()).filter(s => s) : [];
                } catch (error) {
                    console.error('AI synonym generation failed:', error);
                    return [];
                }
            };

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsUploading(true);

                try {
                    const content = await file.text();
                    const lines = content.split(/[\n\r]+/).map(line => line.trim()).filter(line => line !== '' && line.length < 100);
                    setUploadProgress({ current: 0, total: lines.length });

                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line) {
                            // Parse format: "word (synonym)" or "word (syn1, syn2, syn3)"
                            const match = line.match(/^(.+?)\s*\((.+?)\)\s*$/);
                            if (match) {
                                const mainWord = match[1].trim();
                                const synList = match[2].split(',').map(s => s.trim()).filter(s => s);
                                onAdd({ type: 'synonym', mainText: mainWord, related: synList, easiness: 2.5, interval: 0, nextReview: Date.now() });
                            }
                        }
                        setUploadProgress({ current: i + 1, total: lines.length });
                    }
                } catch (error) {
                    console.error('File parsing error:', error);
                }

                setIsUploading(false);
                setUploadProgress({ current: 0, total: 0 });
                e.target.value = '';
            };

            const handleSubmit = (e) => { e.preventDefault(); if (!word.trim()) return; const synList = synonyms.split(',').map(s => s.trim()).filter(s => s); onAdd({ type: 'synonym', mainText: word, related: synList, easiness: 2.5, interval: 0, nextReview: Date.now() }); setWord(''); setSynonyms(''); };
            const synonymItems = items.filter(i => i.type === 'synonym');

            const inputClass = theme === 'dark'
                ? 'bg-slate-950/50 border border-slate-700 text-slate-100 placeholder:text-slate-500 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/50 shadow-inner backdrop-blur-sm'
                : 'bg-white border border-slate-200 text-slate-800 placeholder:text-slate-400 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/50 shadow-sm';

            const labelClass = theme === 'dark' ? 'text-slate-400 font-bold' : 'text-slate-500 font-bold';

            // Synonym Card Component
            const SynonymCard = ({ item }) => (
                <div className={`${theme === 'dark' ? 'bg-slate-900/50 border-slate-700' : 'bg-white border-slate-100'} rounded-3xl p-5 shadow-sm border hover:shadow-md transition-all duration-300 relative group overflow-hidden`}>
                    <div className="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-violet-400 via-indigo-500 to-violet-400"></div>
                    <div className="flex items-center justify-between gap-3 mt-3 mb-2">
                        <div className="flex-1 text-center min-w-0"><div className="text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-1">Concept</div><h4 className={`text-xl font-black truncate ${theme === 'dark' ? 'text-white' : 'text-slate-800'}`}>{item.mainText}</h4></div>
                        <div className="shrink-0 flex flex-col items-center pt-4"><div className={`w-8 h-8 rounded-full border flex items-center justify-center shadow-inner ${theme === 'dark' ? 'bg-slate-800 border-slate-600 text-indigo-400' : 'bg-indigo-50 border-indigo-100 text-indigo-600'}`}><LinkIcon className="w-3.5 h-3.5" /></div></div>
                        <div className="flex-1 text-center min-w-0"><div className="text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-1">Synonyms</div><div className={`text-xl font-black truncate ${theme === 'dark' ? 'text-slate-300' : 'text-slate-800'}`}>{item.related?.[0] || '...'}{item.related?.length > 1 && <span className="text-indigo-500 text-xs ml-1 align-top">+{item.related.length - 1}</span>}</div></div>
                    </div>
                    {item.sharedBy && (
                        <div className="flex items-center justify-center gap-1.5 mt-2">
                            {item.sharedBy.photoURL ? (
                                <img src={item.sharedBy.photoURL} className="w-4 h-4 rounded-full" alt="" />
                            ) : (
                                <div className="w-4 h-4 rounded-full bg-emerald-500/20 flex items-center justify-center">
                                    <User className="w-2.5 h-2.5 text-emerald-500" />
                                </div>
                            )}
                            <span className="text-xs font-medium text-emerald-500">
                                Shared by {item.sharedBy.displayName}
                            </span>
                        </div>
                    )}
                    <div className={`flex justify-end gap-2 mt-2 pt-2 border-t ${theme === 'dark' ? 'border-slate-800' : 'border-slate-50'}`}>
                        <button onClick={() => openEditModal(item)} className="text-slate-400 hover:text-indigo-500 transition-colors p-1.5"><Pencil className="w-4 h-4" /></button>
                        <button onClick={() => onDelete(item.id)} className="text-slate-400 hover:text-indigo-500 transition-colors p-1.5"><Trash2 className="w-4 h-4" /></button>
                    </div>
                </div>
            );

            return (
                <div className="space-y-12 animate-in slide-in-from-right-4 duration-500 pt-40 pb-12 max-w-6xl mx-auto px-4">
                    {/* Edit Modal */}
                    {editingItem && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4" onClick={() => setEditingItem(null)}>
                            <div className={`${theme === 'dark' ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'} p-8 rounded-3xl max-w-lg w-full shadow-2xl border animate-in zoom-in-95`} onClick={e => e.stopPropagation()}>
                                <h3 className={`text-2xl font-black mb-6 ${theme === 'dark' ? 'text-white' : 'text-slate-800'}`}>Edit Synonym Chain</h3>
                                <form onSubmit={handleEditSubmit} className="space-y-6">
                                    <div className="space-y-2">
                                        <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Main Word</label>
                                        <input value={editWord} onChange={e => setEditWord(e.target.value)} className={`w-full p-4 rounded-2xl outline-none font-bold transition-all ${inputClass}`} />
                                    </div>
                                    <div className="space-y-2">
                                        <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Synonyms (comma-separated)</label>
                                        <input value={editSynonyms} onChange={e => setEditSynonyms(e.target.value)} className={`w-full p-4 rounded-2xl outline-none font-bold transition-all ${inputClass}`} />
                                    </div>
                                    <div className="flex justify-end gap-3">
                                        <button type="button" onClick={() => setEditingItem(null)} className={`px-6 py-3 rounded-xl font-bold transition-all ${theme === 'dark' ? 'bg-slate-700 text-slate-300 hover:bg-slate-600' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>Cancel</button>
                                        <button type="submit" className="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-indigo-700 transition-all flex items-center gap-2"><Save className="w-4 h-4" /> Save Changes</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    <ManagerContainer title="New Chain" subtitle="Link concepts together." theme={theme}>
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div className="grid md:grid-cols-2 gap-6">
                                <div className="space-y-2"><label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Main Word</label><input value={word} onChange={e => setWord(e.target.value)} placeholder="e.g. Happy" className={`w-full p-4 rounded-2xl outline-none font-bold transition-all ${inputClass}`} /></div>
                                <div className="space-y-2"><label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Synonyms</label><input value={synonyms} onChange={e => setSynonyms(e.target.value)} placeholder="Joyful, Ecstatic..." className={`w-full p-4 rounded-2xl outline-none font-bold transition-all ${inputClass}`} /></div>
                            </div>
                            <div className="flex justify-end"><button type="submit" className="bg-slate-900 text-white px-10 py-4 rounded-2xl font-bold hover:bg-slate-800 transition-all shadow-lg active:scale-95 flex items-center gap-2"><LinkIcon className="w-5 h-5" /> Connect</button></div>
                        </form>
                    </ManagerContainer>
                    <ManagerContainer title="Synonyms" subtitle={`${synonymItems.length} chains`} theme={theme} headerAction={
                        <div className="flex items-center gap-2">
                            <input type="file" accept=".txt" ref={fileInputRef} onChange={handleFileUpload} className="hidden" disabled={isUploading} />
                            {isUploading ? (
                                <div className={`flex items-center gap-2 px-3 py-2 rounded-xl ${theme === 'dark' ? 'bg-violet-500/20 text-violet-400' : 'bg-violet-100 text-violet-600'}`}>
                                    <Loader2 className="w-4 h-4 animate-spin" />
                                    <span className="text-xs font-bold">{uploadProgress.current}/{uploadProgress.total}</span>
                                </div>
                            ) : (
                                <>
                                    <button onClick={() => fileInputRef.current?.click()} title="Upload words from TXT file" className={`p-2 rounded-xl transition-all hover:scale-105 active:scale-95 ${theme === 'dark' ? 'bg-violet-500/20 text-violet-400 hover:bg-violet-500/30' : 'bg-violet-100 text-violet-600 hover:bg-violet-200'}`}>
                                        <Upload className="w-5 h-5" />
                                    </button>
                                    {synonymItems.length > 0 && (
                                        <button onClick={() => onDeleteAll('synonym')} title="Delete all synonym chains" className={`p-2 rounded-xl transition-all hover:scale-105 active:scale-95 ${theme === 'dark' ? 'bg-red-500/20 text-red-400 hover:bg-red-500/30' : 'bg-red-100 text-red-600 hover:bg-red-200'}`}>
                                            <Trash2 className="w-5 h-5" />
                                        </button>
                                    )}
                                </>
                            )}
                        </div>
                    }>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">{synonymItems.map(item => (<SynonymCard key={item.id} item={item} />))}</div>
                    </ManagerContainer>
                </div>
            );
        };

        const AntonymManager = ({ items, onAdd, onDelete, onDeleteAll, onUpdate, theme }) => {
            const [wordA, setWordA] = useState('');
            const [wordB, setWordB] = useState('');
            const [isUploading, setIsUploading] = useState(false);
            const [uploadProgress, setUploadProgress] = useState({ current: 0, total: 0 });
            const [editingItem, setEditingItem] = useState(null);
            const [editWordA, setEditWordA] = useState('');
            const [editWordB, setEditWordB] = useState('');
            const fileInputRef = useRef(null);

            const openEditModal = (item) => {
                setEditingItem(item);
                setEditWordA(item.mainText || '');
                setEditWordB(item.related?.[0] || '');
            };

            const handleEditSubmit = (e) => {
                e.preventDefault();
                if (!editWordA.trim() || !editWordB.trim() || !editingItem) return;
                onUpdate(editingItem.id, { mainText: editWordA, related: [editWordB] });
                setEditingItem(null);
            };

            const generateAntonymWithAI = async (wordText) => {
                try {
                    const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyDHD8AhAFmlH9Cr06dBGTS9Lpvqvs9jNtM', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: `For the word "${wordText}", provide its most common antonym (opposite word). Respond with ONLY the single antonym word, nothing else.`
                                }]
                            }]
                        })
                    });
                    const data = await response.json();
                    const antonym = data?.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
                    return antonym || '';
                } catch (error) {
                    console.error('AI antonym generation failed:', error);
                    return '';
                }
            };

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsUploading(true);
                try {
                    const content = await file.text();
                    const lines = content.split(/[\n\r]+/).map(line => line.trim()).filter(line => line !== '' && line.length < 100);
                    setUploadProgress({ current: 0, total: lines.length });

                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line) {
                            // Parse format: "word (antonym)"
                            const match = line.match(/^(.+?)\s*\((.+?)\)\s*$/);
                            if (match) {
                                const mainWord = match[1].trim();
                                const antonym = match[2].trim();
                                onAdd({ type: 'antonym', mainText: mainWord, related: [antonym], easiness: 2.5, interval: 0, nextReview: Date.now() });
                            }
                        }
                        setUploadProgress({ current: i + 1, total: lines.length });
                    }
                } catch (error) {
                    console.error('File parsing error:', error);
                }
                setIsUploading(false);
                setUploadProgress({ current: 0, total: 0 });
                e.target.value = '';
            };

            const handleSubmit = (e) => { e.preventDefault(); if (!wordA.trim() || !wordB.trim()) return; onAdd({ type: 'antonym', mainText: wordA, related: [wordB], easiness: 2.5, interval: 0, nextReview: Date.now() }); setWordA(''); setWordB(''); };
            const antonymItems = items.filter(i => i.type === 'antonym');

            const inputClass = theme === 'dark'
                ? 'bg-slate-950/50 border border-slate-700 text-slate-100 placeholder:text-slate-500 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/50 shadow-inner backdrop-blur-sm'
                : 'bg-white border border-slate-200 text-slate-800 placeholder:text-slate-400 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/50 shadow-sm';

            const labelClass = theme === 'dark' ? 'text-slate-400 font-bold' : 'text-slate-500 font-bold';

            const AntonymCard = ({ item }) => (
                <div className={`${theme === 'dark' ? 'bg-slate-900/50 border-slate-700' : 'bg-white border-slate-100'} rounded-3xl p-6 shadow-sm border hover:shadow-md transition-all duration-300 relative group overflow-hidden`}>
                    <div className="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-rose-400 via-pink-500 to-rose-400"></div>
                    <div className="flex items-center justify-between gap-2 mt-2">
                        <div className="flex-1 text-center min-w-0"><div className="text-[10px] font-bold text-rose-400 uppercase tracking-widest mb-1">Positive</div><h4 className={`text-xl font-black truncate ${theme === 'dark' ? 'text-white' : 'text-slate-800'}`}>{item.mainText}</h4></div>
                        <div className="shrink-0 flex flex-col items-center"><div className={`w-10 h-10 rounded-full border flex items-center justify-center text-xs font-black shadow-inner ${theme === 'dark' ? 'bg-slate-800 border-slate-600 text-rose-400' : 'bg-rose-50 border-rose-100 text-rose-600'}`}>VS</div></div>
                        <div className="flex-1 text-center min-w-0"><div className="text-[10px] font-bold text-rose-400 uppercase tracking-widest mb-1">Negative</div><h4 className={`text-xl font-black truncate ${theme === 'dark' ? 'text-white' : 'text-slate-800'}`}>{item.related?.[0] || '?'}</h4></div>
                    </div>
                    {item.sharedBy && (
                        <div className="flex items-center justify-center gap-1.5 mt-3">
                            {item.sharedBy.photoURL ? (
                                <img src={item.sharedBy.photoURL} className="w-4 h-4 rounded-full" alt="" />
                            ) : (
                                <div className="w-4 h-4 rounded-full bg-emerald-500/20 flex items-center justify-center">
                                    <User className="w-2.5 h-2.5 text-emerald-500" />
                                </div>
                            )}
                            <span className="text-xs font-medium text-emerald-500">
                                Shared by {item.sharedBy.displayName}
                            </span>
                        </div>
                    )}
                    <div className={`flex justify-end gap-2 items-end mt-6 pt-4 border-t ${theme === 'dark' ? 'border-slate-800' : 'border-slate-50'}`}>
                        <button onClick={() => openEditModal(item)} className="text-slate-400 hover:text-rose-500 transition-colors p-1"><Pencil className="w-4 h-4" /></button>
                        <button onClick={() => onDelete(item.id)} className="text-slate-400 hover:text-rose-500 transition-colors p-1"><Trash2 className="w-4 h-4" /></button>
                    </div>
                </div>
            );

            return (
                <div className="space-y-12 animate-in slide-in-from-right-4 duration-500 pt-40 pb-12 max-w-6xl mx-auto px-4">
                    {/* Edit Modal */}
                    {editingItem && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4" onClick={() => setEditingItem(null)}>
                            <div className={`${theme === 'dark' ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'} p-8 rounded-3xl max-w-lg w-full shadow-2xl border animate-in zoom-in-95`} onClick={e => e.stopPropagation()}>
                                <h3 className={`text-2xl font-black mb-6 ${theme === 'dark' ? 'text-white' : 'text-slate-800'}`}>Edit Antonym Pair</h3>
                                <form onSubmit={handleEditSubmit} className="space-y-6">
                                    <div className="grid md:grid-cols-2 gap-4">
                                        <div className="space-y-2">
                                            <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Word</label>
                                            <input value={editWordA} onChange={e => setEditWordA(e.target.value)} className={`w-full p-4 rounded-2xl outline-none font-bold transition-all ${inputClass}`} />
                                        </div>
                                        <div className="space-y-2">
                                            <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Antonym</label>
                                            <input value={editWordB} onChange={e => setEditWordB(e.target.value)} className={`w-full p-4 rounded-2xl outline-none font-bold transition-all ${inputClass}`} />
                                        </div>
                                    </div>
                                    <div className="flex justify-end gap-3">
                                        <button type="button" onClick={() => setEditingItem(null)} className={`px-6 py-3 rounded-xl font-bold transition-all ${theme === 'dark' ? 'bg-slate-700 text-slate-300 hover:bg-slate-600' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>Cancel</button>
                                        <button type="submit" className="bg-rose-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-rose-700 transition-all flex items-center gap-2"><Save className="w-4 h-4" /> Save Changes</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    <ManagerContainer title="New Contrast" subtitle="Define opposites & master the spectrum." theme={theme}>
                        <form onSubmit={handleSubmit} className="space-y-8">
                            <div className="flex flex-col md:flex-row items-center gap-4 relative">
                                <div className="space-y-2 flex-1 w-full"><input value={wordA} onChange={e => setWordA(e.target.value)} placeholder="e.g. Expand" className={`w-full p-5 rounded-2xl outline-none font-bold text-lg transition-all ${inputClass}`} /></div>
                                <div className="hidden md:flex shrink-0 justify-center"><div className={`font-black text-xl italic w-10 h-10 rounded-full flex items-center justify-center shadow-sm ${theme === 'dark' ? 'bg-slate-700 text-slate-400' : 'bg-white text-slate-200'}`}>vs</div></div>
                                <div className="space-y-2 flex-1 w-full"><input value={wordB} onChange={e => setWordB(e.target.value)} placeholder="e.g. Contract" className={`w-full p-5 rounded-2xl outline-none font-bold text-lg transition-all ${inputClass}`} /></div>
                            </div>
                            <div className="flex justify-end"><button type="submit" className="bg-slate-900 text-white px-10 py-4 rounded-2xl font-bold hover:bg-slate-800 transition-all shadow-lg active:scale-95 flex items-center gap-2"><ArrowLeftRight className="w-5 h-5" /> Create Pair</button></div>
                        </form>
                    </ManagerContainer>
                    <ManagerContainer title="Antonyms" subtitle={`${antonymItems.length} pairs`} theme={theme} headerAction={
                        <div className="flex items-center gap-2">
                            <input type="file" accept=".txt" ref={fileInputRef} onChange={handleFileUpload} className="hidden" disabled={isUploading} />
                            {isUploading ? (
                                <div className={`flex items-center gap-2 px-3 py-2 rounded-xl ${theme === 'dark' ? 'bg-rose-500/20 text-rose-400' : 'bg-rose-100 text-rose-600'}`}>
                                    <Loader2 className="w-4 h-4 animate-spin" />
                                    <span className="text-xs font-bold">{uploadProgress.current}/{uploadProgress.total}</span>
                                </div>
                            ) : (
                                <>
                                    <button onClick={() => fileInputRef.current?.click()} title="Upload words from TXT file" className={`p-2 rounded-xl transition-all hover:scale-105 active:scale-95 ${theme === 'dark' ? 'bg-rose-500/20 text-rose-400 hover:bg-rose-500/30' : 'bg-rose-100 text-rose-600 hover:bg-rose-200'}`}>
                                        <Upload className="w-5 h-5" />
                                    </button>
                                    {antonymItems.length > 0 && (
                                        <button onClick={() => onDeleteAll('antonym')} title="Delete all antonym pairs" className={`p-2 rounded-xl transition-all hover:scale-105 active:scale-95 ${theme === 'dark' ? 'bg-red-500/20 text-red-400 hover:bg-red-500/30' : 'bg-red-100 text-red-600 hover:bg-red-200'}`}>
                                            <Trash2 className="w-5 h-5" />
                                        </button>
                                    )}
                                </>
                            )}
                        </div>
                    }>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">{antonymItems.map(item => (<AntonymCard key={item.id} item={item} />))}</div>
                    </ManagerContainer>
                </div>
            );
        };

        const PhraseManager = ({ items, onAdd, onDelete, onDeleteAll, onUpdate, theme }) => {
            const [phrase, setPhrase] = useState('');
            const [context, setContext] = useState('');
            const [isUploading, setIsUploading] = useState(false);
            const [uploadProgress, setUploadProgress] = useState({ current: 0, total: 0 });
            const [editingItem, setEditingItem] = useState(null);
            const [editPhrase, setEditPhrase] = useState('');
            const [editContext, setEditContext] = useState('');
            const fileInputRef = useRef(null);

            const openEditModal = (item) => {
                setEditingItem(item);
                setEditPhrase(item.mainText);
                setEditContext(item.context || '');
            };

            const handleEditSubmit = (e) => {
                e.preventDefault();
                if (!editPhrase.trim() || !editingItem) return;
                onUpdate(editingItem.id, { mainText: editPhrase, context: editContext });
                setEditingItem(null);
                setEditPhrase('');
                setEditContext('');
            };
            const handleSubmit = (e) => { e.preventDefault(); if (!phrase.trim()) return; onAdd({ type: 'phrase', mainText: phrase, context: context, easiness: 2.5, interval: 0, nextReview: Date.now() }); setPhrase(''); setContext(''); };
            const phraseItems = items.filter(i => i.type === 'phrase');

            const generateContextWithAI = async (phraseText) => {
                try {
                    const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyDHD8AhAFmlH9Cr06dBGTS9Lpvqvs9jNtM', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: `For the phrase "${phraseText}", provide a very brief contextual usage description (2-4 words max) that explains when or why someone would use this phrase. Examples: "Wishing luck", "Expressing gratitude", "Showing surprise", "Giving advice". Respond with ONLY the brief context, nothing else.`
                                }]
                            }]
                        })
                    });
                    const data = await response.json();
                    const generatedContext = data?.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
                    return generatedContext || 'General';
                } catch (error) {
                    console.error('AI context generation failed:', error);
                    return 'General';
                }
            };

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsUploading(true);

                try {
                    const content = await file.text();
                    const lines = content.split(/[\n\r]+/).filter(line => line.trim() !== '');
                    setUploadProgress({ current: 0, total: lines.length });

                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i];
                        const parts = line.split('|').map(p => p.trim());
                        const phraseText = parts[0];
                        let contextText = parts[1];

                        if (!contextText && phraseText) {
                            contextText = await generateContextWithAI(phraseText);
                        }

                        if (phraseText) {
                            onAdd({ type: 'phrase', mainText: phraseText, context: contextText || 'General', easiness: 2.5, interval: 0, nextReview: Date.now() });
                        }
                        setUploadProgress({ current: i + 1, total: lines.length });
                    }
                } catch (error) {
                    console.error('File parsing error:', error);
                }

                setIsUploading(false);
                setUploadProgress({ current: 0, total: 0 });
                e.target.value = '';
            };

            const inputClass = theme === 'dark'
                ? 'bg-slate-950/50 border border-slate-700 text-slate-100 placeholder:text-slate-500 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/50 shadow-inner backdrop-blur-sm'
                : 'bg-white border border-slate-200 text-slate-800 placeholder:text-slate-400 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/50 shadow-sm';

            const labelClass = theme === 'dark' ? 'text-slate-400 font-bold' : 'text-slate-500 font-bold';

            return (
                <div className="space-y-12 animate-in slide-in-from-right-4 duration-500 pt-40 pb-12 max-w-6xl mx-auto px-4">
                    {/* Edit Modal */}
                    {editingItem && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-4" onClick={() => setEditingItem(null)}>
                            <div className={`${theme === 'dark' ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'} p-8 rounded-3xl max-w-lg w-full shadow-2xl border animate-in zoom-in-95`} onClick={e => e.stopPropagation()}>
                                <h3 className={`text-2xl font-black mb-6 ${theme === 'dark' ? 'text-white' : 'text-slate-800'}`}>Edit Phrase</h3>
                                <form onSubmit={handleEditSubmit} className="space-y-6">
                                    <div className="space-y-2">
                                        <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>The Phrase</label>
                                        <input value={editPhrase} onChange={e => setEditPhrase(e.target.value)} className={`w-full p-4 rounded-2xl outline-none font-bold transition-all ${inputClass}`} />
                                    </div>
                                    <div className="space-y-2">
                                        <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Context</label>
                                        <input value={editContext} onChange={e => setEditContext(e.target.value)} className={`w-full p-4 rounded-2xl outline-none font-bold transition-all ${inputClass}`} />
                                    </div>
                                    <div className="flex justify-end gap-3">
                                        <button type="button" onClick={() => setEditingItem(null)} className={`px-6 py-3 rounded-xl font-bold transition-all ${theme === 'dark' ? 'bg-slate-700 text-slate-300 hover:bg-slate-600' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>Cancel</button>
                                        <button type="submit" className="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-indigo-700 transition-all flex items-center gap-2"><Save className="w-4 h-4" /> Save Changes</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    <ManagerContainer title="New Phrase" subtitle="Capture situational language." theme={theme}>
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div className="space-y-2"><label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>The Phrase</label><input value={phrase} onChange={e => setPhrase(e.target.value)} placeholder="e.g. Break a leg" className={`w-full p-4 rounded-2xl outline-none font-bold transition-all ${inputClass}`} /></div>
                            <div className="space-y-2"><label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Context</label><input value={context} onChange={e => setContext(e.target.value)} placeholder="e.g. Wishing luck" className={`w-full p-4 rounded-2xl outline-none font-bold transition-all ${inputClass}`} /></div>
                            <div className="flex justify-end"><button type="submit" className="bg-slate-900 text-white px-10 py-4 rounded-2xl font-bold hover:bg-slate-800 transition-all shadow-lg active:scale-95 flex items-center gap-2"><MessageCircle className="w-5 h-5" /> Save Phrase</button></div>
                        </form>
                    </ManagerContainer>
                    <ManagerContainer title="Phrases" subtitle={`${phraseItems.length} items`} theme={theme} headerAction={
                        <div className="flex items-center gap-2">
                            <input type="file" accept=".txt" ref={fileInputRef} onChange={handleFileUpload} className="hidden" disabled={isUploading} />
                            {isUploading ? (
                                <div className={`flex items-center gap-2 px-3 py-2 rounded-xl ${theme === 'dark' ? 'bg-indigo-500/20 text-indigo-400' : 'bg-indigo-100 text-indigo-600'}`}>
                                    <Loader2 className="w-4 h-4 animate-spin" />
                                    <span className="text-xs font-bold">{uploadProgress.current}/{uploadProgress.total}</span>
                                </div>
                            ) : (
                                <>
                                    <button onClick={() => fileInputRef.current?.click()} title="Upload phrases from TXT file" className={`p-2 rounded-xl transition-all hover:scale-105 active:scale-95 ${theme === 'dark' ? 'bg-indigo-500/20 text-indigo-400 hover:bg-indigo-500/30' : 'bg-indigo-100 text-indigo-600 hover:bg-indigo-200'}`}>
                                        <Upload className="w-5 h-5" />
                                    </button>
                                    {phraseItems.length > 0 && (
                                        <button onClick={() => onDeleteAll('phrase')} title="Delete all phrases" className={`p-2 rounded-xl transition-all hover:scale-105 active:scale-95 ${theme === 'dark' ? 'bg-red-500/20 text-red-400 hover:bg-red-500/30' : 'bg-red-100 text-red-600 hover:bg-red-200'}`}>
                                            <Trash2 className="w-5 h-5" />
                                        </button>
                                    )}
                                </>
                            )}
                        </div>
                    }>
                        <div className="grid grid-cols-1 gap-5">{phraseItems.map(item => (<ItemCard key={item.id} type="phrase" title={item.mainText} theme={theme} subtitle={<span><span className="font-bold text-amber-500 uppercase text-[10px] tracking-wider mr-2 bg-amber-500/10 px-1.5 py-0.5 rounded">{item.context || "General"}</span></span>} icon={MessageCircle} onDelete={() => onDelete(item.id)} onEdit={() => openEditModal(item)} interval={item.interval} sharedBy={item.sharedBy} />))}</div>
                    </ManagerContainer>
                </div>
            );
        };

        // --- MY LEARNING - UNIFIED COMPONENT ---
        const MyLearning = ({ items, onAdd, onDelete, onDeleteAll, onUpdate, theme, user, onShareToPeers }) => {
            const [activeCategory, setActiveCategory] = useState('voca');

            // Edit modal states
            const [editingItem, setEditingItem] = useState(null);
            const [editFormData, setEditFormData] = useState({});

            // Share confirmation state
            const [shareConfirm, setShareConfirm] = useState(null);

            // Delete confirmation state for single word
            const [deleteConfirmItem, setDeleteConfirmItem] = useState(null);

            const categories = [
                { id: 'voca', label: 'Vocabulary', icon: Book, color: 'from-indigo-500 to-blue-500', count: items.filter(i => i.type === 'voca' && !i.sharedBy).length },
                { id: 'synonym', label: 'Synonyms', icon: LinkIcon, color: 'from-violet-500 to-purple-500', count: items.filter(i => i.type === 'synonym' && !i.sharedBy).length },
                { id: 'antonym', label: 'Antonyms', icon: ArrowLeftRight, color: 'from-rose-500 to-pink-500', count: items.filter(i => i.type === 'antonym' && !i.sharedBy).length },
                { id: 'phrase', label: 'Phrases', icon: MessageCircle, color: 'from-amber-400 to-orange-500', count: items.filter(i => i.type === 'phrase' && !i.sharedBy).length },
                { id: 'shared', label: 'Recieved Words', icon: Share2, color: 'from-emerald-500 to-teal-500', count: items.filter(i => i.sharedBy).length },
            ];

            const cardBg = theme === 'dark' ? 'glass-panel-dark' : 'glass-panel-light';
            const textColor = theme === 'dark' ? 'text-white' : 'text-slate-800';
            const textSub = theme === 'dark' ? 'text-gray-400' : 'text-slate-500';
            const inputClass = theme === 'dark'
                ? 'bg-slate-950/50 border border-slate-700 text-slate-100 placeholder:text-slate-500 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/50 shadow-inner backdrop-blur-sm'
                : 'bg-white border border-slate-200 text-slate-800 placeholder:text-slate-400 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/50 shadow-sm';
            const labelClass = theme === 'dark' ? 'text-slate-400 font-bold' : 'text-slate-500 font-bold';

            // Form states for inline Add forms
            const [vocaForm, setVocaForm] = useState({ word: '', pos: 'noun', ipa: '', definition: '', example: '', collocations: '' });
            const [synonymForm, setSynonymForm] = useState({ word: '', synonyms: '' });
            const [antonymForm, setAntonymForm] = useState({ wordA: '', wordB: '' });
            const [phraseForm, setPhraseForm] = useState({ phrase: '', context: '' });

            // Dropdown visibility state for add forms
            const [showAddForm, setShowAddForm] = useState(false);

            // Share message state
            const [shareMessage, setShareMessage] = useState('');

            // Add handlers
            const handleVocaSubmit = (e) => {
                e.preventDefault();
                if (!vocaForm.word.trim()) return;
                onAdd({ type: 'voca', mainText: vocaForm.word, context: vocaForm.definition, pos: vocaForm.pos, ipa: vocaForm.ipa, example: vocaForm.example, collocations: vocaForm.collocations, easiness: 2.5, interval: 0, nextReview: Date.now() });
                setVocaForm({ word: '', pos: 'noun', ipa: '', definition: '', example: '', collocations: '' });
            };

            const handleSynonymSubmit = (e) => {
                e.preventDefault();
                if (!synonymForm.word.trim()) return;
                const synList = synonymForm.synonyms.split(',').map(s => s.trim()).filter(s => s);
                onAdd({ type: 'synonym', mainText: synonymForm.word, related: synList, easiness: 2.5, interval: 0, nextReview: Date.now() });
                setSynonymForm({ word: '', synonyms: '' });
            };

            const handleAntonymSubmit = (e) => {
                e.preventDefault();
                if (!antonymForm.wordA.trim() || !antonymForm.wordB.trim()) return;
                onAdd({ type: 'antonym', mainText: antonymForm.wordA, related: [antonymForm.wordB], easiness: 2.5, interval: 0, nextReview: Date.now() });
                setAntonymForm({ wordA: '', wordB: '' });
            };

            const handlePhraseSubmit = (e) => {
                e.preventDefault();
                if (!phraseForm.phrase.trim()) return;
                onAdd({ type: 'phrase', mainText: phraseForm.phrase, context: phraseForm.context, easiness: 2.5, interval: 0, nextReview: Date.now() });
                setPhraseForm({ phrase: '', context: '' });
            };

            // Edit handlers
            const openEditModal = (item) => {
                setEditingItem(item);
                if (item.type === 'voca') {
                    setEditFormData({ word: item.mainText, pos: item.pos || 'noun', ipa: item.ipa || '', definition: item.context || '', example: item.example || '', collocations: item.collocations || '' });
                } else if (item.type === 'synonym') {
                    setEditFormData({ word: item.mainText, synonyms: item.related?.join(', ') || '' });
                } else if (item.type === 'antonym') {
                    setEditFormData({ wordA: item.mainText, wordB: item.related?.[0] || '' });
                } else if (item.type === 'phrase') {
                    setEditFormData({ phrase: item.mainText, context: item.context || '' });
                }
            };

            const handleEditSubmit = (e) => {
                e.preventDefault();
                if (!editingItem) return;

                if (editingItem.type === 'voca') {
                    onUpdate(editingItem.id, { mainText: editFormData.word, context: editFormData.definition, pos: editFormData.pos, ipa: editFormData.ipa, example: editFormData.example, collocations: editFormData.collocations });
                } else if (editingItem.type === 'synonym') {
                    const synList = editFormData.synonyms.split(',').map(s => s.trim()).filter(s => s);
                    onUpdate(editingItem.id, { mainText: editFormData.word, related: synList });
                } else if (editingItem.type === 'antonym') {
                    onUpdate(editingItem.id, { mainText: editFormData.wordA, related: [editFormData.wordB] });
                } else if (editingItem.type === 'phrase') {
                    onUpdate(editingItem.id, { mainText: editFormData.phrase, context: editFormData.context });
                }
                setEditingItem(null);
            };

            // Share to Peers handler
            const handleShareToPeers = (item) => {
                setShareConfirm(item);
            };

            const confirmShare = async () => {
                if (!shareConfirm || !onShareToPeers || !shareMessage.trim()) return;
                await onShareToPeers(shareConfirm, shareMessage.trim());
                setShareConfirm(null);
                setShareMessage('');
            };

            // Single item delete confirmation handlers
            const handleDeleteClick = (item) => {
                setDeleteConfirmItem(item);
            };

            const confirmDeleteItem = () => {
                if (deleteConfirmItem) {
                    onDelete(deleteConfirmItem.id);
                    setDeleteConfirmItem(null);
                }
            };

            // Filter items based on active category - Shared category shows all items with sharedBy property
            const filteredItems = activeCategory === 'shared'
                ? items.filter(i => i.sharedBy)
                : items.filter(i => i.type === activeCategory && !i.sharedBy);
            const currentCategory = categories.find(c => c.id === activeCategory);

            return (
                <div className="space-y-8 animate-in slide-in-from-right-4 duration-500 pt-40 pb-12 max-w-6xl mx-auto px-4">
                    {/* Header with Stats */}
                    <div className={`${cardBg} rounded-[2.5rem] p-8 pb-6 shadow-xl overflow-visible`}>
                        <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
                            <div>
                                <h2 className={`text-3xl font-black ${textColor} tracking-tight`}>My Learning</h2>
                                <p className={`${textSub} mt-1`}>All your vocabulary in one place</p>
                            </div>
                            <div className="flex items-center gap-3">
                                <div className={`px-4 py-2 rounded-xl ${theme === 'dark' ? 'bg-indigo-500/20' : 'bg-indigo-100'} flex items-center gap-2`}>
                                    <Layers className="w-5 h-5 text-indigo-500" />
                                    <span className={`font-bold ${theme === 'dark' ? 'text-indigo-300' : 'text-indigo-600'}`}>{items.length} Total</span>
                                </div>
                            </div>
                        </div>

                        {/* Category Tabs */}
                        <div className="flex flex-col sm:flex-row flex-wrap gap-2 sm:gap-3 mt-6 sm:mt-8 sm:overflow-x-auto overflow-y-visible pt-4 pb-4 -mx-2 px-2">
                            {categories.map(cat => (
                                <button
                                    key={cat.id}
                                    onClick={() => setActiveCategory(cat.id)}
                                    className={`flex items-center justify-center sm:justify-start gap-1.5 sm:gap-2 px-4 sm:px-5 py-3 sm:py-3.5 rounded-xl sm:rounded-2xl font-bold transition-all duration-300 whitespace-nowrap sm:shrink-0 text-sm sm:text-base min-h-[44px] sm:min-h-[48px] w-full sm:w-auto ${activeCategory === cat.id
                                        ? `bg-gradient-to-r ${cat.color} text-white shadow-lg scale-105`
                                        : `${theme === 'dark' ? 'bg-slate-800/50 text-slate-300 hover:bg-slate-700/50' : 'bg-white/50 text-slate-600 hover:bg-white/80'}`
                                        }`}
                                >
                                    <cat.icon className="w-4 h-4 sm:w-5 sm:h-5" />
                                    <span>{cat.label}</span>
                                    <span className={`px-2 sm:px-2.5 py-1 rounded-full text-xs font-bold ${activeCategory === cat.id
                                        ? 'bg-white/20'
                                        : theme === 'dark' ? 'bg-slate-700' : 'bg-slate-200'
                                        }`}>{cat.count}</span>
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Add New Entry Section - Dropdown Forms (Hidden for Recieved Words) */}
                    {activeCategory !== 'shared' && (
                        <div className={`${cardBg} rounded-[2.5rem] shadow-xl overflow-hidden`}>
                            {/* Dropdown Toggle Button */}
                            <button
                                onClick={() => setShowAddForm(!showAddForm)}
                                className={`w-full p-6 flex items-center justify-between transition-all duration-300 ${showAddForm ? '' : 'hover:bg-white/5'}`}
                            >
                                <h3 className={`text-xl font-bold ${textColor} flex items-center gap-3`}>
                                    <div className={`w-10 h-10 rounded-xl bg-gradient-to-r ${currentCategory.color} flex items-center justify-center shadow-lg`}>
                                        <Plus className="w-5 h-5 text-white" />
                                    </div>
                                    Add New {currentCategory.label.slice(0, -1)}
                                </h3>
                                <div className={`w-10 h-10 rounded-full flex items-center justify-center transition-all duration-300 ${showAddForm ? 'rotate-180' : ''} ${theme === 'dark' ? 'bg-slate-700/50' : 'bg-slate-100'}`}>
                                    <ChevronDown className={`w-5 h-5 ${theme === 'dark' ? 'text-slate-400' : 'text-slate-500'}`} />
                                </div>
                            </button>

                            {/* Animated Form Container */}
                            <div className={`transition-all duration-500 ease-out ${showAddForm ? 'max-h-[800px] opacity-100' : 'max-h-0 opacity-0 overflow-hidden'}`}>
                                <div className={`px-8 pb-8 pt-2 border-t ${theme === 'dark' ? 'border-slate-700/50' : 'border-slate-200/50'}`}>

                                    {/* Vocabulary Form */}
                                    {activeCategory === 'voca' && (
                                        <form onSubmit={handleVocaSubmit} className="space-y-5">
                                            <div className="grid md:grid-cols-3 gap-5">
                                                <div className="md:col-span-2 space-y-2">
                                                    <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Word</label>
                                                    <input name="word" value={vocaForm.word} onChange={e => setVocaForm(p => ({ ...p, word: e.target.value }))} placeholder="e.g. Serendipity" className={`w-full p-4 rounded-2xl outline-none font-bold transition-all ${inputClass}`} />
                                                </div>
                                                <div className="space-y-2">
                                                    <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Type</label>
                                                    <select name="pos" value={vocaForm.pos} onChange={e => setVocaForm(p => ({ ...p, pos: e.target.value }))} className={`w-full p-4 rounded-2xl outline-none font-bold transition-all appearance-none cursor-pointer ${inputClass}`}>
                                                        <option value="noun">Noun</option>
                                                        <option value="verb">Verb</option>
                                                        <option value="adjective">Adjective</option>
                                                        <option value="adverb">Adverb</option>
                                                        <option value="idiom">Idiom</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div className="grid md:grid-cols-2 gap-5">
                                                <div className="space-y-2">
                                                    <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>IPA (Pronunciation)</label>
                                                    <input name="ipa" value={vocaForm.ipa} onChange={e => setVocaForm(p => ({ ...p, ipa: e.target.value }))} placeholder="/.../" className={`w-full p-4 rounded-2xl outline-none font-mono text-sm transition-all ${inputClass}`} />
                                                </div>
                                                <div className="space-y-2">
                                                    <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Collocations</label>
                                                    <input name="collocations" value={vocaForm.collocations} onChange={e => setVocaForm(p => ({ ...p, collocations: e.target.value }))} placeholder="strong coffee, heavy rain..." className={`w-full p-4 rounded-2xl outline-none font-medium transition-all ${inputClass}`} />
                                                </div>
                                            </div>
                                            <div className="space-y-2">
                                                <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Definition</label>
                                                <textarea name="definition" value={vocaForm.definition} onChange={e => setVocaForm(p => ({ ...p, definition: e.target.value }))} rows="2" placeholder="What does it mean?" className={`w-full p-4 rounded-2xl outline-none font-medium resize-none transition-all ${inputClass}`} />
                                            </div>
                                            <div className="space-y-2">
                                                <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Example Sentence</label>
                                                <textarea name="example" value={vocaForm.example} onChange={e => setVocaForm(p => ({ ...p, example: e.target.value }))} rows="2" placeholder="Use it in a sentence..." className={`w-full p-4 rounded-2xl outline-none font-medium resize-none transition-all ${inputClass}`} />
                                            </div>
                                            <div className="flex justify-end">
                                                <button type="submit" className="bg-gradient-to-r from-indigo-500 to-blue-500 text-white px-8 py-4 rounded-2xl font-bold hover:from-indigo-600 hover:to-blue-600 transition-all shadow-lg hover:shadow-xl active:scale-95 flex items-center gap-2">
                                                    <Plus className="w-5 h-5" /> Add Vocabulary
                                                </button>
                                            </div>
                                        </form>
                                    )}

                                    {/* Synonyms Form */}
                                    {activeCategory === 'synonym' && (
                                        <form onSubmit={handleSynonymSubmit} className="space-y-5">
                                            <div className="grid md:grid-cols-2 gap-5">
                                                <div className="space-y-2">
                                                    <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Main Word</label>
                                                    <input value={synonymForm.word} onChange={e => setSynonymForm(p => ({ ...p, word: e.target.value }))} placeholder="e.g. Happy" className={`w-full p-4 rounded-2xl outline-none font-bold transition-all ${inputClass}`} />
                                                </div>
                                                <div className="space-y-2">
                                                    <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Synonyms (comma-separated)</label>
                                                    <input value={synonymForm.synonyms} onChange={e => setSynonymForm(p => ({ ...p, synonyms: e.target.value }))} placeholder="Joyful, Ecstatic, Content..." className={`w-full p-4 rounded-2xl outline-none font-bold transition-all ${inputClass}`} />
                                                </div>
                                            </div>
                                            <div className="flex justify-end">
                                                <button type="submit" className="bg-gradient-to-r from-violet-500 to-purple-500 text-white px-8 py-4 rounded-2xl font-bold hover:from-violet-600 hover:to-purple-600 transition-all shadow-lg hover:shadow-xl active:scale-95 flex items-center gap-2">
                                                    <LinkIcon className="w-5 h-5" /> Connect Synonyms
                                                </button>
                                            </div>
                                        </form>
                                    )}

                                    {/* Antonyms Form */}
                                    {activeCategory === 'antonym' && (
                                        <form onSubmit={handleAntonymSubmit} className="space-y-5">
                                            <div className="flex flex-col md:flex-row items-center gap-4">
                                                <div className="flex-1 w-full space-y-2">
                                                    <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Word</label>
                                                    <input value={antonymForm.wordA} onChange={e => setAntonymForm(p => ({ ...p, wordA: e.target.value }))} placeholder="e.g. Expand" className={`w-full p-5 rounded-2xl outline-none font-bold text-lg transition-all ${inputClass}`} />
                                                </div>
                                                <div className="hidden md:flex shrink-0 justify-center">
                                                    <div className={`font-black text-xl italic w-12 h-12 rounded-full flex items-center justify-center shadow-sm ${theme === 'dark' ? 'bg-slate-700 text-slate-400' : 'bg-white text-slate-200'}`}>vs</div>
                                                </div>
                                                <div className="flex-1 w-full space-y-2">
                                                    <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Opposite</label>
                                                    <input value={antonymForm.wordB} onChange={e => setAntonymForm(p => ({ ...p, wordB: e.target.value }))} placeholder="e.g. Contract" className={`w-full p-5 rounded-2xl outline-none font-bold text-lg transition-all ${inputClass}`} />
                                                </div>
                                            </div>
                                            <div className="flex justify-end">
                                                <button type="submit" className="bg-gradient-to-r from-rose-500 to-pink-500 text-white px-8 py-4 rounded-2xl font-bold hover:from-rose-600 hover:to-pink-600 transition-all shadow-lg hover:shadow-xl active:scale-95 flex items-center gap-2">
                                                    <ArrowLeftRight className="w-5 h-5" /> Create Antonym Pair
                                                </button>
                                            </div>
                                        </form>
                                    )}

                                    {/* Phrases Form */}
                                    {activeCategory === 'phrase' && (
                                        <form onSubmit={handlePhraseSubmit} className="space-y-5">
                                            <div className="space-y-2">
                                                <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>The Phrase</label>
                                                <input value={phraseForm.phrase} onChange={e => setPhraseForm(p => ({ ...p, phrase: e.target.value }))} placeholder="e.g. Break a leg" className={`w-full p-4 rounded-2xl outline-none font-bold transition-all ${inputClass}`} />
                                            </div>
                                            <div className="space-y-2">
                                                <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Context / When to Use</label>
                                                <input value={phraseForm.context} onChange={e => setPhraseForm(p => ({ ...p, context: e.target.value }))} placeholder="e.g. Wishing luck" className={`w-full p-4 rounded-2xl outline-none font-medium transition-all ${inputClass}`} />
                                            </div>
                                            <div className="flex justify-end">
                                                <button type="submit" className="bg-gradient-to-r from-amber-500 to-orange-500 text-white px-8 py-4 rounded-2xl font-bold hover:from-amber-600 hover:to-orange-600 transition-all shadow-lg hover:shadow-xl active:scale-95 flex items-center gap-2">
                                                    <MessageCircle className="w-5 h-5" /> Save Phrase
                                                </button>
                                            </div>
                                        </form>
                                    )}

                                </div>
                            </div>
                        </div>
                    )}

                    {/* Items Grid */}
                    <div className={`${cardBg} rounded-[2.5rem] p-8 shadow-xl`}>
                        <div className="flex items-center justify-between mb-6">
                            <h3 className={`text-xl font-bold ${textColor} flex items-center gap-2`}>
                                <currentCategory.icon className="w-5 h-5" />
                                {currentCategory.label} <span className={`text-sm font-normal ${textSub}`}>({filteredItems.length})</span>
                            </h3>
                            {filteredItems.length > 0 && activeCategory !== 'shared' && (
                                <button
                                    onClick={() => onDeleteAll(activeCategory)}
                                    className={`p-2 rounded-xl transition-all hover:scale-105 active:scale-95 ${theme === 'dark' ? 'bg-red-500/20 text-red-400 hover:bg-red-500/30' : 'bg-red-100 text-red-600 hover:bg-red-200'}`}
                                    title="Delete all"
                                >
                                    <Trash2 className="w-5 h-5" />
                                </button>
                            )}
                        </div>

                        {filteredItems.length === 0 ? (
                            <div className={`text-center py-16 rounded-3xl border border-dashed ${theme === 'dark' ? 'border-slate-700 text-slate-500' : 'border-slate-200 text-slate-400'}`}>
                                <currentCategory.icon className={`w-12 h-12 mx-auto mb-4 opacity-30`} />
                                <p className="font-medium">No {currentCategory.label.toLowerCase()} yet</p>
                                <p className="text-sm mt-1">{activeCategory === 'shared' ? 'Words shared by others will appear here' : 'Use the form above to add your first entry'}</p>
                            </div>
                        ) : (
                            <div className={`grid gap-4 ${activeCategory === 'phrase' || activeCategory === 'shared' ? 'grid-cols-1' : 'grid-cols-1 md:grid-cols-2'}`}>
                                {filteredItems.map(item => {
                                    // Determine the correct icon based on item type
                                    const itemIcon = item.type === 'voca' ? Book : item.type === 'synonym' ? LinkIcon : item.type === 'antonym' ? ArrowLeftRight : MessageCircle;
                                    return (
                                        <ItemCard
                                            key={item.id}
                                            type={item.type}
                                            title={item.mainText}
                                            theme={theme}
                                            subtitle={
                                                item.type === 'voca' ? (
                                                    <span><span className="font-bold text-indigo-500 uppercase text-[10px] tracking-wider mr-2 bg-indigo-500/10 px-1.5 py-0.5 rounded">{item.pos}</span>{item.context || "No definition"}</span>
                                                ) : item.type === 'synonym' ? (
                                                    <span className="text-violet-500">{item.related?.join(', ') || '...'}</span>
                                                ) : item.type === 'antonym' ? (
                                                    <span className="text-rose-500">â†” {item.related?.[0] || '?'}</span>
                                                ) : (
                                                    <span><span className="font-bold text-amber-500 uppercase text-[10px] tracking-wider mr-2 bg-amber-500/10 px-1.5 py-0.5 rounded">{item.context || "General"}</span></span>
                                                )
                                            }
                                            icon={activeCategory === 'shared' ? itemIcon : currentCategory.icon}
                                            onEdit={() => openEditModal(item)}
                                            onShare={activeCategory !== 'shared' ? () => handleShareToPeers(item) : undefined}
                                            onDelete={() => handleDeleteClick(item)}
                                            interval={item.interval}
                                            sharedBy={item.sharedBy}
                                        />
                                    );
                                })}
                            </div>
                        )}
                    </div>

                    {/* Edit Modal */}
                    {editingItem && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4" onClick={() => setEditingItem(null)}>
                            <div className={`${theme === 'dark' ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'} p-8 rounded-3xl max-w-2xl w-full shadow-2xl border animate-in zoom-in-95 max-h-[85vh] overflow-y-auto`} onClick={e => e.stopPropagation()}>
                                <div className="flex items-center justify-between mb-6">
                                    <h3 className={`text-2xl font-black ${textColor}`}>Edit {editingItem.type === 'voca' ? 'Vocabulary' : editingItem.type === 'synonym' ? 'Synonym Chain' : editingItem.type === 'antonym' ? 'Antonym Pair' : 'Phrase'}</h3>
                                    <button onClick={() => setEditingItem(null)} className={`p-2 rounded-xl ${theme === 'dark' ? 'hover:bg-slate-700' : 'hover:bg-slate-100'}`}>
                                        <X className="w-5 h-5" />
                                    </button>
                                </div>

                                <form onSubmit={handleEditSubmit} className="space-y-5">
                                    {editingItem.type === 'voca' && (
                                        <>
                                            <div className="grid md:grid-cols-2 gap-4">
                                                <div className="space-y-2">
                                                    <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Word</label>
                                                    <input value={editFormData.word || ''} onChange={e => setEditFormData(p => ({ ...p, word: e.target.value }))} className={`w-full p-4 rounded-2xl outline-none font-bold transition-all ${inputClass}`} />
                                                </div>
                                                <div className="space-y-2">
                                                    <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Type</label>
                                                    <select value={editFormData.pos || 'noun'} onChange={e => setEditFormData(p => ({ ...p, pos: e.target.value }))} className={`w-full p-4 rounded-2xl outline-none font-bold transition-all appearance-none cursor-pointer ${inputClass}`}>
                                                        <option value="noun">Noun</option>
                                                        <option value="verb">Verb</option>
                                                        <option value="adjective">Adjective</option>
                                                        <option value="adverb">Adverb</option>
                                                        <option value="idiom">Idiom</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div className="grid md:grid-cols-2 gap-4">
                                                <div className="space-y-2">
                                                    <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>IPA (Pronunciation)</label>
                                                    <input value={editFormData.ipa || ''} onChange={e => setEditFormData(p => ({ ...p, ipa: e.target.value }))} className={`w-full p-4 rounded-2xl outline-none font-mono text-sm transition-all ${inputClass}`} />
                                                </div>
                                                <div className="space-y-2">
                                                    <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Collocations</label>
                                                    <input value={editFormData.collocations || ''} onChange={e => setEditFormData(p => ({ ...p, collocations: e.target.value }))} className={`w-full p-4 rounded-2xl outline-none font-medium transition-all ${inputClass}`} />
                                                </div>
                                            </div>
                                            <div className="space-y-2">
                                                <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Definition</label>
                                                <textarea value={editFormData.definition || ''} onChange={e => setEditFormData(p => ({ ...p, definition: e.target.value }))} rows="2" className={`w-full p-4 rounded-2xl outline-none font-medium resize-none transition-all ${inputClass}`} />
                                            </div>
                                            <div className="space-y-2">
                                                <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Example Sentence</label>
                                                <textarea value={editFormData.example || ''} onChange={e => setEditFormData(p => ({ ...p, example: e.target.value }))} rows="2" className={`w-full p-4 rounded-2xl outline-none font-medium resize-none transition-all ${inputClass}`} />
                                            </div>
                                        </>
                                    )}

                                    {editingItem.type === 'synonym' && (
                                        <>
                                            <div className="space-y-2">
                                                <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Main Word</label>
                                                <input value={editFormData.word || ''} onChange={e => setEditFormData(p => ({ ...p, word: e.target.value }))} className={`w-full p-4 rounded-2xl outline-none font-bold transition-all ${inputClass}`} />
                                            </div>
                                            <div className="space-y-2">
                                                <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Synonyms (comma-separated)</label>
                                                <input value={editFormData.synonyms || ''} onChange={e => setEditFormData(p => ({ ...p, synonyms: e.target.value }))} className={`w-full p-4 rounded-2xl outline-none font-bold transition-all ${inputClass}`} />
                                            </div>
                                        </>
                                    )}

                                    {editingItem.type === 'antonym' && (
                                        <div className="grid md:grid-cols-2 gap-4">
                                            <div className="space-y-2">
                                                <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Word</label>
                                                <input value={editFormData.wordA || ''} onChange={e => setEditFormData(p => ({ ...p, wordA: e.target.value }))} className={`w-full p-4 rounded-2xl outline-none font-bold transition-all ${inputClass}`} />
                                            </div>
                                            <div className="space-y-2">
                                                <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Antonym</label>
                                                <input value={editFormData.wordB || ''} onChange={e => setEditFormData(p => ({ ...p, wordB: e.target.value }))} className={`w-full p-4 rounded-2xl outline-none font-bold transition-all ${inputClass}`} />
                                            </div>
                                        </div>
                                    )}

                                    {editingItem.type === 'phrase' && (
                                        <>
                                            <div className="space-y-2">
                                                <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>The Phrase</label>
                                                <input value={editFormData.phrase || ''} onChange={e => setEditFormData(p => ({ ...p, phrase: e.target.value }))} className={`w-full p-4 rounded-2xl outline-none font-bold transition-all ${inputClass}`} />
                                            </div>
                                            <div className="space-y-2">
                                                <label className={`text-xs uppercase tracking-widest pl-1 ${labelClass}`}>Context</label>
                                                <input value={editFormData.context || ''} onChange={e => setEditFormData(p => ({ ...p, context: e.target.value }))} className={`w-full p-4 rounded-2xl outline-none font-bold transition-all ${inputClass}`} />
                                            </div>
                                        </>
                                    )}

                                    <div className="flex justify-end gap-3 pt-2">
                                        <button type="button" onClick={() => setEditingItem(null)} className={`px-6 py-3 rounded-xl font-bold transition-all ${theme === 'dark' ? 'bg-slate-700 text-slate-300 hover:bg-slate-600' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>Cancel</button>
                                        <button type="submit" className="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-indigo-700 transition-all flex items-center gap-2">
                                            <Save className="w-4 h-4" /> Save Changes
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Share Confirmation Modal */}
                    {shareConfirm && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4" onClick={() => { setShareConfirm(null); setShareMessage(''); }}>
                            <div className={`${theme === 'dark' ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'} p-8 rounded-3xl max-w-lg w-full shadow-2xl border animate-in zoom-in-95`} onClick={e => e.stopPropagation()}>
                                <div>
                                    <div className="flex items-center justify-between mb-6">
                                        <h3 className={`text-2xl font-black ${textColor} flex items-center gap-3`}>
                                            <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${theme === 'dark' ? 'bg-emerald-500/20' : 'bg-emerald-100'}`}>
                                                <Share2 className={`w-6 h-6 ${theme === 'dark' ? 'text-emerald-400' : 'text-emerald-500'}`} />
                                            </div>
                                            Share to Peers
                                        </h3>
                                        <button onClick={() => { setShareConfirm(null); setShareMessage(''); }} className={`p-2 rounded-xl ${theme === 'dark' ? 'hover:bg-slate-700' : 'hover:bg-slate-100'}`}>
                                            <X className="w-5 h-5" />
                                        </button>
                                    </div>

                                    {/* Item Preview */}
                                    <div className={`p-4 rounded-2xl mb-5 ${theme === 'dark' ? 'bg-slate-900/50 border border-slate-700' : 'bg-slate-50 border border-slate-200'}`}>
                                        <div className="flex items-center gap-2 mb-2">
                                            <span className={`text-xs uppercase tracking-wider font-bold px-2 py-0.5 rounded ${theme === 'dark' ? 'bg-indigo-500/20 text-indigo-400' : 'bg-indigo-100 text-indigo-600'}`}>
                                                {shareConfirm.type === 'voca' ? 'Vocabulary' : shareConfirm.type === 'synonym' ? 'Synonyms' : shareConfirm.type === 'antonym' ? 'Antonyms' : 'Phrase'}
                                            </span>
                                        </div>
                                        <p className={`font-bold text-lg ${textColor}`}>"{shareConfirm.mainText}"</p>
                                        {shareConfirm.context && <p className={`text-sm mt-1 ${textSub}`}>{shareConfirm.context}</p>}
                                        {shareConfirm.related && shareConfirm.related.length > 0 && (
                                            <p className={`text-sm mt-1 ${theme === 'dark' ? 'text-violet-400' : 'text-violet-600'}`}>
                                                {shareConfirm.type === 'antonym' ? 'â†” ' : 'â†’ '}{shareConfirm.related.join(', ')}
                                            </p>
                                        )}
                                    </div>

                                    {/* Custom Message Input */}
                                    <div className="mb-6">
                                        <label className={`text-xs uppercase tracking-widest pl-1 mb-2 block ${labelClass}`}>Your Message</label>
                                        <textarea
                                            value={shareMessage}
                                            onChange={(e) => setShareMessage(e.target.value)}
                                            placeholder="Write something about this word or phrase to share with others..."
                                            rows="3"
                                            className={`w-full p-4 rounded-2xl outline-none font-medium resize-none transition-all ${inputClass}`}
                                            autoFocus
                                        />
                                        <p className={`text-xs mt-2 ${textSub}`}>Add context, examples, or tips to help others learn!</p>
                                    </div>

                                    <div className="flex gap-3 justify-end">
                                        <button
                                            onClick={() => { setShareConfirm(null); setShareMessage(''); }}
                                            className={`px-6 py-3 rounded-2xl font-bold transition-all hover:scale-105 active:scale-95 ${theme === 'dark' ? 'bg-slate-700 text-slate-300 hover:bg-slate-600' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onClick={confirmShare}
                                            disabled={!shareMessage.trim()}
                                            className={`px-6 py-3 rounded-2xl font-bold transition-all flex items-center gap-2 ${shareMessage.trim() ? 'bg-gradient-to-r from-emerald-500 to-teal-500 text-white hover:from-emerald-600 hover:to-teal-600 hover:scale-105 active:scale-95 shadow-lg shadow-emerald-500/25' : 'bg-slate-300 text-slate-500 cursor-not-allowed'}`}
                                        >
                                            <Send className="w-4 h-4" />
                                            Share to Peers
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Delete Confirmation Modal for Single Item */}
                    {deleteConfirmItem && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] flex items-center justify-center p-4 animate-in fade-in duration-200" onClick={() => setDeleteConfirmItem(null)}>
                            <div className={`${theme === 'dark' ? 'bg-slate-800/95 border-slate-700' : 'bg-white/95 border-slate-200'} p-8 rounded-3xl max-w-md w-full shadow-2xl border backdrop-blur-xl animate-in zoom-in-95 duration-300`} onClick={e => e.stopPropagation()}>
                                <div className="text-center">
                                    <div className={`w-16 h-16 mx-auto mb-5 rounded-full flex items-center justify-center ${theme === 'dark' ? 'bg-red-500/20' : 'bg-red-100'}`}>
                                        <Trash2 className={`w-8 h-8 ${theme === 'dark' ? 'text-red-400' : 'text-red-500'}`} />
                                    </div>
                                    <h3 className={`text-2xl font-black mb-3 ${theme === 'dark' ? 'text-white' : 'text-slate-800'}`}>Delete Word?</h3>
                                    <p className={`mb-4 ${theme === 'dark' ? 'text-slate-400' : 'text-slate-600'}`}>
                                        Are you sure you want to delete this word?
                                    </p>
                                    <div className={`p-3 rounded-xl mb-6 ${theme === 'dark' ? 'bg-slate-900/50' : 'bg-slate-50'}`}>
                                        <p className={`font-bold text-lg ${theme === 'dark' ? 'text-white' : 'text-slate-800'}`}>"{deleteConfirmItem.mainText}"</p>
                                        {deleteConfirmItem.context && <p className={`text-sm mt-1 ${theme === 'dark' ? 'text-slate-400' : 'text-slate-500'}`}>{deleteConfirmItem.context}</p>}
                                    </div>
                                    <p className={`text-sm mb-6 ${theme === 'dark' ? 'text-slate-500' : 'text-slate-400'}`}>This action cannot be undone.</p>
                                    <div className="flex gap-3 justify-center">
                                        <button
                                            onClick={() => setDeleteConfirmItem(null)}
                                            className={`px-6 py-3 rounded-2xl font-bold transition-all hover:scale-105 active:scale-95 ${theme === 'dark' ? 'bg-slate-700 text-slate-300 hover:bg-slate-600' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onClick={confirmDeleteItem}
                                            className="px-6 py-3 rounded-2xl font-bold bg-gradient-to-r from-red-500 to-rose-500 text-white hover:from-red-600 hover:to-rose-600 transition-all hover:scale-105 active:scale-95 shadow-lg shadow-red-500/25 flex items-center gap-2"
                                        >
                                            <Trash2 className="w-4 h-4" />
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- PEERS COMPONENT - SOCIAL LEARNING ---
        // Guidelines: Every user can create posts. All posts are visible to everyone (no friend restriction).
        // Users can edit and delete their own posts.
        const Peers = ({ user, theme, onViewProfile }) => {
            const [posts, setPosts] = useState([]);
            const [newPost, setNewPost] = useState('');
            const [postType, setPostType] = useState('general'); // general, vocabulary, phrase, tip
            const [isPosting, setIsPosting] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [selectedPostId, setSelectedPostId] = useState(null);

            // State for showing inline comments directly under posts
            const [expandedComments, setExpandedComments] = useState({});
            const [inlineComments, setInlineComments] = useState({});
            const [loadingComments, setLoadingComments] = useState({});

            // Lightbox state for fullscreen image viewing
            const [lightboxImage, setLightboxImage] = useState(null);

            // Edit post state
            const [editingPost, setEditingPost] = useState(null);
            const [editContent, setEditContent] = useState('');
            const [editType, setEditType] = useState('general');
            const [isUpdating, setIsUpdating] = useState(false);

            // Delete confirmation state
            const [deleteConfirm, setDeleteConfirm] = useState(null);

            // Derive selectedPost from posts array - this keeps it in sync without causing re-renders
            const selectedPost = useMemo(() => posts.find(p => p.id === selectedPostId), [posts, selectedPostId]);

            const cardBg = theme === 'dark' ? 'glass-panel-dark' : 'glass-panel-light';
            const textColor = theme === 'dark' ? 'text-white' : 'text-slate-800';
            const textSub = theme === 'dark' ? 'text-gray-400' : 'text-slate-500';
            const inputClass = theme === 'dark'
                ? 'bg-slate-950/50 border border-slate-700 text-slate-100 placeholder:text-slate-500 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/50'
                : 'bg-white border border-slate-200 text-slate-800 placeholder:text-slate-400 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/50';

            const postTypes = [
                { id: 'general', label: 'General', icon: MessagesSquare, color: 'from-slate-500 to-slate-600' },
                { id: 'vocabulary', label: 'New Word', icon: Book, color: 'from-indigo-500 to-blue-500' },
                { id: 'phrase', label: 'Phrase', icon: MessageCircle, color: 'from-amber-500 to-orange-500' },
                { id: 'tip', label: 'Learning Tip', icon: Sparkles, color: 'from-emerald-500 to-teal-500' },
            ];

            // Load posts
            useEffect(() => {
                const q = query(
                    collection(db, 'artifacts', appId, 'peerPosts'),
                    orderBy('createdAt', 'desc'),
                    limit(50)
                );
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const postsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setPosts(postsData);
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // Create new post
            const handleCreatePost = async () => {
                if (!newPost.trim() || !user) return;
                setIsPosting(true);
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'peerPosts'), {
                        content: newPost.trim(),
                        type: postType,
                        authorId: user.uid,
                        authorName: user.displayName || 'Anonymous',
                        authorPhoto: user.photoURL || null,
                        createdAt: Date.now(),
                        likes: [],
                        likeCount: 0,
                        commentCount: 0
                    });
                    setNewPost('');
                    setPostType('general');
                } catch (err) {
                    console.error('Error creating post:', err);
                }
                setIsPosting(false);
            };

            // Toggle like
            const handleLike = async (post) => {
                if (!user) return;
                const postRef = doc(db, 'artifacts', appId, 'peerPosts', post.id);
                const likes = post.likes || [];
                const hasLiked = likes.includes(user.uid);

                try {
                    await updateDoc(postRef, {
                        likes: hasLiked
                            ? likes.filter(id => id !== user.uid)
                            : [...likes, user.uid],
                        likeCount: hasLiked ? (post.likeCount || 1) - 1 : (post.likeCount || 0) + 1
                    });
                } catch (err) {
                    console.error('Error toggling like:', err);
                }
            };

            // Edit post - open edit modal
            const openEditPost = (post) => {
                setEditingPost(post);
                setEditContent(post.content);
                setEditType(post.type);
            };

            // Update post
            const handleUpdatePost = async () => {
                if (!editContent.trim() || !user || !editingPost) return;
                if (editingPost.authorId !== user.uid) return; // Only author can edit

                setIsUpdating(true);
                try {
                    const postRef = doc(db, 'artifacts', appId, 'peerPosts', editingPost.id);
                    await updateDoc(postRef, {
                        content: editContent.trim(),
                        type: editType,
                        editedAt: Date.now()
                    });
                    setEditingPost(null);
                    setEditContent('');
                } catch (err) {
                    console.error('Error updating post:', err);
                }
                setIsUpdating(false);
            };

            // Delete post (author or admin can delete)
            const handleDeletePost = async (postId) => {
                if (!user) return;
                const post = posts.find(p => p.id === postId);
                // Allow deletion if user is the author OR if user is admin
                if (!post || (post.authorId !== user.uid && !isAdmin(user))) return;

                try {
                    // If admin is deleting, also delete comments
                    if (isAdmin(user)) {
                        const commentsSnapshot = await getDocs(collection(db, 'artifacts', appId, 'peerPosts', postId, 'comments'));
                        for (const commentDoc of commentsSnapshot.docs) {
                            await deleteDoc(doc(db, 'artifacts', appId, 'peerPosts', postId, 'comments', commentDoc.id));
                        }
                    }
                    await deleteDoc(doc(db, 'artifacts', appId, 'peerPosts', postId));
                    setDeleteConfirm(null);
                    setSelectedPostId(null);
                } catch (err) {
                    console.error('Error deleting post:', err);
                }
            };

            const formatTime = (timestamp) => {
                if (!timestamp) return '';
                const diff = Date.now() - timestamp;
                const mins = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);

                if (mins < 1) return 'Just now';
                if (mins < 60) return `${mins}m ago`;
                if (hours < 24) return `${hours}h ago`;
                if (days < 7) return `${days}d ago`;
                return new Date(timestamp).toLocaleDateString();
            };

            const getPostTypeInfo = (type) => postTypes.find(t => t.id === type) || postTypes[0];

            // Toggle and load inline comments for a post
            const toggleInlineComments = async (postId) => {
                if (expandedComments[postId]) {
                    // Collapse comments
                    setExpandedComments(prev => ({ ...prev, [postId]: false }));
                    return;
                }

                // Expand and load comments if not already loaded
                setExpandedComments(prev => ({ ...prev, [postId]: true }));

                if (!inlineComments[postId]) {
                    setLoadingComments(prev => ({ ...prev, [postId]: true }));
                    try {
                        const q = query(
                            collection(db, 'artifacts', appId, 'peerPosts', postId, 'comments'),
                            orderBy('createdAt', 'asc')
                        );
                        const snapshot = await getDocs(q);
                        const comments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setInlineComments(prev => ({ ...prev, [postId]: comments }));
                    } catch (err) {
                        console.error('Error loading comments:', err);
                    }
                    setLoadingComments(prev => ({ ...prev, [postId]: false }));
                }
            };

            // Real-time listener for inline comments
            useEffect(() => {
                const unsubscribers = [];
                Object.keys(expandedComments).forEach(postId => {
                    if (expandedComments[postId]) {
                        const q = query(
                            collection(db, 'artifacts', appId, 'peerPosts', postId, 'comments'),
                            orderBy('createdAt', 'asc')
                        );
                        const unsub = onSnapshot(q, (snapshot) => {
                            const comments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setInlineComments(prev => ({ ...prev, [postId]: comments }));
                        });
                        unsubscribers.push(unsub);
                    }
                });
                return () => unsubscribers.forEach(unsub => unsub());
            }, [expandedComments]);

            // Lightbox component for fullscreen images
            const ImageLightbox = ({ imageUrl, onClose }) => (
                <div
                    className="fixed inset-0 z-[300] lightbox-overlay flex items-center justify-center p-4 cursor-zoom-out"
                    onClick={onClose}
                >
                    <button
                        className="absolute top-4 right-4 p-3 rounded-full bg-white/10 text-white hover:bg-white/20 transition-colors z-10"
                        onClick={onClose}
                    >
                        <X className="w-6 h-6" />
                    </button>
                    <img
                        src={imageUrl}
                        alt="Full size"
                        className="lightbox-image animate-lightbox-in"
                        onClick={(e) => e.stopPropagation()}
                    />
                </div>
            );

            // Post Detail Modal - with local state for comments to prevent parent re-renders
            const PostDetailModal = () => {
                const [comments, setComments] = useState([]);
                const [loadingComments, setLoadingComments] = useState(true);
                const [commentText, setCommentText] = useState('');
                const [isCommenting, setIsCommenting] = useState(false);

                // Comment edit/delete state
                const [editingComment, setEditingComment] = useState(null);
                const [editCommentText, setEditCommentText] = useState('');
                const [deleteCommentConfirm, setDeleteCommentConfirm] = useState(null);

                // Track view when modal opens
                useEffect(() => {
                    if (!selectedPostId || !user) return;

                    // Add view (only once per user per post)
                    const trackView = async () => {
                        try {
                            const postRef = doc(db, 'artifacts', appId, 'peerPosts', selectedPostId);
                            const currentPost = posts.find(p => p.id === selectedPostId);
                            const viewers = currentPost?.viewers || [];

                            // Only add if user hasn't viewed before
                            if (!viewers.includes(user.uid)) {
                                await updateDoc(postRef, {
                                    viewers: [...viewers, user.uid],
                                    viewCount: (currentPost?.viewCount || 0) + 1
                                });
                            }
                        } catch (err) {
                            console.error('Error tracking view:', err);
                        }
                    };
                    trackView();
                }, [selectedPostId, user?.uid]);

                useEffect(() => {
                    if (!selectedPostId) return;
                    setLoadingComments(true);
                    const q = query(
                        collection(db, 'artifacts', appId, 'peerPosts', selectedPostId, 'comments'),
                        orderBy('createdAt', 'asc')
                    );
                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        setComments(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        setLoadingComments(false);
                    });
                    return () => unsubscribe();
                }, [selectedPostId]);

                // Handle adding comment - local to modal
                const handleAddComment = async () => {
                    if (!commentText.trim() || !user || !selectedPostId) return;
                    setIsCommenting(true);
                    try {
                        await addDoc(collection(db, 'artifacts', appId, 'peerPosts', selectedPostId, 'comments'), {
                            content: commentText.trim(),
                            authorId: user.uid,
                            authorName: user.displayName || 'Anonymous',
                            authorPhoto: user.photoURL || null,
                            createdAt: Date.now()
                        });

                        // Update comment count
                        const postRef = doc(db, 'artifacts', appId, 'peerPosts', selectedPostId);
                        const currentPost = posts.find(p => p.id === selectedPostId);
                        await updateDoc(postRef, {
                            commentCount: (currentPost?.commentCount || 0) + 1
                        });

                        setCommentText('');
                    } catch (err) {
                        console.error('Error adding comment:', err);
                    }
                    setIsCommenting(false);
                };

                // Edit comment
                const handleEditComment = async () => {
                    if (!editCommentText.trim() || !editingComment || !selectedPostId) return;
                    try {
                        const commentRef = doc(db, 'artifacts', appId, 'peerPosts', selectedPostId, 'comments', editingComment.id);
                        await updateDoc(commentRef, {
                            content: editCommentText.trim(),
                            editedAt: Date.now()
                        });
                        setEditingComment(null);
                        setEditCommentText('');
                    } catch (err) {
                        console.error('Error editing comment:', err);
                    }
                };

                // Delete comment
                const handleDeleteComment = async (commentId) => {
                    if (!selectedPostId) return;
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'peerPosts', selectedPostId, 'comments', commentId));

                        // Update comment count
                        const postRef = doc(db, 'artifacts', appId, 'peerPosts', selectedPostId);
                        const currentPost = posts.find(p => p.id === selectedPostId);
                        await updateDoc(postRef, {
                            commentCount: Math.max((currentPost?.commentCount || 1) - 1, 0)
                        });

                        setDeleteCommentConfirm(null);
                    } catch (err) {
                        console.error('Error deleting comment:', err);
                    }
                };

                if (!selectedPost) return null;

                const typeInfo = getPostTypeInfo(selectedPost.type);
                const hasLiked = selectedPost.likes?.includes(user?.uid);
                const isAuthor = selectedPost.authorId === user?.uid;
                const canModerate = isAuthor || isAdmin(user); // Admin can also moderate

                return (
                    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-end sm:items-center justify-center sm:p-4" onClick={() => setSelectedPostId(null)}>
                        <div className={`${theme === 'dark' ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'} rounded-t-3xl sm:rounded-3xl max-w-2xl w-full shadow-2xl border animate-messenger-open max-h-[90vh] sm:max-h-[85vh] overflow-hidden flex flex-col`} onClick={e => e.stopPropagation()}>
                            {/* Header */}
                            <div className={`p-4 sm:p-6 border-b ${theme === 'dark' ? 'border-slate-700' : 'border-slate-100'}`}>
                                <div className="flex items-start justify-between gap-2">
                                    <div className="flex items-center gap-2 sm:gap-3 min-w-0">
                                        {selectedPost.authorPhoto ? (
                                            <img src={selectedPost.authorPhoto} className="w-10 h-10 sm:w-12 sm:h-12 rounded-full flex-shrink-0" alt="" />
                                        ) : (
                                            <div className={`w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-gradient-to-br from-indigo-500 to-violet-500 flex items-center justify-center text-white font-bold text-base sm:text-lg flex-shrink-0`}>
                                                {selectedPost.authorName?.charAt(0) || '?'}
                                            </div>
                                        )}
                                        <div className="min-w-0">
                                            <div className="flex items-center gap-1 sm:gap-2 flex-wrap">
                                                <span className={`font-bold text-sm sm:text-base truncate ${textColor}`}>{selectedPost.authorName}</span>
                                                {selectedPost.editedAt && <span className={`text-[10px] sm:text-xs ${textSub}`}>(edited)</span>}
                                            </div>
                                            <div className={`text-xs sm:text-sm ${textSub}`}>{formatTime(selectedPost.createdAt)}</div>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-1 sm:gap-2 flex-shrink-0">
                                        {/* Edit button - only for author */}
                                        {isAuthor && (
                                            <button
                                                onClick={() => { setSelectedPostId(null); openEditPost(selectedPost); }}
                                                className={`p-1.5 sm:p-2 rounded-lg sm:rounded-xl transition-all ${theme === 'dark' ? 'hover:bg-slate-700 text-slate-400 hover:text-indigo-400' : 'hover:bg-slate-100 text-slate-500 hover:text-indigo-600'}`}
                                                title="Edit post"
                                            >
                                                <Pencil className="w-4 h-4 sm:w-5 sm:h-5" />
                                            </button>
                                        )}
                                        {/* Delete button - for author or admin */}
                                        {canModerate && (
                                            <button
                                                onClick={() => setDeleteConfirm(selectedPost)}
                                                className={`p-1.5 sm:p-2 rounded-lg sm:rounded-xl transition-all ${theme === 'dark' ? 'hover:bg-rose-500/20 text-slate-400 hover:text-rose-400' : 'hover:bg-rose-50 text-slate-500 hover:text-rose-600'}`}
                                                title={isAdmin(user) && !isAuthor ? "Delete post (Admin)" : "Delete post"}
                                            >
                                                <Trash2 className="w-4 h-4 sm:w-5 sm:h-5" />
                                            </button>
                                        )}
                                        <button onClick={() => setSelectedPostId(null)} className={`p-1.5 sm:p-2 rounded-lg sm:rounded-xl ${theme === 'dark' ? 'hover:bg-slate-700' : 'hover:bg-slate-100'}`}>
                                            <X className="w-4 h-4 sm:w-5 sm:h-5" />
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Content */}
                            <div className="p-4 sm:p-6 flex-1 overflow-y-auto">
                                <div className={`inline-flex items-center gap-1 sm:gap-1.5 px-2.5 sm:px-3 py-1 sm:py-1.5 rounded-full bg-gradient-to-r ${typeInfo.color} text-white text-[10px] sm:text-xs font-bold mb-3 sm:mb-4`}>
                                    <typeInfo.icon className="w-3 h-3 sm:w-3.5 sm:h-3.5" />
                                    {typeInfo.label}
                                </div>

                                {/* Shared Item Card in Modal */}
                                {selectedPost.sharedItem && (
                                    <div className={`p-3 sm:p-4 rounded-xl sm:rounded-2xl border mb-3 sm:mb-4 ${theme === 'dark' ? 'bg-slate-900/50 border-slate-700' : 'bg-slate-50 border-slate-200'}`}>
                                        <div className="flex items-center gap-2 mb-2">
                                            <span className={`text-[10px] sm:text-xs uppercase tracking-wider font-bold px-1.5 sm:px-2 py-0.5 rounded ${selectedPost.sharedItem.type === 'voca' ? (theme === 'dark' ? 'bg-indigo-500/20 text-indigo-400' : 'bg-indigo-100 text-indigo-600') :
                                                selectedPost.sharedItem.type === 'synonym' ? (theme === 'dark' ? 'bg-violet-500/20 text-violet-400' : 'bg-violet-100 text-violet-600') :
                                                    selectedPost.sharedItem.type === 'antonym' ? (theme === 'dark' ? 'bg-rose-500/20 text-rose-400' : 'bg-rose-100 text-rose-600') :
                                                        (theme === 'dark' ? 'bg-amber-500/20 text-amber-400' : 'bg-amber-100 text-amber-600')
                                                }`}>
                                                {selectedPost.sharedItem.type === 'voca' ? 'Vocabulary' : selectedPost.sharedItem.type === 'synonym' ? 'Synonyms' : selectedPost.sharedItem.type === 'antonym' ? 'Antonyms' : 'Phrase'}
                                            </span>
                                        </div>
                                        <p className={`font-bold text-base sm:text-lg ${textColor}`}>"{selectedPost.sharedItem.mainText}"</p>
                                        {selectedPost.sharedItem.context && <p className={`text-xs sm:text-sm mt-1 ${textSub}`}>{selectedPost.sharedItem.context}</p>}
                                        {selectedPost.sharedItem.related && selectedPost.sharedItem.related.length > 0 && (
                                            <p className={`text-xs sm:text-sm mt-1 font-medium ${selectedPost.sharedItem.type === 'antonym' ? 'text-rose-500' : 'text-violet-500'}`}>
                                                {selectedPost.sharedItem.type === 'antonym' ? 'â†” ' : 'â†’ '}{selectedPost.sharedItem.related.join(', ')}
                                            </p>
                                        )}
                                    </div>
                                )}

                                <p className={`text-base sm:text-lg leading-relaxed ${textColor}`}>{selectedPost.content}</p>

                                {/* Actions */}
                                <div className={`flex items-center gap-2 sm:gap-4 mt-4 sm:mt-6 pt-3 sm:pt-4 border-t ${theme === 'dark' ? 'border-slate-700' : 'border-slate-100'}`}>
                                    <button
                                        onClick={() => handleLike(selectedPost)}
                                        className={`flex items-center gap-1.5 sm:gap-2 px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg sm:rounded-xl transition-all text-sm ${hasLiked
                                            ? 'bg-rose-500/20 text-rose-500'
                                            : theme === 'dark' ? 'bg-slate-700/50 text-slate-300 hover:bg-slate-700' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                            }`}
                                    >
                                        <Heart className={`w-4 h-4 sm:w-5 sm:h-5 ${hasLiked ? 'fill-rose-500 animate-like-heart' : ''}`} />
                                        <span className="font-bold">{selectedPost.likeCount || 0}</span>
                                    </button>
                                    <div className={`flex items-center gap-1.5 sm:gap-2 px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg sm:rounded-xl text-sm ${theme === 'dark' ? 'bg-slate-700/50 text-slate-300' : 'bg-slate-100 text-slate-600'}`}>
                                        <MessageSquare className="w-4 h-4 sm:w-5 sm:h-5" />
                                        <span className="font-bold">{selectedPost.commentCount || 0}</span>
                                    </div>
                                    <div className={`flex items-center gap-1.5 sm:gap-2 px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg sm:rounded-xl text-sm ${theme === 'dark' ? 'bg-slate-700/50 text-slate-300' : 'bg-slate-100 text-slate-600'}`} title="Views">
                                        <Eye className="w-4 h-4 sm:w-5 sm:h-5" />
                                        <span className="font-bold">{selectedPost.viewCount || 0}</span>
                                    </div>
                                </div>

                                {/* Comments Section */}
                                <div className="mt-6">
                                    <h4 className={`font-bold ${textColor} mb-4`}>Comments</h4>
                                    {loadingComments ? (
                                        <div className="flex justify-center py-8">
                                            <Loader2 className="w-6 h-6 animate-spin text-indigo-500" />
                                        </div>
                                    ) : comments.length === 0 ? (
                                        <div className={`text-center py-8 ${textSub}`}>
                                            <MessageSquare className="w-8 h-8 mx-auto mb-2 opacity-30" />
                                            <p>No comments yet. Be the first!</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            {comments.map(comment => {
                                                const isCommentAuthor = comment.authorId === user?.uid;

                                                return (
                                                    <div key={comment.id} className={`flex gap-3 p-3 rounded-2xl group relative ${theme === 'dark' ? 'bg-slate-900/50' : 'bg-slate-50'}`}>
                                                        {comment.authorPhoto ? (
                                                            <img src={comment.authorPhoto} className="w-8 h-8 rounded-full" alt="" />
                                                        ) : (
                                                            <div className="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-400 to-violet-400 flex items-center justify-center text-white text-xs font-bold">
                                                                {comment.authorName?.charAt(0) || '?'}
                                                            </div>
                                                        )}
                                                        <div className="flex-1">
                                                            <div className="flex items-center gap-2">
                                                                <span className={`font-bold text-sm ${textColor}`}>{comment.authorName}</span>
                                                                {comment.editedAt && <span className={`text-[10px] ${textSub}`}>(edited)</span>}
                                                                <span className={`text-xs ${textSub}`}>{formatTime(comment.createdAt)}</span>
                                                            </div>

                                                            {/* Edit mode */}
                                                            {editingComment?.id === comment.id ? (
                                                                <div className="mt-2">
                                                                    <input
                                                                        type="text"
                                                                        value={editCommentText}
                                                                        onChange={e => setEditCommentText(e.target.value)}
                                                                        className={`w-full px-3 py-2 rounded-lg text-sm outline-none ${inputClass}`}
                                                                        autoFocus
                                                                        onKeyPress={e => e.key === 'Enter' && handleEditComment()}
                                                                    />
                                                                    <div className="flex gap-2 mt-2">
                                                                        <button onClick={() => { setEditingComment(null); setEditCommentText(''); }} className={`px-3 py-1 rounded-lg text-xs font-bold ${theme === 'dark' ? 'bg-slate-700 text-slate-300' : 'bg-slate-200 text-slate-600'}`}>Cancel</button>
                                                                        <button onClick={handleEditComment} className="px-3 py-1 rounded-lg text-xs font-bold bg-indigo-500 text-white">Save</button>
                                                                    </div>
                                                                </div>
                                                            ) : (
                                                                <p className={`text-sm mt-1 ${theme === 'dark' ? 'text-slate-300' : 'text-slate-600'}`}>{comment.content}</p>
                                                            )}
                                                        </div>

                                                        {/* Edit/Delete buttons for comment author */}
                                                        {isCommentAuthor && !editingComment && (
                                                            <div className={`absolute top-2 right-2 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity`}>
                                                                <button
                                                                    onClick={() => { setEditingComment(comment); setEditCommentText(comment.content); }}
                                                                    className={`p-1.5 rounded-lg transition-all ${theme === 'dark' ? 'hover:bg-slate-700 text-slate-400' : 'hover:bg-slate-200 text-slate-500'}`}
                                                                    title="Edit"
                                                                >
                                                                    <Pencil className="w-3.5 h-3.5" />
                                                                </button>
                                                                <button
                                                                    onClick={() => setDeleteCommentConfirm(comment)}
                                                                    className={`p-1.5 rounded-lg transition-all ${theme === 'dark' ? 'hover:bg-rose-500/20 text-slate-400 hover:text-rose-400' : 'hover:bg-rose-50 text-slate-500 hover:text-rose-600'}`}
                                                                    title="Delete"
                                                                >
                                                                    <Trash2 className="w-3.5 h-3.5" />
                                                                </button>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>

                                {/* Delete Comment Confirmation */}
                                {deleteCommentConfirm && (
                                    <div className={`mt-4 p-4 rounded-2xl border ${theme === 'dark' ? 'bg-rose-500/10 border-rose-500/30' : 'bg-rose-50 border-rose-200'}`}>
                                        <p className={`text-sm font-medium ${theme === 'dark' ? 'text-rose-300' : 'text-rose-700'} mb-3`}>Delete this comment?</p>
                                        <div className="flex gap-2">
                                            <button onClick={() => setDeleteCommentConfirm(null)} className={`px-4 py-2 rounded-xl text-sm font-bold ${theme === 'dark' ? 'bg-slate-700 text-slate-300' : 'bg-white text-slate-600'}`}>Cancel</button>
                                            <button onClick={() => handleDeleteComment(deleteCommentConfirm.id)} className="px-4 py-2 rounded-xl text-sm font-bold bg-rose-500 text-white">Delete</button>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Comment Input */}
                            <div className={`p-3 sm:p-4 border-t ${theme === 'dark' ? 'border-slate-700' : 'border-slate-100'}`}>
                                <div className="flex gap-2 sm:gap-3">
                                    <input
                                        type="text"
                                        value={commentText}
                                        onChange={e => setCommentText(e.target.value)}
                                        placeholder="Write a comment..."
                                        className={`flex-1 px-3 sm:px-4 py-2.5 sm:py-3 rounded-lg sm:rounded-xl outline-none text-sm sm:text-base ${inputClass}`}
                                        onKeyPress={e => e.key === 'Enter' && handleAddComment()}
                                    />
                                    <button
                                        onClick={handleAddComment}
                                        disabled={!commentText.trim() || isCommenting}
                                        className="px-3 sm:px-5 py-2.5 sm:py-3 rounded-lg sm:rounded-xl font-bold bg-gradient-to-r from-indigo-500 to-violet-500 text-white disabled:opacity-50 transition-all hover:from-indigo-600 hover:to-violet-600"
                                    >
                                        {isCommenting ? <Loader2 className="w-4 h-4 sm:w-5 sm:h-5 animate-spin" /> : <Send className="w-4 h-4 sm:w-5 sm:h-5" />}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="space-y-4 sm:space-y-8 animate-in slide-in-from-right-4 duration-500 pt-40 sm:pt-40 pb-12 max-w-3xl mx-auto px-3 sm:px-4">
                    {/* Create Post Section */}
                    <div className={`${cardBg} rounded-2xl sm:rounded-[2.5rem] p-4 sm:p-6 shadow-xl`}>
                        <div className="flex items-start gap-3 sm:gap-4">
                            {user?.photoURL ? (
                                <img src={user.photoURL} className="w-10 h-10 sm:w-12 sm:h-12 rounded-full flex-shrink-0" alt="" />
                            ) : (
                                <div className="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-gradient-to-br from-indigo-500 to-violet-500 flex items-center justify-center text-white font-bold text-base sm:text-lg flex-shrink-0">
                                    {user?.displayName?.charAt(0) || '?'}
                                </div>
                            )}
                            <div className="flex-1 min-w-0">
                                <textarea
                                    value={newPost}
                                    onChange={e => setNewPost(e.target.value)}
                                    placeholder="Share what you've learned today..."
                                    rows="3"
                                    className={`w-full px-3 sm:px-4 py-2.5 sm:py-3 rounded-xl sm:rounded-2xl outline-none resize-none text-sm sm:text-base ${inputClass}`}
                                />

                                <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mt-3 sm:mt-4">
                                    <div className="flex gap-1.5 sm:gap-2 overflow-x-auto pb-1 no-scrollbar -mx-1 px-1">
                                        {postTypes.map(type => (
                                            <button
                                                key={type.id}
                                                onClick={() => setPostType(type.id)}
                                                className={`flex items-center gap-1 sm:gap-1.5 px-2.5 sm:px-3 py-1.5 sm:py-2 rounded-lg sm:rounded-xl text-[10px] sm:text-xs font-bold transition-all whitespace-nowrap flex-shrink-0 ${postType === type.id
                                                    ? `bg-gradient-to-r ${type.color} text-white shadow-md`
                                                    : theme === 'dark' ? 'bg-slate-700/50 text-slate-300 hover:bg-slate-700' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                                    }`}
                                            >
                                                <type.icon className="w-3 h-3 sm:w-3.5 sm:h-3.5" />
                                                <span className="hidden xs:inline sm:inline">{type.label}</span>
                                            </button>
                                        ))}
                                    </div>
                                    <button
                                        onClick={handleCreatePost}
                                        disabled={!newPost.trim() || isPosting}
                                        className="w-full sm:w-auto px-4 sm:px-6 py-2.5 rounded-xl font-bold bg-gradient-to-r from-indigo-500 to-violet-500 text-white disabled:opacity-50 transition-all hover:from-indigo-600 hover:to-violet-600 active:scale-95 flex items-center justify-center gap-2 text-sm"
                                    >
                                        {isPosting ? <Loader2 className="w-4 h-4 animate-spin" /> : <Send className="w-4 h-4" />}
                                        Post
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Posts Feed */}
                    {isLoading ? (
                        <div className="flex justify-center py-12 sm:py-16">
                            <Loader2 className="w-6 h-6 sm:w-8 sm:h-8 animate-spin text-indigo-500" />
                        </div>
                    ) : posts.length === 0 ? (
                        <div className={`${cardBg} rounded-2xl sm:rounded-[2.5rem] p-8 sm:p-12 text-center shadow-xl`}>
                            <Users className={`w-12 h-12 sm:w-16 sm:h-16 mx-auto mb-3 sm:mb-4 ${textSub} opacity-30`} />
                            <h3 className={`text-lg sm:text-xl font-bold ${textColor} mb-2`}>No posts yet</h3>
                            <p className={`text-sm sm:text-base ${textSub}`}>Be the first to share what you've learned!</p>
                        </div>
                    ) : (
                        <div className="space-y-3 sm:space-y-4">
                            {posts.map((post, index) => {
                                const typeInfo = getPostTypeInfo(post.type);
                                const hasLiked = post.likes?.includes(user?.uid);
                                const isPostAuthor = post.authorId === user?.uid;

                                return (
                                    <div
                                        key={post.id}
                                        className={`${cardBg} rounded-2xl sm:rounded-[2rem] p-4 sm:p-6 shadow-lg hover:shadow-xl transition-all duration-300 animate-post-in cursor-pointer group relative`}
                                        style={{ animationDelay: `${index * 50}ms` }}
                                        onClick={() => setSelectedPostId(post.id)}
                                    >
                                        {/* Edit/Delete buttons for author - shown on hover (desktop) or always visible (mobile) */}
                                        {isPostAuthor && (
                                            <div className={`absolute top-3 sm:top-4 right-3 sm:right-4 flex items-center gap-1 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity`}>
                                                <button
                                                    onClick={(e) => { e.stopPropagation(); openEditPost(post); }}
                                                    className={`p-1.5 sm:p-2 rounded-lg transition-all ${theme === 'dark' ? 'bg-slate-700/80 hover:bg-slate-600 text-slate-300' : 'bg-white/80 hover:bg-slate-100 text-slate-600'} shadow-sm`}
                                                    title="Edit"
                                                >
                                                    <Pencil className="w-3.5 h-3.5 sm:w-4 sm:h-4" />
                                                </button>
                                                <button
                                                    onClick={(e) => { e.stopPropagation(); setDeleteConfirm(post); }}
                                                    className={`p-1.5 sm:p-2 rounded-lg transition-all ${theme === 'dark' ? 'bg-slate-700/80 hover:bg-rose-500/30 text-slate-300 hover:text-rose-400' : 'bg-white/80 hover:bg-rose-50 text-slate-600 hover:text-rose-600'} shadow-sm`}
                                                    title="Delete"
                                                >
                                                    <Trash2 className="w-3.5 h-3.5 sm:w-4 sm:h-4" />
                                                </button>
                                            </div>
                                        )}

                                        <div className="flex items-start gap-3 sm:gap-4">
                                            <button
                                                onClick={(e) => { e.stopPropagation(); onViewProfile && onViewProfile({ uid: post.authorId, displayName: post.authorName, photoURL: post.authorPhoto }); }}
                                                className="flex-shrink-0 hover:opacity-80 transition-opacity"
                                                title={`View ${post.authorName}'s profile`}
                                            >
                                                {post.authorPhoto ? (
                                                    <img src={post.authorPhoto} className="w-9 h-9 sm:w-11 sm:h-11 rounded-full ring-2 ring-indigo-500/20" alt="" />
                                                ) : (
                                                    <div className="w-9 h-9 sm:w-11 sm:h-11 rounded-full bg-gradient-to-br from-indigo-500 to-violet-500 flex items-center justify-center text-white font-bold text-sm sm:text-base">
                                                        {post.authorName?.charAt(0) || '?'}
                                                    </div>
                                                )}
                                            </button>
                                            <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-1.5 sm:gap-2 flex-wrap pr-16 sm:pr-20">
                                                    <button
                                                        onClick={(e) => { e.stopPropagation(); onViewProfile && onViewProfile({ uid: post.authorId, displayName: post.authorName, photoURL: post.authorPhoto }); }}
                                                        className={`font-bold text-sm sm:text-base ${textColor} hover:text-indigo-500 transition-colors`}
                                                        title={`View ${post.authorName}'s profile`}
                                                    >
                                                        {post.authorName}
                                                    </button>
                                                    {post.editedAt && <span className={`text-[10px] sm:text-xs ${textSub}`}>(edited)</span>}
                                                    <span className={`text-[10px] sm:text-xs ${textSub}`}>â€¢</span>
                                                    <span className={`text-[10px] sm:text-xs ${textSub}`}>{formatTime(post.createdAt)}</span>
                                                </div>

                                                <div className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-gradient-to-r ${typeInfo.color} text-white text-[9px] sm:text-[10px] font-bold mt-1`}>
                                                    <typeInfo.icon className="w-2.5 h-2.5 sm:w-3 sm:h-3" />
                                                    {typeInfo.label}
                                                </div>

                                                {/* Shared Item Card */}
                                                {post.sharedItem && (
                                                    <div className={`mt-2 sm:mt-3 p-2.5 sm:p-3 rounded-lg sm:rounded-xl border ${theme === 'dark' ? 'bg-slate-900/50 border-slate-700' : 'bg-slate-50 border-slate-200'}`}>
                                                        <div className="flex items-center gap-2 mb-1">
                                                            <span className={`text-[9px] sm:text-[10px] uppercase tracking-wider font-bold px-1.5 py-0.5 rounded ${post.sharedItem.type === 'voca' ? (theme === 'dark' ? 'bg-indigo-500/20 text-indigo-400' : 'bg-indigo-100 text-indigo-600') :
                                                                post.sharedItem.type === 'synonym' ? (theme === 'dark' ? 'bg-violet-500/20 text-violet-400' : 'bg-violet-100 text-violet-600') :
                                                                    post.sharedItem.type === 'antonym' ? (theme === 'dark' ? 'bg-rose-500/20 text-rose-400' : 'bg-rose-100 text-rose-600') :
                                                                        (theme === 'dark' ? 'bg-amber-500/20 text-amber-400' : 'bg-amber-100 text-amber-600')
                                                                }`}>
                                                                {post.sharedItem.type === 'voca' ? 'Word' : post.sharedItem.type === 'synonym' ? 'Synonyms' : post.sharedItem.type === 'antonym' ? 'Antonyms' : 'Phrase'}
                                                            </span>
                                                        </div>
                                                        <p className={`font-bold text-sm sm:text-base ${textColor}`}>"{post.sharedItem.mainText}"</p>
                                                        {post.sharedItem.context && <p className={`text-xs sm:text-sm mt-1 ${textSub}`}>{post.sharedItem.context}</p>}
                                                        {post.sharedItem.related && post.sharedItem.related.length > 0 && (
                                                            <p className={`text-xs sm:text-sm mt-1 ${post.sharedItem.type === 'antonym' ? 'text-rose-500' : 'text-violet-500'}`}>
                                                                {post.sharedItem.type === 'antonym' ? 'â†” ' : 'â†’ '}{post.sharedItem.related.join(', ')}
                                                            </p>
                                                        )}
                                                    </div>
                                                )}

                                                <p className={`mt-2 sm:mt-3 text-sm sm:text-base ${textColor} leading-relaxed line-clamp-4`}>{post.content}</p>

                                                <div className={`flex items-center gap-3 sm:gap-4 mt-3 sm:mt-4 pt-2.5 sm:pt-3 border-t ${theme === 'dark' ? 'border-slate-700/50' : 'border-slate-100'}`}>
                                                    <button
                                                        onClick={(e) => { e.stopPropagation(); handleLike(post); }}
                                                        className={`flex items-center gap-1 sm:gap-1.5 text-xs sm:text-sm font-medium transition-all ${hasLiked ? 'text-rose-500' : textSub + ' hover:text-rose-500'
                                                            }`}
                                                    >
                                                        <Heart className={`w-3.5 h-3.5 sm:w-4 sm:h-4 ${hasLiked ? 'fill-rose-500 animate-like-heart' : ''}`} />
                                                        {post.likeCount || 0}
                                                    </button>
                                                    <button
                                                        onClick={(e) => { e.stopPropagation(); toggleInlineComments(post.id); }}
                                                        className={`flex items-center gap-1 sm:gap-1.5 text-xs sm:text-sm font-medium transition-all ${expandedComments[post.id] ? 'text-indigo-500' : textSub + ' hover:text-indigo-500'
                                                            }`}
                                                    >
                                                        <MessageSquare className="w-3.5 h-3.5 sm:w-4 sm:h-4" />
                                                        {post.commentCount || 0}
                                                        <ChevronDown className={`w-3 h-3 transition-transform ${expandedComments[post.id] ? 'rotate-180' : ''}`} />
                                                    </button>
                                                    <span className={`flex items-center gap-1 sm:gap-1.5 text-xs sm:text-sm font-medium ${textSub}`} title="Views">
                                                        <Eye className="w-3.5 h-3.5 sm:w-4 sm:h-4" />
                                                        {post.viewCount || 0}
                                                    </span>
                                                </div>

                                                {/* Inline Comments Section - Displayed directly under post */}
                                                {expandedComments[post.id] && (
                                                    <div className={`mt-3 pt-3 border-t ${theme === 'dark' ? 'border-slate-700/50' : 'border-slate-100'}`} onClick={(e) => e.stopPropagation()}>
                                                        {loadingComments[post.id] ? (
                                                            <div className="flex justify-center py-4">
                                                                <Loader2 className="w-5 h-5 animate-spin text-indigo-500" />
                                                            </div>
                                                        ) : (inlineComments[post.id]?.length || 0) === 0 ? (
                                                            <p className={`text-xs ${textSub} text-center py-3`}>No comments yet. Click on the post to add one!</p>
                                                        ) : (
                                                            <div className="space-y-2">
                                                                {inlineComments[post.id]?.slice(0, 3).map(comment => (
                                                                    <div key={comment.id} className={`flex gap-2 p-2 rounded-xl ${theme === 'dark' ? 'bg-slate-800/50' : 'bg-slate-50/80'}`}>
                                                                        {comment.authorPhoto ? (
                                                                            <img src={comment.authorPhoto} className="w-6 h-6 rounded-full flex-shrink-0" alt="" />
                                                                        ) : (
                                                                            <div className="w-6 h-6 rounded-full bg-gradient-to-br from-indigo-400 to-violet-400 flex items-center justify-center text-white text-[10px] font-bold flex-shrink-0">
                                                                                {comment.authorName?.charAt(0) || '?'}
                                                                            </div>
                                                                        )}
                                                                        <div className="flex-1 min-w-0">
                                                                            <div className="flex items-center gap-1.5">
                                                                                <span className={`font-semibold text-xs ${textColor}`}>{comment.authorName}</span>
                                                                                <span className={`text-[10px] ${textSub}`}>{formatTime(comment.createdAt)}</span>
                                                                            </div>
                                                                            <p className={`text-xs ${theme === 'dark' ? 'text-slate-300' : 'text-slate-600'} mt-0.5 break-words`}>{comment.content}</p>
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                                {(inlineComments[post.id]?.length || 0) > 3 && (
                                                                    <button
                                                                        onClick={() => setSelectedPostId(post.id)}
                                                                        className={`w-full text-center text-xs font-medium py-2 rounded-lg transition-colors ${theme === 'dark' ? 'text-indigo-400 hover:bg-slate-800' : 'text-indigo-600 hover:bg-slate-100'}`}
                                                                    >
                                                                        View all {inlineComments[post.id]?.length} comments â†’
                                                                    </button>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {/* Post Detail Modal */}
                    <PostDetailModal />

                    {/* Edit Post Modal */}
                    {editingPost && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-end sm:items-center justify-center sm:p-4" onClick={() => setEditingPost(null)}>
                            <div className={`${theme === 'dark' ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'} rounded-t-3xl sm:rounded-3xl max-w-xl w-full shadow-2xl border animate-messenger-open p-4 sm:p-6 max-h-[90vh] overflow-y-auto`} onClick={e => e.stopPropagation()}>
                                <div className="flex items-center justify-between mb-4 sm:mb-6">
                                    <h3 className={`text-lg sm:text-xl font-bold ${textColor} flex items-center gap-2`}>
                                        <Pencil className="w-4 h-4 sm:w-5 sm:h-5 text-indigo-500" />
                                        Edit Post
                                    </h3>
                                    <button onClick={() => setEditingPost(null)} className={`p-1.5 sm:p-2 rounded-lg sm:rounded-xl ${theme === 'dark' ? 'hover:bg-slate-700' : 'hover:bg-slate-100'}`}>
                                        <X className="w-4 h-4 sm:w-5 sm:h-5" />
                                    </button>
                                </div>

                                <textarea
                                    value={editContent}
                                    onChange={e => setEditContent(e.target.value)}
                                    placeholder="What's on your mind?"
                                    rows="4"
                                    className={`w-full px-3 sm:px-4 py-2.5 sm:py-3 rounded-xl sm:rounded-2xl outline-none resize-none text-sm sm:text-base ${inputClass}`}
                                />

                                {/* Shared item preview (read-only) */}
                                {editingPost.sharedItem && (
                                    <div className={`mt-3 sm:mt-4 p-2.5 sm:p-3 rounded-lg sm:rounded-xl border ${theme === 'dark' ? 'bg-slate-900/50 border-slate-700' : 'bg-slate-50 border-slate-200'}`}>
                                        <div className={`text-[10px] sm:text-xs ${textSub} mb-1`}>Shared item (cannot be changed)</div>
                                        <p className={`font-bold text-sm sm:text-base ${textColor}`}>"{editingPost.sharedItem.mainText}"</p>
                                    </div>
                                )}

                                <div className="mt-3 sm:mt-4">
                                    <div className="flex gap-1.5 sm:gap-2 overflow-x-auto pb-1 no-scrollbar -mx-1 px-1">
                                        {postTypes.map(type => (
                                            <button
                                                key={type.id}
                                                onClick={() => setEditType(type.id)}
                                                className={`flex items-center gap-1 sm:gap-1.5 px-2.5 sm:px-3 py-1.5 sm:py-2 rounded-lg sm:rounded-xl text-[10px] sm:text-xs font-bold transition-all whitespace-nowrap flex-shrink-0 ${editType === type.id
                                                    ? `bg-gradient-to-r ${type.color} text-white shadow-md`
                                                    : theme === 'dark' ? 'bg-slate-700/50 text-slate-300 hover:bg-slate-700' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                                    }`}
                                            >
                                                <type.icon className="w-3 h-3 sm:w-3.5 sm:h-3.5" />
                                                <span className="hidden xs:inline sm:inline">{type.label}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div className="flex gap-2 sm:gap-3 mt-4 sm:mt-6">
                                    <button
                                        onClick={() => setEditingPost(null)}
                                        className={`flex-1 px-4 sm:px-6 py-2.5 sm:py-3 rounded-xl font-bold text-sm sm:text-base transition-all ${theme === 'dark' ? 'bg-slate-700 text-slate-300 hover:bg-slate-600' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={handleUpdatePost}
                                        disabled={!editContent.trim() || isUpdating}
                                        className="flex-1 px-4 sm:px-6 py-2.5 sm:py-3 rounded-xl font-bold text-sm sm:text-base bg-gradient-to-r from-indigo-500 to-violet-500 text-white disabled:opacity-50 transition-all hover:from-indigo-600 hover:to-violet-600 flex items-center justify-center gap-2"
                                    >
                                        {isUpdating ? <Loader2 className="w-4 h-4 sm:w-5 sm:h-5 animate-spin" /> : <Save className="w-4 h-4 sm:w-5 sm:h-5" />}
                                        <span className="hidden sm:inline">Save Changes</span>
                                        <span className="sm:hidden">Save</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Lightbox for fullscreen image viewing */}
                    {lightboxImage && <ImageLightbox imageUrl={lightboxImage} onClose={() => setLightboxImage(null)} />}

                    {/* Delete Confirmation Modal */}
                    {deleteConfirm && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[110] flex items-end sm:items-center justify-center sm:p-4" onClick={() => setDeleteConfirm(null)}>
                            <div className={`${theme === 'dark' ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'} rounded-t-3xl sm:rounded-3xl max-w-md w-full shadow-2xl border animate-messenger-open p-6 sm:p-8`} onClick={e => e.stopPropagation()}>
                                <div className="text-center">
                                    <div className={`w-12 h-12 sm:w-16 sm:h-16 mx-auto mb-4 sm:mb-5 rounded-full flex items-center justify-center ${theme === 'dark' ? 'bg-rose-500/20' : 'bg-rose-100'}`}>
                                        <Trash2 className={`w-6 h-6 sm:w-8 sm:h-8 ${theme === 'dark' ? 'text-rose-400' : 'text-rose-500'}`} />
                                    </div>
                                    <h3 className={`text-xl sm:text-2xl font-black mb-2 sm:mb-3 ${textColor}`}>Delete Post?</h3>
                                    <p className={`text-sm sm:text-base mb-4 sm:mb-6 ${textSub}`}>This action cannot be undone. Your post and all its comments will be permanently removed.</p>
                                    <div className="flex gap-2 sm:gap-3 justify-center">
                                        <button
                                            onClick={() => setDeleteConfirm(null)}
                                            className={`px-4 sm:px-6 py-2.5 sm:py-3 rounded-xl sm:rounded-2xl font-bold text-sm sm:text-base transition-all hover:scale-105 active:scale-95 ${theme === 'dark' ? 'bg-slate-700 text-slate-300 hover:bg-slate-600' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onClick={() => handleDeletePost(deleteConfirm.id)}
                                            className="px-4 sm:px-6 py-2.5 sm:py-3 rounded-xl sm:rounded-2xl font-bold text-sm sm:text-base bg-gradient-to-r from-rose-500 to-red-500 text-white hover:from-rose-600 hover:to-red-600 transition-all hover:scale-105 active:scale-95 shadow-lg shadow-rose-500/25 flex items-center gap-2"
                                        >
                                            <Trash2 className="w-4 h-4" />
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ReviewSession = ({ dueItems, onClose, onComplete, mode = 'srs', theme }) => {
            const [localIndex, setLocalIndex] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);

            const currentItem = mode === 'srs' ? dueItems[0] : dueItems[localIndex];
            const totalDue = dueItems.length;

            if (!currentItem && mode === 'srs') {
                return (
                    <div className="fixed inset-0 bg-slate-900/90 z-[200] flex items-center justify-center backdrop-blur-md p-4">
                        <div className={`${theme === 'dark' ? 'bg-slate-800 text-white border-slate-700' : 'bg-white text-slate-800'} p-10 rounded-3xl max-w-md w-full text-center animate-in zoom-in-95 shadow-2xl border`}>
                            <div className="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6"><Check className="w-12 h-12 text-green-600" /></div>
                            <h2 className="text-3xl font-black mb-2">You are done with the revision!</h2>
                            <p className={`${theme === 'dark' ? 'text-gray-400' : 'text-slate-500'} mb-8 text-lg`}>Great job keeping your vocabulary fresh.</p>
                            <button onClick={onClose} className="bg-slate-900 text-white px-8 py-4 rounded-xl font-bold text-lg hover:bg-slate-800 w-full transition-transform active:scale-95">Return to Dashboard</button>
                        </div>
                    </div>
                );
            }

            if (mode === 'flashcard' && localIndex >= totalDue) {
                return (
                    <div className="fixed inset-0 bg-slate-900/90 z-[200] flex items-center justify-center backdrop-blur-md p-4">
                        <div className={`${theme === 'dark' ? 'bg-slate-800 text-white border-slate-700' : 'bg-white text-slate-800'} p-10 rounded-3xl max-w-md w-full text-center animate-in zoom-in-95 shadow-2xl border`}>
                            <div className="w-24 h-24 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-6"><Check className="w-12 h-12 text-indigo-600" /></div>
                            <h2 className="text-3xl font-black mb-2">You are done!</h2>
                            <p className={`${theme === 'dark' ? 'text-gray-400' : 'text-slate-500'} mb-8 text-lg`}>Great job reviewing.</p>
                            <button onClick={onClose} className="bg-slate-900 text-white px-8 py-4 rounded-xl font-bold text-lg hover:bg-slate-800 w-full transition-transform active:scale-95">Finish</button>
                        </div>
                    </div>
                );
            }

            const handleSRSRate = (rating) => {
                const { interval, easiness } = calculateNextReview(rating, currentItem.interval || 0, currentItem.easiness || 2.5);
                const nextReviewDate = Date.now() + (interval * 24 * 60 * 60 * 1000);
                onComplete(currentItem.id, { interval, easiness, nextReview: nextReviewDate });
                setIsFlipped(false);
            };

            const handleFlashcardNext = () => { setLocalIndex(prev => prev + 1); setIsFlipped(false); };
            const handleBack = () => { if (localIndex > 0) { setLocalIndex(prev => prev - 1); setIsFlipped(false); } };

            const cardBg = theme === 'dark' ? 'bg-slate-800' : 'bg-white';
            const textColor = theme === 'dark' ? 'text-white' : 'text-slate-800';

            return (
                <div className="fixed inset-0 bg-slate-900/95 z-[200] flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="w-full max-w-2xl flex flex-col h-[70vh]">
                        <div className="flex justify-between items-center text-white mb-4 px-2">
                            <div className="flex items-center gap-4">
                                {mode === 'flashcard' && localIndex > 0 && (
                                    <button onClick={handleBack} className="p-2 hover:bg-white/10 rounded-full transition-colors"><ArrowLeft className="w-6 h-6" /></button>
                                )}
                                <span className="font-bold opacity-70">{mode === 'srs' ? `${totalDue} Cards Remaining` : `Card ${localIndex + 1} / ${totalDue}`}</span>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-white/10 rounded-full transition-colors"><X className="w-6 h-6" /></button>
                        </div>
                        <div className={`flex-1 ${cardBg} rounded-3xl shadow-2xl relative overflow-hidden flex flex-col transition-colors duration-300`}>
                            <div className="flex-1 flex flex-col items-center justify-center text-center p-8 md:p-12">
                                <span className="inline-block px-3 py-1 rounded-full bg-slate-100 text-slate-500 text-xs font-bold tracking-widest uppercase mb-6">{currentItem.type}</span>
                                <h2 className={`text-4xl md:text-5xl font-black mb-6 leading-tight ${textColor}`}>{currentItem.mainText}</h2>
                                {currentItem.type === 'phrase' && <div className="bg-indigo-50 text-indigo-700 px-4 py-2 rounded-lg font-medium text-sm border border-indigo-100 flex items-center gap-2"><MessageCircle className="w-4 h-4" /> Context: {currentItem.context}</div>}
                            </div>
                            {isFlipped && (
                                <div className={`${theme === 'dark' ? 'bg-slate-900 border-slate-700' : 'bg-slate-50 border-slate-100'} border-t p-8 animate-in slide-in-from-bottom-10 fade-in duration-300 absolute inset-0 flex flex-col items-center justify-center z-10`}>
                                    <div className="text-center">
                                        <div className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">The Answer Is</div>
                                        {currentItem.type === 'voca' && (
                                            <div className="space-y-4">
                                                <div className={`text-2xl font-medium leading-relaxed ${theme === 'dark' ? 'text-indigo-300' : 'text-indigo-700'}`}>{currentItem.context}</div>
                                                {currentItem.ipa && <div className="text-sm font-mono text-slate-400">{currentItem.ipa}</div>}
                                                {currentItem.example && <div className="text-slate-500 italic">"{currentItem.example}"</div>}
                                            </div>
                                        )}
                                        {currentItem.type === 'synonym' && <div className="text-3xl font-bold text-indigo-600 leading-relaxed">{currentItem.related?.join(', ')}</div>}
                                        {currentItem.type === 'antonym' && <div className="text-4xl font-bold text-rose-600">{currentItem.related?.[0]}</div>}
                                        {currentItem.type === 'phrase' && <div className="text-xl text-indigo-700 italic font-medium max-w-lg">"Repeat this phrase out loud with proper emotion. Visualize the {currentItem.context} situation."</div>}
                                    </div>
                                </div>
                            )}
                            <div className={`p-6 ${cardBg} border-t ${theme === 'dark' ? 'border-slate-700' : 'border-slate-100'} z-20`}>
                                {!isFlipped ? (
                                    <button onClick={() => setIsFlipped(true)} className="w-full bg-indigo-600 text-white py-5 rounded-2xl font-bold text-xl hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all active:scale-95">Reveal Answer</button>
                                ) : (
                                    <div className="w-full">
                                        {mode === 'srs' ? (
                                            <div className="grid grid-cols-3 gap-4">
                                                <button onClick={() => handleSRSRate(1)} className="group bg-rose-50 text-rose-700 py-4 rounded-2xl font-bold border border-rose-100 hover:bg-rose-100 hover:border-rose-200 transition-all active:scale-95"><span className="block text-xs opacity-50 uppercase mb-1 group-hover:opacity-100">Reset</span>Forgot</button>
                                                <button onClick={() => handleSRSRate(3)} className="group bg-amber-50 text-amber-700 py-4 rounded-2xl font-bold border border-amber-100 hover:bg-amber-100 hover:border-amber-200 transition-all active:scale-95"><span className="block text-xs opacity-50 uppercase mb-1 group-hover:opacity-100">Soon</span>Hard</button>
                                                <button onClick={() => handleSRSRate(5)} className="group bg-emerald-50 text-emerald-700 py-4 rounded-2xl font-bold border border-emerald-100 hover:bg-emerald-100 hover:border-emerald-200 transition-all active:scale-95"><span className="block text-xs opacity-50 uppercase mb-1 group-hover:opacity-100">4 Days</span>Easy</button>
                                            </div>
                                        ) : (
                                            <div className="grid grid-cols-2 gap-4">
                                                <button onClick={handleBack} disabled={localIndex === 0} className={`bg-slate-100 text-slate-600 py-4 rounded-2xl font-bold border border-slate-200 hover:bg-slate-200 transition-all active:scale-95 flex items-center justify-center gap-2 ${localIndex === 0 ? 'opacity-50 cursor-not-allowed' : ''}`}><ArrowLeft className="w-5 h-5" /> Back</button>
                                                <button onClick={handleFlashcardNext} className="bg-indigo-600 text-white py-4 rounded-2xl font-bold hover:bg-indigo-700 transition-all active:scale-95 flex items-center justify-center gap-2">Next <Play className="w-5 h-5" /></button>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Custom Confirmation Modal Component
        const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message, confirmText = "Delete All", theme }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] flex items-center justify-center p-4 animate-in fade-in duration-200" onClick={onClose}>
                    <div className={`${theme === 'dark' ? 'bg-slate-800/95 border-slate-700' : 'bg-white/95 border-slate-200'} p-8 rounded-3xl max-w-md w-full shadow-2xl border backdrop-blur-xl animate-in zoom-in-95 duration-300`} onClick={e => e.stopPropagation()}>
                        <div className="text-center">
                            <div className={`w-16 h-16 mx-auto mb-5 rounded-full flex items-center justify-center ${theme === 'dark' ? 'bg-red-500/20' : 'bg-red-100'}`}>
                                <Trash2 className={`w-8 h-8 ${theme === 'dark' ? 'text-red-400' : 'text-red-500'}`} />
                            </div>
                            <h3 className={`text-2xl font-black mb-3 ${theme === 'dark' ? 'text-white' : 'text-slate-800'}`}>{title}</h3>
                            <p className={`mb-8 ${theme === 'dark' ? 'text-slate-400' : 'text-slate-600'}`}>{message}</p>
                            <div className="flex gap-3 justify-center">
                                <button
                                    onClick={onClose}
                                    className={`px-6 py-3 rounded-2xl font-bold transition-all hover:scale-105 active:scale-95 ${theme === 'dark' ? 'bg-slate-700 text-slate-300 hover:bg-slate-600' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={onConfirm}
                                    className="px-6 py-3 rounded-2xl font-bold bg-gradient-to-r from-red-500 to-rose-500 text-white hover:from-red-600 hover:to-rose-600 transition-all hover:scale-105 active:scale-95 shadow-lg shadow-red-500/25 flex items-center gap-2"
                                >
                                    <Trash2 className="w-4 h-4" />
                                    {confirmText}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Toast Notification Component
        const Toast = ({ message, type = 'info', onClose, theme }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 4000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const icons = {
                info: <Sparkles className="w-5 h-5" />,
                success: <Check className="w-5 h-5" />,
                warning: <AlertTriangle className="w-5 h-5" />,
                error: <X className="w-5 h-5" />
            };

            const colors = {
                info: theme === 'dark'
                    ? 'bg-indigo-500/20 border-indigo-500/30 text-indigo-300'
                    : 'bg-indigo-50 border-indigo-200 text-indigo-700',
                success: theme === 'dark'
                    ? 'bg-emerald-500/20 border-emerald-500/30 text-emerald-300'
                    : 'bg-emerald-50 border-emerald-200 text-emerald-700',
                warning: theme === 'dark'
                    ? 'bg-amber-500/20 border-amber-500/30 text-amber-300'
                    : 'bg-amber-50 border-amber-200 text-amber-700',
                error: theme === 'dark'
                    ? 'bg-red-500/20 border-red-500/30 text-red-300'
                    : 'bg-red-50 border-red-200 text-red-700'
            };

            const iconBg = {
                info: theme === 'dark' ? 'bg-indigo-500/30' : 'bg-indigo-100',
                success: theme === 'dark' ? 'bg-emerald-500/30' : 'bg-emerald-100',
                warning: theme === 'dark' ? 'bg-amber-500/30' : 'bg-amber-100',
                error: theme === 'dark' ? 'bg-red-500/30' : 'bg-red-100'
            };

            return (
                <div className={`${colors[type]} backdrop-blur-xl border rounded-2xl p-4 shadow-2xl flex items-start gap-3 min-w-[320px] max-w-md animate-in slide-in-from-top-2 fade-in duration-300`}>
                    <div className={`${iconBg[type]} p-2 rounded-xl shrink-0`}>
                        {icons[type]}
                    </div>
                    <div className="flex-1 pt-0.5">
                        <p className="font-semibold text-sm leading-relaxed">{message}</p>
                    </div>
                    <button onClick={onClose} className="shrink-0 p-1 rounded-lg hover:bg-black/10 transition-colors opacity-60 hover:opacity-100">
                        <X className="w-4 h-4" />
                    </button>
                </div>
            );
        };

        // Toast Container Component
        const ToastContainer = ({ toasts, removeToast, theme }) => (
            <div className="fixed top-24 left-1/2 -translate-x-1/2 z-[300] flex flex-col gap-3">
                {toasts.map(toast => (
                    <Toast
                        key={toast.id}
                        message={toast.message}
                        type={toast.type}
                        onClose={() => removeToast(toast.id)}
                        theme={theme}
                    />
                ))}
            </div>
        );

        // --- MESSENGER COMPONENT ---
        const Messenger = ({ isOpen, onClose, user, theme, onUnreadChange, onViewProfile }) => {
            const [conversations, setConversations] = useState([]);
            const [activeChat, setActiveChat] = useState(null);
            const [messages, setMessages] = useState([]);
            const [newMessage, setNewMessage] = useState('');
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [isSearching, setIsSearching] = useState(false);
            const [allUsers, setAllUsers] = useState([]);
            const messagesEndRef = useRef(null);
            const [isSending, setIsSending] = useState(false);
            const [activeTab, setActiveTab] = useState('chats'); // 'chats', 'users', or 'friends'
            const [isLoadingUsers, setIsLoadingUsers] = useState(false);
            const [editingMessage, setEditingMessage] = useState(null);
            const [editMessageText, setEditMessageText] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const [otherUserTyping, setOtherUserTyping] = useState(false);
            const [showProfileEdit, setShowProfileEdit] = useState(false);
            const [editDisplayName, setEditDisplayName] = useState('');
            const [isSavingProfile, setIsSavingProfile] = useState(false);
            const typingTimeoutRef = useRef(null);
            const [showDeleteConvoModal, setShowDeleteConvoModal] = useState(false);
            const [isDeletingConvo, setIsDeletingConvo] = useState(false);
            const [friends, setFriends] = useState([]);
            const [friendRequests, setFriendRequests] = useState([]);
            const [sentRequests, setSentRequests] = useState([]);
            const [isLoadingFriends, setIsLoadingFriends] = useState(false);
            const [unreadCounts, setUnreadCounts] = useState({}); // Track unread messages per conversation
            const [selectedImage, setSelectedImage] = useState(null);
            const [imagePreview, setImagePreview] = useState(null);
            const [isUploadingImage, setIsUploadingImage] = useState(false);
            const imageInputRef = useRef(null);
            const [showRemoveFriendModal, setShowRemoveFriendModal] = useState(false);
            const [friendToRemove, setFriendToRemove] = useState(null);
            const [isRemovingFriend, setIsRemovingFriend] = useState(false);

            // Lightbox state for viewing images fullscreen
            const [lightboxImageUrl, setLightboxImageUrl] = useState(null);

            // Scroll to bottom of messages
            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            // Save user profile to users collection when they open messenger
            useEffect(() => {
                if (!user || !isOpen) return;
                const saveUserProfile = async () => {
                    try {
                        await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'info'), {
                            uid: user.uid,
                            displayName: user.displayName || 'Anonymous',
                            photoURL: user.photoURL || '',
                            email: user.email || '',
                            lastSeen: Date.now()
                        }, { merge: true });
                    } catch (err) {
                        console.error('Error saving user profile:', err);
                    }
                };
                saveUserProfile();
            }, [user, isOpen]);

            // Load all users for search
            useEffect(() => {
                if (!user || !isOpen) return;
                setIsLoadingUsers(true);
                const loadUsers = async () => {
                    try {
                        const usersQuery = query(collection(db, 'artifacts', appId, 'chatUsers'));
                        const snapshot = await getDocs(usersQuery);
                        const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(u => u.uid !== user.uid);
                        setAllUsers(users);
                    } catch (err) {
                        console.error('Error loading users:', err);
                    }
                    setIsLoadingUsers(false);
                };
                loadUsers();

                // Also set up real-time listener for users
                const unsubscribe = onSnapshot(
                    query(collection(db, 'artifacts', appId, 'chatUsers')),
                    (snapshot) => {
                        const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(u => u.uid !== user.uid);
                        setAllUsers(users);
                    }
                );
                return () => unsubscribe();
            }, [user, isOpen]);

            // Save user to global chat users list
            useEffect(() => {
                if (!user || !isOpen) return;
                const saveToGlobalUsers = async () => {
                    try {
                        await setDoc(doc(db, 'artifacts', appId, 'chatUsers', user.uid), {
                            uid: user.uid,
                            displayName: user.displayName || 'Anonymous',
                            photoURL: user.photoURL || '',
                            email: user.email || '',
                            lastSeen: Date.now()
                        }, { merge: true });
                    } catch (err) {
                        console.error('Error saving to global users:', err);
                    }
                };
                saveToGlobalUsers();

                // Update lastSeen periodically while messenger is open
                const interval = setInterval(() => {
                    if (isOpen) {
                        setDoc(doc(db, 'artifacts', appId, 'chatUsers', user.uid), {
                            lastSeen: Date.now()
                        }, { merge: true }).catch(err => console.log('Could not update lastSeen'));
                    }
                }, 30000); // Update every 30 seconds

                return () => clearInterval(interval);
            }, [user, isOpen]);

            // Load conversations (always listen, even when closed, for notification count)
            useEffect(() => {
                if (!user) return;
                // Query conversations where user is a participant
                // Note: This query may require a composite index in Firebase Console
                const q = query(
                    collection(db, 'artifacts', appId, 'conversations'),
                    where('participants', 'array-contains', user.uid)
                );
                const unsubscribe = onSnapshot(q, async (snapshot) => {
                    const convosData = await Promise.all(snapshot.docs.map(async (docSnap) => {
                        const data = docSnap.data();
                        const otherUserId = data.participants.find(p => p !== user.uid);
                        // Get other user's profile
                        let otherUser = { displayName: 'Unknown User', photoURL: '', lastSeen: null };
                        try {
                            const userDoc = await getDoc(doc(db, 'artifacts', appId, 'chatUsers', otherUserId));
                            if (userDoc.exists()) {
                                otherUser = userDoc.data();
                            }
                        } catch (err) {
                            console.log('Could not fetch user profile');
                        }
                        return { id: docSnap.id, ...data, otherUser };
                    }));
                    // Sort by lastMessageTime on client side
                    convosData.sort((a, b) => (b.lastMessageTime || 0) - (a.lastMessageTime || 0));
                    setConversations(convosData);
                }, (err) => {
                    console.error('Error loading conversations:', err);
                    // If index error, conversations will just be empty
                });
                return () => unsubscribe();
            }, [user]);

            // Load friends and friend requests
            useEffect(() => {
                if (!user || !isOpen) return;
                setIsLoadingFriends(true);

                // Listen for friends list
                const friendsUnsubscribe = onSnapshot(
                    collection(db, 'artifacts', appId, 'chatUsers', user.uid, 'friends'),
                    async (snapshot) => {
                        const friendsData = await Promise.all(snapshot.docs.map(async (docSnap) => {
                            const friendId = docSnap.id;
                            try {
                                const userDoc = await getDoc(doc(db, 'artifacts', appId, 'chatUsers', friendId));
                                if (userDoc.exists()) {
                                    return { id: friendId, ...userDoc.data(), friendSince: docSnap.data().timestamp };
                                }
                            } catch (err) {
                                console.log('Could not fetch friend profile');
                            }
                            return null;
                        }));
                        setFriends(friendsData.filter(f => f !== null));
                        setIsLoadingFriends(false);
                    }
                );

                // Listen for incoming friend requests
                const requestsUnsubscribe = onSnapshot(
                    collection(db, 'artifacts', appId, 'chatUsers', user.uid, 'friendRequests'),
                    async (snapshot) => {
                        const requestsData = await Promise.all(snapshot.docs.map(async (docSnap) => {
                            const senderId = docSnap.id;
                            try {
                                const userDoc = await getDoc(doc(db, 'artifacts', appId, 'chatUsers', senderId));
                                if (userDoc.exists()) {
                                    return { id: senderId, ...userDoc.data(), requestedAt: docSnap.data().timestamp };
                                }
                            } catch (err) {
                                console.log('Could not fetch requester profile');
                            }
                            return null;
                        }));
                        setFriendRequests(requestsData.filter(r => r !== null));
                    }
                );

                // Listen for sent friend requests
                const sentUnsubscribe = onSnapshot(
                    collection(db, 'artifacts', appId, 'chatUsers', user.uid, 'sentRequests'),
                    (snapshot) => {
                        setSentRequests(snapshot.docs.map(doc => doc.id));
                    }
                );

                return () => {
                    friendsUnsubscribe();
                    requestsUnsubscribe();
                    sentUnsubscribe();
                };
            }, [user, isOpen]);

            // Load messages for active chat
            useEffect(() => {
                if (!activeChat) return;
                const q = query(
                    collection(db, 'artifacts', appId, 'conversations', activeChat.id, 'messages'),
                    orderBy('timestamp', 'asc')
                );
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const msgs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setMessages(msgs);
                }, (err) => console.error('Error loading messages:', err));
                return () => unsubscribe();
            }, [activeChat]);

            // Listen for typing indicator
            useEffect(() => {
                if (!activeChat || !user) return;
                const typingRef = doc(db, 'artifacts', appId, 'conversations', activeChat.id, 'typing', activeChat.otherUser?.uid || 'unknown');
                const unsubscribe = onSnapshot(typingRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        // Only show typing if it's recent (within 3 seconds)
                        setOtherUserTyping(data.isTyping && (Date.now() - data.timestamp) < 3000);
                    } else {
                        setOtherUserTyping(false);
                    }
                });
                return () => unsubscribe();
            }, [activeChat, user]);

            // Update typing status
            const updateTypingStatus = async (typing) => {
                if (!activeChat || !user) return;
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'conversations', activeChat.id, 'typing', user.uid), {
                        isTyping: typing,
                        timestamp: Date.now()
                    });
                } catch (err) {
                    console.log('Could not update typing status');
                }
            };

            // Handle typing with debounce
            const handleTyping = (e) => {
                setNewMessage(e.target.value);

                if (!isTyping) {
                    setIsTyping(true);
                    updateTypingStatus(true);
                }

                // Clear existing timeout
                if (typingTimeoutRef.current) {
                    clearTimeout(typingTimeoutRef.current);
                }

                // Set new timeout to stop typing indicator
                typingTimeoutRef.current = setTimeout(() => {
                    setIsTyping(false);
                    updateTypingStatus(false);
                }, 2000);
            };

            // Save profile name
            const saveProfileName = async () => {
                if (!editDisplayName.trim() || !user) return;
                setIsSavingProfile(true);
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'chatUsers', user.uid), {
                        displayName: editDisplayName.trim(),
                        lastSeen: Date.now()
                    }, { merge: true });
                    setShowProfileEdit(false);
                } catch (err) {
                    console.error('Error saving profile:', err);
                }
                setIsSavingProfile(false);
            };

            // Delete message
            const deleteMessage = async (msgId) => {
                if (!activeChat) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'conversations', activeChat.id, 'messages', msgId));
                } catch (err) {
                    console.error('Error deleting message:', err);
                }
            };

            // Edit message
            const startEditMessage = (msg) => {
                setEditingMessage(msg.id);
                setEditMessageText(msg.text);
            };

            const saveEditMessage = async () => {
                if (!editMessageText.trim() || !editingMessage || !activeChat) return;
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'conversations', activeChat.id, 'messages', editingMessage), {
                        text: editMessageText.trim(),
                        edited: true,
                        editedAt: Date.now()
                    });
                    setEditingMessage(null);
                    setEditMessageText('');
                } catch (err) {
                    console.error('Error editing message:', err);
                }
            };

            const cancelEditMessage = () => {
                setEditingMessage(null);
                setEditMessageText('');
            };

            // Search users
            const handleSearch = async () => {
                if (!searchQuery.trim()) {
                    setSearchResults([]);
                    return;
                }
                setIsSearching(true);
                try {
                    const searchLower = searchQuery.toLowerCase();
                    const results = allUsers.filter(u =>
                        u.displayName?.toLowerCase().includes(searchLower) ||
                        u.email?.toLowerCase().includes(searchLower)
                    );
                    setSearchResults(results);
                } catch (err) {
                    console.error('Search error:', err);
                }
                setIsSearching(false);
            };

            useEffect(() => {
                const debounce = setTimeout(() => {
                    handleSearch();
                }, 300);
                return () => clearTimeout(debounce);
            }, [searchQuery, allUsers]);

            // Start or open conversation
            const startConversation = async (otherUser) => {
                if (!user || !otherUser) return;

                // Handle both uid and id (for friend objects)
                const otherUserId = otherUser.uid || otherUser.id;

                // Check if conversation already exists
                const existingConvo = conversations.find(c =>
                    c.participants.includes(otherUserId)
                );

                if (existingConvo) {
                    setActiveChat(existingConvo);
                    setSearchQuery('');
                    setSearchResults([]);
                    setActiveTab('chats'); // Switch to chats tab
                    return;
                }

                // Create new conversation
                try {
                    const convoRef = await addDoc(collection(db, 'artifacts', appId, 'conversations'), {
                        participants: [user.uid, otherUserId],
                        lastMessage: '',
                        lastMessageTime: Date.now(),
                        createdAt: Date.now()
                    });

                    setActiveChat({
                        id: convoRef.id,
                        participants: [user.uid, otherUserId],
                        otherUser: { ...otherUser, uid: otherUserId }
                    });
                    setSearchQuery('');
                    setSearchResults([]);
                    setActiveTab('chats'); // Switch to chats tab
                } catch (err) {
                    console.error('Error creating conversation:', err);
                }
            };

            // Send message
            const sendMessage = async (e) => {
                e.preventDefault();
                if (!newMessage.trim() || !activeChat || isSending) return;

                setIsSending(true);
                const messageText = newMessage.trim();
                setNewMessage('');

                // Clear typing status
                setIsTyping(false);
                updateTypingStatus(false);
                if (typingTimeoutRef.current) {
                    clearTimeout(typingTimeoutRef.current);
                }

                try {
                    // Add message to subcollection
                    await addDoc(collection(db, 'artifacts', appId, 'conversations', activeChat.id, 'messages'), {
                        text: messageText,
                        senderId: user.uid,
                        senderName: user.displayName || 'Anonymous',
                        senderPhoto: user.photoURL || '',
                        timestamp: Date.now(),
                        read: false,
                        readAt: null
                    });

                    // Update conversation's last message
                    await updateDoc(doc(db, 'artifacts', appId, 'conversations', activeChat.id), {
                        lastMessage: messageText,
                        lastMessageTime: Date.now(),
                        lastSenderId: user.uid
                    });
                } catch (err) {
                    console.error('Error sending message:', err);
                    setNewMessage(messageText);
                }
                setIsSending(false);
            };

            const formatTime = (timestamp) => {
                if (!timestamp) return '';
                const date = new Date(timestamp);
                const now = new Date();
                const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

                if (diffDays === 0) {
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } else if (diffDays === 1) {
                    return 'Yesterday';
                } else if (diffDays < 7) {
                    return date.toLocaleDateString([], { weekday: 'short' });
                }
                return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
            };

            // Delete entire conversation
            const deleteConversation = async () => {
                if (!activeChat) return;
                setIsDeletingConvo(true);
                try {
                    // Delete all messages in the conversation
                    const messagesRef = collection(db, 'artifacts', appId, 'conversations', activeChat.id, 'messages');
                    const messagesSnap = await getDocs(messagesRef);
                    const deletePromises = messagesSnap.docs.map(docSnap =>
                        deleteDoc(doc(db, 'artifacts', appId, 'conversations', activeChat.id, 'messages', docSnap.id))
                    );
                    await Promise.all(deletePromises);

                    // Delete typing subcollection
                    const typingRef = collection(db, 'artifacts', appId, 'conversations', activeChat.id, 'typing');
                    const typingSnap = await getDocs(typingRef);
                    const typingDeletePromises = typingSnap.docs.map(docSnap =>
                        deleteDoc(doc(db, 'artifacts', appId, 'conversations', activeChat.id, 'typing', docSnap.id))
                    );
                    await Promise.all(typingDeletePromises);

                    // Delete the conversation document
                    await deleteDoc(doc(db, 'artifacts', appId, 'conversations', activeChat.id));

                    setActiveChat(null);
                    setMessages([]);
                    setShowDeleteConvoModal(false);
                } catch (err) {
                    console.error('Error deleting conversation:', err);
                }
                setIsDeletingConvo(false);
            };

            // Send friend request
            const sendFriendRequest = async (targetUserId) => {
                if (!user || !targetUserId) return;
                try {
                    // Add to target user's friend requests
                    await setDoc(doc(db, 'artifacts', appId, 'chatUsers', targetUserId, 'friendRequests', user.uid), {
                        timestamp: Date.now()
                    });
                    // Add to sender's sent requests
                    await setDoc(doc(db, 'artifacts', appId, 'chatUsers', user.uid, 'sentRequests', targetUserId), {
                        timestamp: Date.now()
                    });
                } catch (err) {
                    console.error('Error sending friend request:', err);
                }
            };

            // Accept friend request
            const acceptFriendRequest = async (requesterId) => {
                if (!user || !requesterId) return;
                try {
                    // Add each other as friends
                    await setDoc(doc(db, 'artifacts', appId, 'chatUsers', user.uid, 'friends', requesterId), {
                        timestamp: Date.now()
                    });
                    await setDoc(doc(db, 'artifacts', appId, 'chatUsers', requesterId, 'friends', user.uid), {
                        timestamp: Date.now()
                    });

                    // Remove the friend request
                    await deleteDoc(doc(db, 'artifacts', appId, 'chatUsers', user.uid, 'friendRequests', requesterId));
                    // Remove from sender's sent requests
                    await deleteDoc(doc(db, 'artifacts', appId, 'chatUsers', requesterId, 'sentRequests', user.uid));
                } catch (err) {
                    console.error('Error accepting friend request:', err);
                }
            };

            // Reject/cancel friend request
            const rejectFriendRequest = async (requesterId, isSent = false) => {
                if (!user || !requesterId) return;
                try {
                    if (isSent) {
                        // Cancel sent request
                        await deleteDoc(doc(db, 'artifacts', appId, 'chatUsers', requesterId, 'friendRequests', user.uid));
                        await deleteDoc(doc(db, 'artifacts', appId, 'chatUsers', user.uid, 'sentRequests', requesterId));
                    } else {
                        // Reject incoming request
                        await deleteDoc(doc(db, 'artifacts', appId, 'chatUsers', user.uid, 'friendRequests', requesterId));
                        await deleteDoc(doc(db, 'artifacts', appId, 'chatUsers', requesterId, 'sentRequests', user.uid));
                    }
                } catch (err) {
                    console.error('Error rejecting friend request:', err);
                }
            };

            // Open remove friend confirmation modal
            const confirmRemoveFriend = (friend) => {
                setFriendToRemove(friend);
                setShowRemoveFriendModal(true);
            };

            // Remove friend
            const removeFriend = async () => {
                if (!user || !friendToRemove) return;
                setIsRemovingFriend(true);
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'chatUsers', user.uid, 'friends', friendToRemove.id));
                    await deleteDoc(doc(db, 'artifacts', appId, 'chatUsers', friendToRemove.id, 'friends', user.uid));
                    setShowRemoveFriendModal(false);
                    setFriendToRemove(null);
                } catch (err) {
                    console.error('Error removing friend:', err);
                } finally {
                    setIsRemovingFriend(false);
                }
            };

            // Check friendship status
            const getFriendshipStatus = (userId) => {
                if (friends.some(f => f.id === userId)) return 'friends';
                if (sentRequests.includes(userId)) return 'pending';
                if (friendRequests.some(r => r.id === userId)) return 'incoming';
                return 'none';
            };

            // Handle image selection
            const handleImageSelect = (e) => {
                const file = e.target.files?.[0];
                if (!file) return;

                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Image must be less than 5MB');
                    return;
                }

                // Check file type
                if (!file.type.startsWith('image/')) {
                    alert('Please select an image file');
                    return;
                }

                setSelectedImage(file);

                // Create preview
                const reader = new FileReader();
                reader.onloadend = () => {
                    setImagePreview(reader.result);
                };
                reader.readAsDataURL(file);
            };

            // Cancel image selection
            const cancelImageSelect = () => {
                setSelectedImage(null);
                setImagePreview(null);
                if (imageInputRef.current) {
                    imageInputRef.current.value = '';
                }
            };

            // Send image message
            const sendImageMessage = async () => {
                if (!selectedImage || !activeChat || isUploadingImage) return;

                setIsUploadingImage(true);

                try {
                    // Convert image to base64 (for simplicity - in production you'd use Firebase Storage)
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        const base64Image = reader.result;

                        // Add image message to subcollection
                        await addDoc(collection(db, 'artifacts', appId, 'conversations', activeChat.id, 'messages'), {
                            text: '',
                            imageUrl: base64Image,
                            senderId: user.uid,
                            senderName: user.displayName || 'Anonymous',
                            senderPhoto: user.photoURL || '',
                            timestamp: Date.now(),
                            read: false,
                            readAt: null
                        });

                        // Update conversation's last message
                        await updateDoc(doc(db, 'artifacts', appId, 'conversations', activeChat.id), {
                            lastMessage: 'ðŸ“· Image',
                            lastMessageTime: Date.now(),
                            lastSenderId: user.uid
                        });

                        cancelImageSelect();
                    };
                    reader.readAsDataURL(selectedImage);
                } catch (err) {
                    console.error('Error sending image:', err);
                }

                setIsUploadingImage(false);
            };

            // Mark messages as read
            const markMessagesAsRead = async (conversationId) => {
                if (!user || !conversationId) return;

                try {
                    const messagesRef = collection(db, 'artifacts', appId, 'conversations', conversationId, 'messages');
                    const q = query(messagesRef);
                    const snapshot = await getDocs(q);

                    const batch = [];
                    snapshot.docs.forEach(docSnap => {
                        const msg = docSnap.data();
                        // Only mark messages from other users as read
                        if (msg.senderId !== user.uid && !msg.read) {
                            batch.push(
                                updateDoc(doc(db, 'artifacts', appId, 'conversations', conversationId, 'messages', docSnap.id), {
                                    read: true,
                                    readAt: Date.now()
                                })
                            );
                        }
                    });

                    if (batch.length > 0) {
                        await Promise.all(batch);
                    }
                } catch (err) {
                    console.error('Error marking messages as read:', err);
                }
            };

            // Mark messages as read when opening a chat
            useEffect(() => {
                if (activeChat?.id) {
                    markMessagesAsRead(activeChat.id);
                }
            }, [activeChat?.id, messages]);

            // Calculate total unread messages
            const totalUnread = useMemo(() => {
                return Object.values(unreadCounts).reduce((sum, count) => sum + count, 0);
            }, [unreadCounts]);

            // Notify parent of unread count changes
            useEffect(() => {
                if (onUnreadChange) {
                    onUnreadChange(totalUnread);
                }
            }, [totalUnread, onUnreadChange]);

            // Listen for unread messages in all conversations
            useEffect(() => {
                if (!user) return;

                // If no conversations loaded yet, fetch them
                if (conversations.length === 0 && !isOpen) return;

                const unsubscribers = conversations.map(convo => {
                    const messagesRef = collection(db, 'artifacts', appId, 'conversations', convo.id, 'messages');
                    return onSnapshot(messagesRef, (snapshot) => {
                        const unreadCount = snapshot.docs.filter(doc => {
                            const msg = doc.data();
                            return msg.senderId !== user.uid && !msg.read;
                        }).length;

                        setUnreadCounts(prev => ({
                            ...prev,
                            [convo.id]: unreadCount
                        }));
                    });
                });

                return () => {
                    unsubscribers.forEach(unsub => unsub());
                };
            }, [user, conversations]);

            if (!isOpen) return null;

            const panelBg = theme === 'dark' ? 'bg-[#0f172a]/95' : 'bg-white/95';
            const borderColor = theme === 'dark' ? 'border-slate-700/50' : 'border-slate-200';
            const textMain = theme === 'dark' ? 'text-white' : 'text-slate-800';
            const textSub = theme === 'dark' ? 'text-slate-400' : 'text-slate-500';
            const inputBg = theme === 'dark' ? 'bg-slate-800/50 border-slate-700 text-white placeholder:text-slate-500' : 'bg-slate-50 border-slate-200 text-slate-800 placeholder:text-slate-400';
            const hoverBg = theme === 'dark' ? 'hover:bg-slate-800/50' : 'hover:bg-slate-50';
            const activeBg = theme === 'dark' ? 'bg-indigo-500/20' : 'bg-indigo-50';

            return (
                <div className="fixed inset-0 z-[250] flex items-center justify-center bg-black/50 backdrop-blur-sm p-2 md:p-4 animate-in fade-in duration-200" onClick={onClose}>
                    <div
                        className={`${panelBg} backdrop-blur-xl w-full max-w-4xl h-[85vh] md:h-[80vh] rounded-3xl shadow-2xl border ${borderColor} flex overflow-hidden animate-messenger-open relative`}
                        onClick={e => e.stopPropagation()}
                    >
                        {/* Left Panel - Conversations/Users List */}
                        <div className={`${activeChat ? 'hidden md:flex' : 'flex'} w-full md:w-80 border-r ${borderColor} flex-col`}>
                            {/* Header */}
                            <div className={`p-4 border-b ${borderColor}`}>
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className={`text-xl font-black ${textMain} flex items-center gap-2`}>
                                        <MessageSquare className="w-5 h-5 text-indigo-500" />
                                        Messages
                                    </h2>
                                    <button
                                        onClick={onClose}
                                        className={`p-2 rounded-xl ${hoverBg} transition-colors ${textSub}`}
                                    >
                                        <X className="w-5 h-5" />
                                    </button>
                                </div>

                                {/* Tabs */}
                                <div className={`flex gap-1 p-1 rounded-xl mb-3 ${theme === 'dark' ? 'bg-slate-800/50' : 'bg-slate-100'}`}>
                                    <button
                                        onClick={() => setActiveTab('chats')}
                                        className={`flex-1 py-2 px-2 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-1 ${activeTab === 'chats'
                                            ? theme === 'dark'
                                                ? 'bg-indigo-500 text-white shadow-lg'
                                                : 'bg-white text-indigo-600 shadow-md'
                                            : theme === 'dark'
                                                ? 'text-slate-400 hover:text-white'
                                                : 'text-slate-500 hover:text-slate-700'
                                            }`}
                                    >
                                        <MessageCircle className="w-3.5 h-3.5" />
                                        Chats
                                    </button>
                                    <button
                                        onClick={() => setActiveTab('friends')}
                                        className={`flex-1 py-2 px-2 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-1 relative ${activeTab === 'friends'
                                            ? theme === 'dark'
                                                ? 'bg-indigo-500 text-white shadow-lg'
                                                : 'bg-white text-indigo-600 shadow-md'
                                            : theme === 'dark'
                                                ? 'text-slate-400 hover:text-white'
                                                : 'text-slate-500 hover:text-slate-700'
                                            }`}
                                    >
                                        <Heart className="w-3.5 h-3.5" />
                                        Friends
                                        {friendRequests.length > 0 && (
                                            <span className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white text-[10px] rounded-full flex items-center justify-center font-bold animate-pulse">
                                                {friendRequests.length}
                                            </span>
                                        )}
                                    </button>
                                    <button
                                        onClick={() => setActiveTab('users')}
                                        className={`flex-1 py-2 px-2 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-1 ${activeTab === 'users'
                                            ? theme === 'dark'
                                                ? 'bg-indigo-500 text-white shadow-lg'
                                                : 'bg-white text-indigo-600 shadow-md'
                                            : theme === 'dark'
                                                ? 'text-slate-400 hover:text-white'
                                                : 'text-slate-500 hover:text-slate-700'
                                            }`}
                                    >
                                        <Users className="w-3.5 h-3.5" />
                                        Users
                                    </button>
                                </div>

                                {/* Search */}
                                <div className="relative">
                                    <Search className={`absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 ${textSub}`} />
                                    <input
                                        type="text"
                                        placeholder={activeTab === 'chats' ? "Search conversations..." : "Search users..."}
                                        value={searchQuery}
                                        onChange={e => setSearchQuery(e.target.value)}
                                        className={`w-full pl-10 pr-4 py-2.5 rounded-xl border ${inputBg} outline-none focus:ring-2 focus:ring-indigo-500/50 transition-all text-sm`}
                                    />
                                </div>
                            </div>

                            {/* Content based on active tab */}
                            <div className="flex-1 overflow-y-auto">
                                {activeTab === 'friends' ? (
                                    /* Friends Tab */
                                    <div className="p-2">
                                        {isLoadingFriends ? (
                                            <div className={`p-8 text-center ${textSub}`}>
                                                <Loader2 className="w-8 h-8 mx-auto mb-3 animate-spin text-indigo-500" />
                                                <p className="text-sm">Loading friends...</p>
                                            </div>
                                        ) : (
                                            <>
                                                {/* Friend Requests Section */}
                                                {friendRequests.length > 0 && (
                                                    <div className="mb-4">
                                                        <div className={`text-xs font-bold uppercase tracking-wider px-2 py-2 flex items-center gap-2 ${textSub}`}>
                                                            <span className="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                                                            Friend Requests ({friendRequests.length})
                                                        </div>
                                                        {friendRequests.map(request => (
                                                            <div key={request.id} className={`p-3 rounded-xl ${theme === 'dark' ? 'bg-indigo-500/10 border border-indigo-500/20' : 'bg-indigo-50 border border-indigo-100'} mb-2 animate-in slide-in-from-left`}>
                                                                <div className="flex items-center gap-3">
                                                                    <div className="relative">
                                                                        {request.photoURL ? (
                                                                            <img src={request.photoURL} className="w-10 h-10 rounded-full border-2 border-indigo-500/30" alt="" />
                                                                        ) : (
                                                                            <div className={`w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500/30 to-violet-500/30 flex items-center justify-center`}>
                                                                                <User className="w-5 h-5 text-indigo-500" />
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                    <div className="flex-1 min-w-0">
                                                                        <div className={`font-bold text-sm truncate ${textMain}`}>{request.displayName}</div>
                                                                        <div className={`text-xs ${textSub}`}>Wants to be friends</div>
                                                                    </div>
                                                                    <div className="flex gap-1">
                                                                        <button
                                                                            onClick={() => acceptFriendRequest(request.id)}
                                                                            className="p-2 rounded-lg bg-emerald-500/20 text-emerald-500 hover:bg-emerald-500/30 transition-colors"
                                                                            title="Accept"
                                                                        >
                                                                            <Check className="w-4 h-4" />
                                                                        </button>
                                                                        <button
                                                                            onClick={() => rejectFriendRequest(request.id)}
                                                                            className="p-2 rounded-lg bg-red-500/20 text-red-500 hover:bg-red-500/30 transition-colors"
                                                                            title="Decline"
                                                                        >
                                                                            <X className="w-4 h-4" />
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}

                                                {/* Friends List */}
                                                <div className={`text-xs font-bold uppercase tracking-wider px-2 py-2 ${textSub}`}>
                                                    <Heart className="w-3 h-3 inline mr-1" />
                                                    Your Friends ({friends.length})
                                                </div>
                                                {friends.length === 0 ? (
                                                    <div className={`p-8 text-center ${textSub}`}>
                                                        <Heart className="w-12 h-12 mx-auto mb-3 opacity-30" />
                                                        <p className="text-sm font-medium">No friends yet</p>
                                                        <p className="text-xs mt-1">Go to Users tab to add friends!</p>
                                                        <button
                                                            onClick={() => setActiveTab('users')}
                                                            className={`mt-4 px-4 py-2 rounded-xl text-sm font-bold transition-all ${theme === 'dark'
                                                                ? 'bg-indigo-500/20 text-indigo-400 hover:bg-indigo-500/30'
                                                                : 'bg-indigo-100 text-indigo-600 hover:bg-indigo-200'
                                                                }`}
                                                        >
                                                            <UserPlus className="w-4 h-4 inline mr-2" />
                                                            Find Friends
                                                        </button>
                                                    </div>
                                                ) : (
                                                    friends
                                                        .filter(f =>
                                                            !searchQuery ||
                                                            f.displayName?.toLowerCase().includes(searchQuery.toLowerCase())
                                                        )
                                                        .map(friend => {
                                                            const isOnline = friend.lastSeen && (Date.now() - friend.lastSeen) < 5 * 60 * 1000;
                                                            return (
                                                                <div
                                                                    key={friend.id}
                                                                    onClick={() => onViewProfile && onViewProfile(friend)}
                                                                    className={`w-full p-3 rounded-xl ${hoverBg} transition-all flex items-center gap-3 group cursor-pointer`}
                                                                >
                                                                    <div className="relative">
                                                                        {friend.photoURL ? (
                                                                            <img src={friend.photoURL} className="w-11 h-11 rounded-full border-2 border-white/20" alt="" />
                                                                        ) : (
                                                                            <div className={`w-11 h-11 rounded-full ${theme === 'dark' ? 'bg-gradient-to-br from-indigo-500/30 to-violet-500/30' : 'bg-gradient-to-br from-indigo-100 to-violet-100'} flex items-center justify-center`}>
                                                                                <User className="w-5 h-5 text-indigo-500" />
                                                                            </div>
                                                                        )}
                                                                        <div className={`absolute bottom-0 right-0 w-3.5 h-3.5 rounded-full border-2 ${theme === 'dark' ? 'border-[#0f172a]' : 'border-white'} ${isOnline ? 'bg-emerald-500' : 'bg-slate-400'}`}></div>
                                                                    </div>
                                                                    <div className="flex-1 text-left min-w-0">
                                                                        <div className="flex items-center gap-2">
                                                                            <span className={`font-bold text-sm truncate ${textMain}`}>{friend.displayName}</span>
                                                                            <Heart className="w-3 h-3 text-pink-500 fill-pink-500" />
                                                                        </div>
                                                                        <div className={`text-xs truncate ${textSub}`}>
                                                                            {isOnline ? (
                                                                                <span className="text-emerald-500 font-medium">â— Online now</span>
                                                                            ) : friend.lastSeen ? (
                                                                                `Last seen ${formatTime(friend.lastSeen)}`
                                                                            ) : (
                                                                                'Friend'
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                    <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                        <button
                                                                            onClick={(e) => { e.stopPropagation(); onViewProfile && onViewProfile(friend); }}
                                                                            className={`p-2 rounded-lg ${theme === 'dark' ? 'bg-violet-500/20 hover:bg-violet-500/30' : 'bg-violet-100 hover:bg-violet-200'} transition-colors`}
                                                                            title="View Profile"
                                                                        >
                                                                            <Eye className="w-4 h-4 text-violet-500" />
                                                                        </button>
                                                                        <button
                                                                            onClick={(e) => { e.stopPropagation(); startConversation(friend); }}
                                                                            className={`p-2 rounded-lg ${theme === 'dark' ? 'bg-indigo-500/20 hover:bg-indigo-500/30' : 'bg-indigo-100 hover:bg-indigo-200'} transition-colors`}
                                                                            title="Message"
                                                                        >
                                                                            <Send className="w-4 h-4 text-indigo-500" />
                                                                        </button>
                                                                        <button
                                                                            onClick={(e) => { e.stopPropagation(); confirmRemoveFriend(friend); }}
                                                                            className={`p-2 rounded-lg ${theme === 'dark' ? 'bg-red-500/20 hover:bg-red-500/30' : 'bg-red-100 hover:bg-red-200'} transition-colors`}
                                                                            title="Remove Friend"
                                                                        >
                                                                            <UserMinus className="w-4 h-4 text-red-500" />
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })
                                                )}

                                                {/* Sent Requests */}
                                                {sentRequests.length > 0 && (
                                                    <div className="mt-4">
                                                        <div className={`text-xs font-bold uppercase tracking-wider px-2 py-2 ${textSub}`}>
                                                            Pending Requests ({sentRequests.length})
                                                        </div>
                                                        {allUsers.filter(u => sentRequests.includes(u.uid)).map(pendingUser => (
                                                            <div key={pendingUser.uid} className={`p-3 rounded-xl ${hoverBg} flex items-center gap-3`}>
                                                                <div className="relative">
                                                                    {pendingUser.photoURL ? (
                                                                        <img src={pendingUser.photoURL} className="w-10 h-10 rounded-full opacity-70" alt="" />
                                                                    ) : (
                                                                        <div className={`w-10 h-10 rounded-full ${theme === 'dark' ? 'bg-slate-700' : 'bg-slate-200'} flex items-center justify-center opacity-70`}>
                                                                            <User className="w-5 h-5 text-slate-500" />
                                                                        </div>
                                                                    )}
                                                                </div>
                                                                <div className="flex-1 min-w-0">
                                                                    <div className={`font-medium text-sm truncate ${textMain} opacity-70`}>{pendingUser.displayName}</div>
                                                                    <div className={`text-xs ${textSub}`}>Request pending...</div>
                                                                </div>
                                                                <button
                                                                    onClick={() => rejectFriendRequest(pendingUser.uid, true)}
                                                                    className={`px-3 py-1.5 rounded-lg text-xs font-medium ${theme === 'dark' ? 'bg-slate-700 text-slate-400 hover:bg-slate-600' : 'bg-slate-200 text-slate-600 hover:bg-slate-300'} transition-colors`}
                                                                >
                                                                    Cancel
                                                                </button>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </>
                                        )}
                                    </div>
                                ) : activeTab === 'users' ? (
                                    /* Users Tab */
                                    <div className="p-2">
                                        {isLoadingUsers ? (
                                            <div className={`p-8 text-center ${textSub}`}>
                                                <Loader2 className="w-8 h-8 mx-auto mb-3 animate-spin text-indigo-500" />
                                                <p className="text-sm">Loading users...</p>
                                            </div>
                                        ) : allUsers.length === 0 ? (
                                            <div className={`p-8 text-center ${textSub}`}>
                                                <Users className="w-12 h-12 mx-auto mb-3 opacity-30" />
                                                <p className="text-sm font-medium">No other users yet</p>
                                                <p className="text-xs mt-1">Be the first to invite friends!</p>
                                            </div>
                                        ) : (
                                            <>
                                                <div className={`text-xs font-bold uppercase tracking-wider px-2 py-2 ${textSub}`}>
                                                    Registered Users ({allUsers.filter(u =>
                                                        !searchQuery ||
                                                        u.displayName?.toLowerCase().includes(searchQuery.toLowerCase()) ||
                                                        u.email?.toLowerCase().includes(searchQuery.toLowerCase())
                                                    ).length})
                                                </div>
                                                {allUsers
                                                    .filter(u =>
                                                        !searchQuery ||
                                                        u.displayName?.toLowerCase().includes(searchQuery.toLowerCase()) ||
                                                        u.email?.toLowerCase().includes(searchQuery.toLowerCase())
                                                    )
                                                    .map(userItem => {
                                                        const isOnline = userItem.lastSeen && (Date.now() - userItem.lastSeen) < 5 * 60 * 1000;
                                                        const hasConversation = conversations.some(c => c.participants.includes(userItem.uid));
                                                        const friendStatus = getFriendshipStatus(userItem.uid);
                                                        return (
                                                            <div
                                                                key={userItem.uid}
                                                                className={`w-full p-3 rounded-xl ${hoverBg} transition-all flex items-center gap-3 group`}
                                                            >
                                                                <div className="relative">
                                                                    {userItem.photoURL ? (
                                                                        <img src={userItem.photoURL} className="w-11 h-11 rounded-full border-2 border-white/20" alt="" />
                                                                    ) : (
                                                                        <div className={`w-11 h-11 rounded-full ${theme === 'dark' ? 'bg-gradient-to-br from-indigo-500/30 to-violet-500/30' : 'bg-gradient-to-br from-indigo-100 to-violet-100'} flex items-center justify-center`}>
                                                                            <User className="w-5 h-5 text-indigo-500" />
                                                                        </div>
                                                                    )}
                                                                    {/* Online indicator */}
                                                                    <div className={`absolute bottom-0 right-0 w-3.5 h-3.5 rounded-full border-2 ${theme === 'dark' ? 'border-[#0f172a]' : 'border-white'} ${isOnline ? 'bg-emerald-500' : 'bg-slate-400'}`}></div>
                                                                </div>
                                                                <div className="flex-1 text-left min-w-0">
                                                                    <div className="flex items-center gap-2">
                                                                        <span className={`font-bold text-sm truncate ${textMain}`}>{userItem.displayName}</span>
                                                                        {friendStatus === 'friends' && (
                                                                            <Heart className="w-3 h-3 text-pink-500 fill-pink-500" />
                                                                        )}
                                                                        {hasConversation && (
                                                                            <span className={`text-[9px] px-1.5 py-0.5 rounded-full ${theme === 'dark' ? 'bg-indigo-500/20 text-indigo-400' : 'bg-indigo-100 text-indigo-600'}`}>
                                                                                Chatting
                                                                            </span>
                                                                        )}
                                                                    </div>
                                                                    <div className={`text-xs truncate ${textSub}`}>
                                                                        {isOnline ? (
                                                                            <span className="text-emerald-500 font-medium">â— Online now</span>
                                                                        ) : userItem.lastSeen ? (
                                                                            `Last seen ${formatTime(userItem.lastSeen)}`
                                                                        ) : (
                                                                            userItem.email
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                    <button
                                                                        onClick={() => onViewProfile && onViewProfile(userItem)}
                                                                        className={`p-2 rounded-lg ${theme === 'dark' ? 'bg-violet-500/20 hover:bg-violet-500/30' : 'bg-violet-100 hover:bg-violet-200'} transition-colors`}
                                                                        title="View Profile"
                                                                    >
                                                                        <Eye className="w-4 h-4 text-violet-500" />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => startConversation(userItem)}
                                                                        className={`p-2 rounded-lg ${theme === 'dark' ? 'bg-indigo-500/20 hover:bg-indigo-500/30' : 'bg-indigo-100 hover:bg-indigo-200'} transition-colors`}
                                                                        title="Message"
                                                                    >
                                                                        <Send className="w-4 h-4 text-indigo-500" />
                                                                    </button>
                                                                    {friendStatus === 'none' && (
                                                                        <button
                                                                            onClick={() => sendFriendRequest(userItem.uid)}
                                                                            className={`p-2 rounded-lg ${theme === 'dark' ? 'bg-pink-500/20 hover:bg-pink-500/30' : 'bg-pink-100 hover:bg-pink-200'} transition-colors`}
                                                                            title="Add Friend"
                                                                        >
                                                                            <UserPlus className="w-4 h-4 text-pink-500" />
                                                                        </button>
                                                                    )}
                                                                    {friendStatus === 'pending' && (
                                                                        <button
                                                                            className={`p-2 rounded-lg ${theme === 'dark' ? 'bg-slate-700' : 'bg-slate-200'} cursor-default`}
                                                                            title="Request Pending"
                                                                        >
                                                                            <Clock className="w-4 h-4 text-slate-500" />
                                                                        </button>
                                                                    )}
                                                                    {friendStatus === 'incoming' && (
                                                                        <button
                                                                            onClick={() => acceptFriendRequest(userItem.uid)}
                                                                            className={`p-2 rounded-lg ${theme === 'dark' ? 'bg-emerald-500/20 hover:bg-emerald-500/30' : 'bg-emerald-100 hover:bg-emerald-200'} transition-colors`}
                                                                            title="Accept Request"
                                                                        >
                                                                            <UserCheck className="w-4 h-4 text-emerald-500" />
                                                                        </button>
                                                                    )}
                                                                    {friendStatus === 'friends' && (
                                                                        <button
                                                                            className={`p-2 rounded-lg ${theme === 'dark' ? 'bg-pink-500/20' : 'bg-pink-100'} cursor-default`}
                                                                            title="Friends"
                                                                        >
                                                                            <Heart className="w-4 h-4 text-pink-500 fill-pink-500" />
                                                                        </button>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                            </>
                                        )}
                                    </div>
                                ) : (
                                    /* Chats Tab */
                                    <>
                                        {searchQuery && searchResults.length > 0 ? (
                                            <div className="p-2">
                                                <div className={`text-xs font-bold uppercase tracking-wider px-2 py-2 ${textSub}`}>Search Results</div>
                                                {searchResults.map(userResult => (
                                                    <button
                                                        key={userResult.uid}
                                                        onClick={() => startConversation(userResult)}
                                                        className={`w-full p-3 rounded-xl ${hoverBg} transition-colors flex items-center gap-3`}
                                                    >
                                                        <div className="relative">
                                                            {userResult.photoURL ? (
                                                                <img src={userResult.photoURL} className="w-10 h-10 rounded-full" alt="" />
                                                            ) : (
                                                                <div className={`w-10 h-10 rounded-full ${theme === 'dark' ? 'bg-indigo-500/20' : 'bg-indigo-100'} flex items-center justify-center`}>
                                                                    <User className="w-5 h-5 text-indigo-500" />
                                                                </div>
                                                            )}
                                                        </div>
                                                        <div className="flex-1 text-left">
                                                            <div className={`font-bold text-sm ${textMain}`}>{userResult.displayName}</div>
                                                            <div className={`text-xs ${textSub}`}>{userResult.email}</div>
                                                        </div>
                                                    </button>
                                                ))}
                                            </div>
                                        ) : searchQuery && searchResults.length === 0 && !isSearching ? (
                                            <div className={`p-4 text-center ${textSub}`}>
                                                <Users className="w-8 h-8 mx-auto mb-2 opacity-50" />
                                                <p className="text-sm">No users found</p>
                                            </div>
                                        ) : (
                                            <div className="p-2">
                                                {conversations.length === 0 ? (
                                                    <div className={`p-8 text-center ${textSub}`}>
                                                        <MessageSquare className="w-12 h-12 mx-auto mb-3 opacity-30" />
                                                        <p className="text-sm font-medium">No conversations yet</p>
                                                        <p className="text-xs mt-1">Go to "Users" tab to start chatting!</p>
                                                        <button
                                                            onClick={() => setActiveTab('users')}
                                                            className={`mt-4 px-4 py-2 rounded-xl text-sm font-bold transition-all ${theme === 'dark'
                                                                ? 'bg-indigo-500/20 text-indigo-400 hover:bg-indigo-500/30'
                                                                : 'bg-indigo-100 text-indigo-600 hover:bg-indigo-200'
                                                                }`}
                                                        >
                                                            <Users className="w-4 h-4 inline mr-2" />
                                                            Browse Users
                                                        </button>
                                                    </div>
                                                ) : (
                                                    conversations
                                                        .filter(c =>
                                                            !searchQuery ||
                                                            c.otherUser?.displayName?.toLowerCase().includes(searchQuery.toLowerCase()) ||
                                                            c.lastMessage?.toLowerCase().includes(searchQuery.toLowerCase())
                                                        )
                                                        .map(convo => {
                                                            const unreadCount = unreadCounts[convo.id] || 0;
                                                            return (
                                                                <button
                                                                    key={convo.id}
                                                                    onClick={() => setActiveChat(convo)}
                                                                    className={`w-full p-3 rounded-xl transition-colors flex items-center gap-3 ${activeChat?.id === convo.id ? activeBg : hoverBg
                                                                        }`}
                                                                >
                                                                    <div className="relative">
                                                                        {convo.otherUser?.photoURL ? (
                                                                            <img src={convo.otherUser.photoURL} className="w-12 h-12 rounded-full" alt="" />
                                                                        ) : (
                                                                            <div className={`w-12 h-12 rounded-full ${theme === 'dark' ? 'bg-indigo-500/20' : 'bg-indigo-100'} flex items-center justify-center`}>
                                                                                <User className="w-6 h-6 text-indigo-500" />
                                                                            </div>
                                                                        )}
                                                                        {/* Online indicator for conversations */}
                                                                        {convo.otherUser?.lastSeen && (Date.now() - convo.otherUser.lastSeen) < 5 * 60 * 1000 && (
                                                                            <div className={`absolute bottom-0 right-0 w-3.5 h-3.5 rounded-full border-2 ${theme === 'dark' ? 'border-[#0f172a]' : 'border-white'} bg-emerald-500`}></div>
                                                                        )}
                                                                    </div>
                                                                    <div className="flex-1 text-left min-w-0">
                                                                        <div className="flex justify-between items-center">
                                                                            <span className={`font-bold text-sm truncate ${textMain}`}>{convo.otherUser?.displayName || 'User'}</span>
                                                                            <div className="flex items-center gap-2">
                                                                                <span className={`text-[10px] ${textSub}`}>{formatTime(convo.lastMessageTime)}</span>
                                                                                {/* Unread badge */}
                                                                                {unreadCount > 0 && (
                                                                                    <span className="min-w-[18px] h-[18px] px-1 bg-gradient-to-r from-indigo-500 to-violet-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center animate-in zoom-in">
                                                                                        {unreadCount > 99 ? '99+' : unreadCount}
                                                                                    </span>
                                                                                )}
                                                                            </div>
                                                                        </div>
                                                                        <p className={`text-xs truncate ${unreadCount > 0 ? 'font-semibold ' + textMain : textSub}`}>{convo.lastMessage || 'No messages yet'}</p>
                                                                    </div>
                                                                </button>
                                                            );
                                                        })
                                                )}
                                            </div>
                                        )}
                                    </>
                                )}
                            </div>
                        </div>

                        {/* Right Panel - Chat Area */}
                        <div className={`${activeChat ? 'flex' : 'hidden md:flex'} flex-1 flex-col`}>
                            {activeChat ? (
                                <>
                                    {/* Chat Header */}
                                    <div className={`p-4 border-b ${borderColor} flex items-center justify-between`}>
                                        <div className="flex items-center gap-3">
                                            <button
                                                onClick={() => setActiveChat(null)}
                                                className={`p-2 rounded-xl ${hoverBg} transition-colors md:hidden ${textSub}`}
                                            >
                                                <ArrowLeft className="w-5 h-5" />
                                            </button>
                                            <button
                                                onClick={() => onViewProfile && onViewProfile(activeChat.otherUser)}
                                                className="hover:opacity-80 transition-opacity"
                                                title={`View ${activeChat.otherUser?.displayName || 'User'}'s profile`}
                                            >
                                                {activeChat.otherUser?.photoURL ? (
                                                    <img src={activeChat.otherUser.photoURL} className="w-10 h-10 rounded-full" alt="" />
                                                ) : (
                                                    <div className={`w-10 h-10 rounded-full ${theme === 'dark' ? 'bg-indigo-500/20' : 'bg-indigo-100'} flex items-center justify-center`}>
                                                        <User className="w-5 h-5 text-indigo-500" />
                                                    </div>
                                                )}
                                            </button>
                                            <div>
                                                <button
                                                    onClick={() => onViewProfile && onViewProfile(activeChat.otherUser)}
                                                    className={`font-bold ${textMain} hover:text-indigo-500 transition-colors`}
                                                    title={`View ${activeChat.otherUser?.displayName || 'User'}'s profile`}
                                                >
                                                    {activeChat.otherUser?.displayName || 'User'}
                                                </button>
                                                <div className={`text-xs ${textSub}`}>
                                                    {otherUserTyping ? (
                                                        <span className="text-indigo-500 flex items-center gap-1">
                                                            <span className="flex gap-0.5">
                                                                <span className="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></span>
                                                                <span className="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></span>
                                                                <span className="w-1.5 h-1.5 bg-indigo-500 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></span>
                                                            </span>
                                                            typing...
                                                        </span>
                                                    ) : activeChat.otherUser?.lastSeen && (Date.now() - activeChat.otherUser.lastSeen) < 5 * 60 * 1000 ? (
                                                        <span className="text-emerald-500">â— Online</span>
                                                    ) : (
                                                        'Active on bureaucRatis'
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-1">
                                            <button
                                                onClick={() => { setEditDisplayName(user?.displayName || ''); setShowProfileEdit(true); }}
                                                className={`p-2 rounded-xl ${hoverBg} transition-colors ${textSub} hover:text-indigo-500`}
                                                title="Edit your profile name"
                                            >
                                                <Pencil className="w-4 h-4" />
                                            </button>
                                            <button
                                                onClick={() => setShowDeleteConvoModal(true)}
                                                className={`p-2 rounded-xl ${hoverBg} transition-colors ${textSub} hover:text-red-500`}
                                                title="Delete conversation"
                                            >
                                                <Trash2 className="w-4 h-4" />
                                            </button>
                                        </div>
                                    </div>

                                    {/* Profile Edit Modal */}
                                    {showProfileEdit && (
                                        <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm rounded-3xl" onClick={() => setShowProfileEdit(false)}>
                                            <div className={`${theme === 'dark' ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'} p-6 rounded-2xl border shadow-2xl w-80 animate-in zoom-in-95`} onClick={e => e.stopPropagation()}>
                                                <h3 className={`text-lg font-bold mb-4 ${textMain}`}>Edit Profile Name</h3>
                                                <input
                                                    type="text"
                                                    value={editDisplayName}
                                                    onChange={e => setEditDisplayName(e.target.value)}
                                                    placeholder="Enter your display name"
                                                    className={`w-full px-4 py-3 rounded-xl border ${inputBg} outline-none focus:ring-2 focus:ring-indigo-500/50 mb-4`}
                                                    autoFocus
                                                />
                                                <div className="flex gap-2">
                                                    <button
                                                        onClick={() => setShowProfileEdit(false)}
                                                        className={`flex-1 py-2.5 rounded-xl font-bold transition-all ${theme === 'dark' ? 'bg-slate-700 text-slate-300 hover:bg-slate-600' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                                                    >
                                                        Cancel
                                                    </button>
                                                    <button
                                                        onClick={saveProfileName}
                                                        disabled={!editDisplayName.trim() || isSavingProfile}
                                                        className="flex-1 py-2.5 rounded-xl font-bold bg-gradient-to-r from-indigo-500 to-violet-500 text-white hover:from-indigo-600 hover:to-violet-600 transition-all disabled:opacity-50 flex items-center justify-center gap-2"
                                                    >
                                                        {isSavingProfile ? <Loader2 className="w-4 h-4 animate-spin" /> : <Check className="w-4 h-4" />}
                                                        Save
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Delete Conversation Modal */}
                                    {showDeleteConvoModal && (
                                        <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm rounded-3xl" onClick={() => setShowDeleteConvoModal(false)}>
                                            <div className={`${theme === 'dark' ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'} p-6 rounded-2xl border shadow-2xl w-80 animate-in zoom-in-95`} onClick={e => e.stopPropagation()}>
                                                <div className="w-12 h-12 rounded-full bg-red-500/20 flex items-center justify-center mx-auto mb-4">
                                                    <Trash2 className="w-6 h-6 text-red-500" />
                                                </div>
                                                <h3 className={`text-lg font-bold mb-2 text-center ${textMain}`}>Delete Conversation?</h3>
                                                <p className={`text-sm mb-4 text-center ${textSub}`}>
                                                    This will permanently delete all messages with {activeChat.otherUser?.displayName || 'this user'}. This action cannot be undone.
                                                </p>
                                                <div className="flex gap-2">
                                                    <button
                                                        onClick={() => setShowDeleteConvoModal(false)}
                                                        disabled={isDeletingConvo}
                                                        className={`flex-1 py-2.5 rounded-xl font-bold transition-all ${theme === 'dark' ? 'bg-slate-700 text-slate-300 hover:bg-slate-600' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'} disabled:opacity-50`}
                                                    >
                                                        Cancel
                                                    </button>
                                                    <button
                                                        onClick={deleteConversation}
                                                        disabled={isDeletingConvo}
                                                        className="flex-1 py-2.5 rounded-xl font-bold bg-gradient-to-r from-red-500 to-rose-500 text-white hover:from-red-600 hover:to-rose-600 transition-all disabled:opacity-50 flex items-center justify-center gap-2"
                                                    >
                                                        {isDeletingConvo ? <Loader2 className="w-4 h-4 animate-spin" /> : <Trash2 className="w-4 h-4" />}
                                                        Delete
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Messages */}
                                    <div className="flex-1 overflow-y-auto p-4 space-y-3 messenger-scroll">
                                        {messages.length === 0 ? (
                                            <div className={`h-full flex flex-col items-center justify-center ${textSub}`}>
                                                <div className={`w-16 h-16 rounded-full ${theme === 'dark' ? 'bg-indigo-500/20' : 'bg-indigo-100'} flex items-center justify-center mb-4`}>
                                                    <MessageCircle className="w-8 h-8 text-indigo-500" />
                                                </div>
                                                <p className="font-medium">Start the conversation!</p>
                                                <p className="text-sm">Say hello to {activeChat.otherUser?.displayName || 'this user'}</p>
                                            </div>
                                        ) : (
                                            messages.map((msg, index) => {
                                                const isOwn = msg.senderId === user.uid;
                                                const isEditing = editingMessage === msg.id;
                                                return (
                                                    <div
                                                        key={msg.id}
                                                        className={`flex ${isOwn ? 'justify-end' : 'justify-start'} animate-in slide-in-from-bottom-2 fade-in duration-300`}
                                                        style={{ animationDelay: `${Math.min(index * 30, 300)}ms` }}
                                                    >
                                                        <div className={`flex items-end gap-2 max-w-[70%] ${isOwn ? 'flex-row-reverse' : ''} group`}>
                                                            {!isOwn && (
                                                                msg.senderPhoto ? (
                                                                    <img src={msg.senderPhoto} className="w-6 h-6 rounded-full shrink-0" alt="" />
                                                                ) : (
                                                                    <div className={`w-6 h-6 rounded-full ${theme === 'dark' ? 'bg-slate-700' : 'bg-slate-200'} flex items-center justify-center shrink-0`}>
                                                                        <User className="w-3 h-3" />
                                                                    </div>
                                                                )
                                                            )}
                                                            <div className="relative">
                                                                {isEditing ? (
                                                                    <div className={`px-4 py-2.5 rounded-2xl ${theme === 'dark' ? 'bg-slate-800' : 'bg-slate-100'}`}>
                                                                        <input
                                                                            type="text"
                                                                            value={editMessageText}
                                                                            onChange={e => setEditMessageText(e.target.value)}
                                                                            className={`w-full bg-transparent outline-none text-sm ${textMain}`}
                                                                            autoFocus
                                                                            onKeyDown={e => {
                                                                                if (e.key === 'Enter') saveEditMessage();
                                                                                if (e.key === 'Escape') cancelEditMessage();
                                                                            }}
                                                                        />
                                                                        <div className="flex gap-1 mt-2">
                                                                            <button onClick={cancelEditMessage} className="text-xs px-2 py-1 rounded bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300">Cancel</button>
                                                                            <button onClick={saveEditMessage} className="text-xs px-2 py-1 rounded bg-indigo-500 text-white">Save</button>
                                                                        </div>
                                                                    </div>
                                                                ) : (
                                                                    <>
                                                                        <div className={`px-4 py-2.5 rounded-2xl transition-all ${isOwn
                                                                            ? 'bg-gradient-to-r from-indigo-500 to-violet-500 text-white rounded-br-md'
                                                                            : theme === 'dark'
                                                                                ? 'bg-slate-800 text-white rounded-bl-md'
                                                                                : 'bg-slate-100 text-slate-800 rounded-bl-md'
                                                                            }`}>
                                                                            {/* Image message - clickable for lightbox */}
                                                                            {msg.imageUrl && (
                                                                                <div className="mb-2">
                                                                                    <img
                                                                                        src={msg.imageUrl}
                                                                                        alt="Shared image"
                                                                                        className="max-w-full rounded-lg cursor-zoom-in hover:opacity-90 transition-opacity"
                                                                                        style={{ maxHeight: '200px' }}
                                                                                        onClick={(e) => {
                                                                                            e.stopPropagation();
                                                                                            setLightboxImageUrl(msg.imageUrl);
                                                                                        }}
                                                                                    />
                                                                                </div>
                                                                            )}
                                                                            {/* Text message */}
                                                                            {msg.text && <p className="text-sm leading-relaxed">{msg.text}</p>}
                                                                            <p className={`text-[10px] mt-1 flex items-center gap-1 ${isOwn ? 'text-white/70 justify-end' : textSub}`}>
                                                                                {formatTime(msg.timestamp)}
                                                                                {msg.edited && <span className="italic">(edited)</span>}
                                                                                {/* Read receipt - only for own messages */}
                                                                                {isOwn && (
                                                                                    <span className="ml-1">
                                                                                        {msg.read ? (
                                                                                            <CheckCheck className="w-3.5 h-3.5 text-emerald-300" />
                                                                                        ) : (
                                                                                            <CheckCheck className="w-3.5 h-3.5 text-white/50" />
                                                                                        )}
                                                                                    </span>
                                                                                )}
                                                                            </p>
                                                                        </div>
                                                                        {/* Edit/Delete buttons - only for own text messages */}
                                                                        {isOwn && msg.text && !msg.imageUrl && (
                                                                            <div className={`absolute ${isOwn ? 'left-0 -translate-x-full pr-2' : 'right-0 translate-x-full pl-2'} top-1/2 -translate-y-1/2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity`}>
                                                                                <button
                                                                                    onClick={() => startEditMessage(msg)}
                                                                                    className={`p-1.5 rounded-lg transition-colors ${theme === 'dark' ? 'bg-slate-700 hover:bg-slate-600 text-slate-300' : 'bg-white hover:bg-slate-100 text-slate-500 shadow-sm'}`}
                                                                                    title="Edit message"
                                                                                >
                                                                                    <Pencil className="w-3 h-3" />
                                                                                </button>
                                                                                <button
                                                                                    onClick={() => deleteMessage(msg.id)}
                                                                                    className={`p-1.5 rounded-lg transition-colors ${theme === 'dark' ? 'bg-slate-700 hover:bg-red-500/20 text-slate-300 hover:text-red-400' : 'bg-white hover:bg-red-50 text-slate-500 hover:text-red-500 shadow-sm'}`}
                                                                                    title="Delete message"
                                                                                >
                                                                                    <Trash2 className="w-3 h-3" />
                                                                                </button>
                                                                            </div>
                                                                        )}
                                                                    </>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })
                                        )}
                                        {/* Typing indicator */}
                                        {otherUserTyping && (
                                            <div className="flex justify-start animate-in slide-in-from-bottom-2 fade-in duration-200">
                                                <div className="flex items-end gap-2">
                                                    {activeChat.otherUser?.photoURL ? (
                                                        <img src={activeChat.otherUser.photoURL} className="w-6 h-6 rounded-full shrink-0" alt="" />
                                                    ) : (
                                                        <div className={`w-6 h-6 rounded-full ${theme === 'dark' ? 'bg-slate-700' : 'bg-slate-200'} flex items-center justify-center shrink-0`}>
                                                            <User className="w-3 h-3" />
                                                        </div>
                                                    )}
                                                    <div className={`px-4 py-3 rounded-2xl rounded-bl-md ${theme === 'dark' ? 'bg-slate-800' : 'bg-slate-100'}`}>
                                                        <div className="flex gap-1">
                                                            <span className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce" style={{ animationDelay: '0ms', animationDuration: '0.6s' }}></span>
                                                            <span className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce" style={{ animationDelay: '150ms', animationDuration: '0.6s' }}></span>
                                                            <span className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce" style={{ animationDelay: '300ms', animationDuration: '0.6s' }}></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                        <div ref={messagesEndRef} />
                                    </div>

                                    {/* Message Input */}
                                    <form onSubmit={sendMessage} className={`p-4 border-t ${borderColor}`}>
                                        {/* Image Preview */}
                                        {imagePreview && (
                                            <div className={`mb-3 p-3 rounded-xl ${theme === 'dark' ? 'bg-slate-800' : 'bg-slate-100'} relative animate-in slide-in-from-bottom-2`}>
                                                <button
                                                    type="button"
                                                    onClick={cancelImageSelect}
                                                    className="absolute top-2 right-2 p-1 rounded-full bg-red-500/80 text-white hover:bg-red-500 transition-colors"
                                                >
                                                    <X className="w-4 h-4" />
                                                </button>
                                                <img src={imagePreview} alt="Preview" className="max-h-32 rounded-lg mx-auto" />
                                                <button
                                                    type="button"
                                                    onClick={sendImageMessage}
                                                    disabled={isUploadingImage}
                                                    className="mt-2 w-full py-2 rounded-lg bg-gradient-to-r from-indigo-500 to-violet-500 text-white font-bold text-sm hover:from-indigo-600 hover:to-violet-600 transition-all disabled:opacity-50 flex items-center justify-center gap-2"
                                                >
                                                    {isUploadingImage ? (
                                                        <Loader2 className="w-4 h-4 animate-spin" />
                                                    ) : (
                                                        <>
                                                            <Send className="w-4 h-4" />
                                                            Send Image
                                                        </>
                                                    )}
                                                </button>
                                            </div>
                                        )}
                                        <div className="flex gap-2">
                                            {/* Hidden image input with mobile camera/gallery support */}
                                            <input
                                                type="file"
                                                accept="image/*"
                                                capture="environment"
                                                ref={imageInputRef}
                                                onChange={handleImageSelect}
                                                className="hidden"
                                            />
                                            {/* Image upload button - opens native picker on mobile */}
                                            <button
                                                type="button"
                                                onClick={() => {
                                                    // On mobile, we need to trigger the file input which will show camera/gallery options
                                                    if (imageInputRef.current) {
                                                        // Remove capture attribute temporarily to show both options on some devices
                                                        imageInputRef.current.removeAttribute('capture');
                                                        imageInputRef.current.click();
                                                    }
                                                }}
                                                className={`p-3 rounded-xl transition-all ${theme === 'dark' ? 'bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-indigo-400' : 'bg-slate-100 hover:bg-slate-200 text-slate-500 hover:text-indigo-500'}`}
                                                title="Send image (camera or gallery)"
                                            >
                                                <ImageIcon className="w-5 h-5" />
                                            </button>
                                            <input
                                                type="text"
                                                placeholder="Type a message..."
                                                value={newMessage}
                                                onChange={handleTyping}
                                                className={`flex-1 px-4 py-3 rounded-xl border ${inputBg} outline-none focus:ring-2 focus:ring-indigo-500/50 transition-all`}
                                            />
                                            <button
                                                type="submit"
                                                disabled={!newMessage.trim() || isSending}
                                                className={`px-5 py-3 rounded-xl bg-gradient-to-r from-indigo-500 to-violet-500 text-white font-bold hover:from-indigo-600 hover:to-violet-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 ${isSending ? 'animate-pulse' : ''}`}
                                            >
                                                {isSending ? <Loader2 className="w-5 h-5 animate-spin" /> : <Send className="w-5 h-5 transition-transform group-hover:translate-x-0.5" />}
                                            </button>
                                        </div>
                                    </form>
                                </>
                            ) : (
                                <div className={`flex-1 flex flex-col items-center justify-center p-6 ${textSub}`}>
                                    <div className={`w-20 h-20 md:w-24 md:h-24 rounded-full ${theme === 'dark' ? 'bg-slate-800' : 'bg-slate-100'} flex items-center justify-center mb-4 md:mb-6`}>
                                        <MessageSquare className="w-10 h-10 md:w-12 md:h-12 text-indigo-500/50" />
                                    </div>
                                    <h3 className={`text-lg md:text-xl font-bold ${textMain} mb-2 text-center`}>Welcome to Messages</h3>
                                    <p className="text-sm text-center max-w-[200px] md:max-w-xs leading-relaxed">Search for users to start a conversation and practice vocabulary together!</p>
                                </div>
                            )}
                        </div>

                        {/* Lightbox for fullscreen image viewing */}
                        {lightboxImageUrl && (
                            <div
                                className="absolute inset-0 z-[70] lightbox-overlay flex items-center justify-center p-4 cursor-zoom-out rounded-3xl"
                                onClick={() => setLightboxImageUrl(null)}
                            >
                                <button
                                    className="absolute top-4 right-4 p-3 rounded-full bg-white/10 text-white hover:bg-white/20 transition-colors z-10"
                                    onClick={() => setLightboxImageUrl(null)}
                                >
                                    <X className="w-6 h-6" />
                                </button>
                                <img
                                    src={lightboxImageUrl}
                                    alt="Full size"
                                    className="lightbox-image animate-lightbox-in"
                                    onClick={(e) => e.stopPropagation()}
                                />
                            </div>
                        )}

                        {/* Remove Friend Modal - At messenger level so it works from Friends tab */}
                        {showRemoveFriendModal && friendToRemove && (
                            <div className="absolute inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm rounded-3xl" onClick={() => { setShowRemoveFriendModal(false); setFriendToRemove(null); }}>
                                <div className={`${theme === 'dark' ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'} p-6 rounded-2xl border shadow-2xl w-80 animate-in zoom-in-95`} onClick={e => e.stopPropagation()}>
                                    <div className="w-12 h-12 rounded-full bg-red-500/20 flex items-center justify-center mx-auto mb-4">
                                        <UserMinus className="w-6 h-6 text-red-500" />
                                    </div>
                                    <h3 className={`text-lg font-bold mb-2 text-center ${textMain}`}>Remove Friend?</h3>
                                    <div className="flex items-center justify-center gap-3 mb-4">
                                        {friendToRemove.photoURL ? (
                                            <img src={friendToRemove.photoURL} className="w-12 h-12 rounded-full border-2 border-white/20" alt="" />
                                        ) : (
                                            <div className={`w-12 h-12 rounded-full ${theme === 'dark' ? 'bg-indigo-500/20' : 'bg-indigo-100'} flex items-center justify-center`}>
                                                <User className="w-6 h-6 text-indigo-500" />
                                            </div>
                                        )}
                                        <span className={`font-bold ${textMain}`}>{friendToRemove.displayName}</span>
                                    </div>
                                    <p className={`text-sm mb-4 text-center ${textSub}`}>
                                        Are you sure you want to remove this friend? You can add them back later.
                                    </p>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => { setShowRemoveFriendModal(false); setFriendToRemove(null); }}
                                            disabled={isRemovingFriend}
                                            className={`flex-1 py-2.5 rounded-xl font-bold transition-all ${theme === 'dark' ? 'bg-slate-700 text-slate-300 hover:bg-slate-600' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'} disabled:opacity-50`}
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onClick={removeFriend}
                                            disabled={isRemovingFriend}
                                            className="flex-1 py-2.5 rounded-xl font-bold bg-gradient-to-r from-red-500 to-rose-500 text-white hover:from-red-600 hover:to-rose-600 transition-all disabled:opacity-50 flex items-center justify-center gap-2"
                                        >
                                            {isRemovingFriend ? <Loader2 className="w-4 h-4 animate-spin" /> : <UserMinus className="w-4 h-4" />}
                                            Remove
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- USER PROFILE MODAL ---
        // Modal for viewing and editing user profile, showing statistics
        const UserProfileModal = ({ isOpen, onClose, user, theme, items, onSaveProfile }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [editData, setEditData] = useState({
                displayName: '',
                bio: '',
                location: ''
            });
            const [isSaving, setIsSaving] = useState(false);
            const [profileData, setProfileData] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            // Calculate statistics from items
            const stats = useMemo(() => {
                if (!items) return { total: 0, mastered: 0, learning: 0, vocaCount: 0, phraseCount: 0, synonymCount: 0, antonymCount: 0, vocaMastered: 0, phraseMastered: 0, synonymMastered: 0, antonymMastered: 0 };

                const total = items.length;
                const mastered = items.filter(i => i.interval > 21).length;
                const learning = total - mastered;

                const vocaItems = items.filter(i => i.type === 'voca');
                const phraseItems = items.filter(i => i.type === 'phrase');
                const synonymItems = items.filter(i => i.type === 'synonym');
                const antonymItems = items.filter(i => i.type === 'antonym');

                return {
                    total,
                    mastered,
                    learning,
                    vocaCount: vocaItems.length,
                    phraseCount: phraseItems.length,
                    synonymCount: synonymItems.length,
                    antonymCount: antonymItems.length,
                    vocaMastered: vocaItems.filter(i => i.interval > 21).length,
                    phraseMastered: phraseItems.filter(i => i.interval > 21).length,
                    synonymMastered: synonymItems.filter(i => i.interval > 21).length,
                    antonymMastered: antonymItems.filter(i => i.interval > 21).length
                };
            }, [items]);

            // Load profile data
            useEffect(() => {
                if (!user || !isOpen) return;
                setIsLoading(true);

                const loadProfile = async () => {
                    try {
                        const profileDoc = await getDoc(doc(db, 'artifacts', appId, 'chatUsers', user.uid));
                        if (profileDoc.exists()) {
                            const data = profileDoc.data();
                            setProfileData(data);
                            setEditData({
                                displayName: data.displayName || user.displayName || '',
                                bio: data.bio || '',
                                location: data.location || ''
                            });
                        } else {
                            setEditData({
                                displayName: user.displayName || '',
                                bio: '',
                                location: ''
                            });
                        }
                    } catch (err) {
                        console.error('Error loading profile:', err);
                    }
                    setIsLoading(false);
                };

                loadProfile();
            }, [user, isOpen]);

            const handleSave = async () => {
                if (!user || !editData.displayName.trim()) return;
                setIsSaving(true);

                try {
                    await setDoc(doc(db, 'artifacts', appId, 'chatUsers', user.uid), {
                        uid: user.uid,
                        displayName: editData.displayName.trim(),
                        bio: editData.bio.trim(),
                        location: editData.location.trim(),
                        photoURL: user.photoURL || '',
                        email: user.email || '',
                        lastSeen: Date.now()
                    }, { merge: true });

                    // Also update the profile in users collection
                    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'info'), {
                        uid: user.uid,
                        displayName: editData.displayName.trim(),
                        bio: editData.bio.trim(),
                        location: editData.location.trim(),
                        photoURL: user.photoURL || '',
                        email: user.email || '',
                        lastSeen: Date.now()
                    }, { merge: true });

                    setProfileData({ ...profileData, ...editData });
                    setIsEditing(false);
                    if (onSaveProfile) onSaveProfile(editData);
                } catch (err) {
                    console.error('Error saving profile:', err);
                }
                setIsSaving(false);
            };

            if (!isOpen) return null;

            const panelBg = theme === 'dark' ? 'bg-[#0f172a]/95' : 'bg-white/95';
            const borderColor = theme === 'dark' ? 'border-slate-700/50' : 'border-slate-200';
            const textMain = theme === 'dark' ? 'text-white' : 'text-slate-800';
            const textSub = theme === 'dark' ? 'text-slate-400' : 'text-slate-500';
            const inputBg = theme === 'dark' ? 'bg-slate-800/50 border-slate-700 text-white placeholder-slate-500' : 'bg-slate-50 border-slate-200 text-slate-800 placeholder-slate-400';
            const cardBg = theme === 'dark' ? 'bg-slate-800/50' : 'bg-slate-50';

            return (
                <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4" onClick={onClose}>
                    <div className={`${panelBg} backdrop-blur-xl rounded-3xl max-w-lg w-full shadow-2xl border ${borderColor} animate-in zoom-in-95 max-h-[90vh] overflow-hidden flex flex-col`} onClick={e => e.stopPropagation()}>
                        {/* Header */}
                        <div className={`p-6 border-b ${borderColor} flex items-center justify-between`}>
                            <h2 className={`text-xl font-bold ${textMain}`}>
                                {isEditing ? 'Edit Profile' : 'My Profile'}
                            </h2>
                            <button onClick={onClose} className={`p-2 rounded-xl ${theme === 'dark' ? 'hover:bg-slate-700' : 'hover:bg-slate-100'} transition-colors`}>
                                <X className="w-5 h-5" />
                            </button>
                        </div>

                        {/* Content */}
                        <div className="flex-1 overflow-y-auto p-6">
                            {isLoading ? (
                                <div className="flex justify-center py-12">
                                    <Loader2 className="w-8 h-8 animate-spin text-indigo-500" />
                                </div>
                            ) : (
                                <>
                                    {/* Profile Header */}
                                    <div className="flex items-center gap-4 mb-6">
                                        {user?.photoURL ? (
                                            <img src={user.photoURL} className="w-20 h-20 rounded-full border-4 border-indigo-500/20" alt="" />
                                        ) : (
                                            <div className="w-20 h-20 rounded-full bg-gradient-to-br from-indigo-500 to-violet-500 flex items-center justify-center text-white text-2xl font-bold">
                                                {editData.displayName?.charAt(0) || user?.displayName?.charAt(0) || '?'}
                                            </div>
                                        )}
                                        <div className="flex-1">
                                            {isEditing ? (
                                                <input
                                                    type="text"
                                                    value={editData.displayName}
                                                    onChange={e => setEditData({ ...editData, displayName: e.target.value })}
                                                    placeholder="Display Name"
                                                    className={`w-full px-4 py-2 rounded-xl border ${inputBg} outline-none focus:ring-2 focus:ring-indigo-500/50 text-lg font-bold`}
                                                    maxLength={32}
                                                />
                                            ) : (
                                                <h3 className={`text-2xl font-bold ${textMain}`}>{profileData?.displayName || user?.displayName || 'Anonymous'}</h3>
                                            )}
                                        </div>
                                    </div>

                                    {/* Bio and Location */}
                                    {isEditing ? (
                                        <div className="space-y-4 mb-6">
                                            <div>
                                                <label className={`text-sm font-bold ${textSub} block mb-2`}>Bio</label>
                                                <textarea
                                                    value={editData.bio}
                                                    onChange={e => setEditData({ ...editData, bio: e.target.value })}
                                                    placeholder="Tell us about yourself..."
                                                    rows={3}
                                                    className={`w-full px-4 py-3 rounded-xl border ${inputBg} outline-none focus:ring-2 focus:ring-indigo-500/50 resize-none`}
                                                    maxLength={200}
                                                />
                                                <p className={`text-xs ${textSub} mt-1`}>{editData.bio.length}/200</p>
                                            </div>
                                            <div>
                                                <label className={`text-sm font-bold ${textSub} block mb-2`}>Location</label>
                                                <input
                                                    type="text"
                                                    value={editData.location}
                                                    onChange={e => setEditData({ ...editData, location: e.target.value })}
                                                    placeholder="Where are you from?"
                                                    className={`w-full px-4 py-3 rounded-xl border ${inputBg} outline-none focus:ring-2 focus:ring-indigo-500/50`}
                                                    maxLength={50}
                                                />
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="mb-6">
                                            {(profileData?.bio || profileData?.location) && (
                                                <div className={`${cardBg} rounded-2xl p-4`}>
                                                    {profileData?.bio && <p className={`${textMain} mb-2`}>{profileData.bio}</p>}
                                                    {profileData?.location && (
                                                        <p className={`text-sm ${textSub} flex items-center gap-1`}>
                                                            <span>ðŸ“</span> {profileData.location}
                                                        </p>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Statistics Section */}
                                    <div className="mb-6">
                                        <h4 className={`font-bold ${textMain} mb-4 flex items-center gap-2`}>
                                            <Activity className="w-5 h-5 text-indigo-500" />
                                            Learning Statistics
                                        </h4>

                                        {/* Overview Stats */}
                                        <div className="grid grid-cols-3 gap-3 mb-4">
                                            <div className={`${cardBg} rounded-xl p-4 text-center`}>
                                                <div className={`text-2xl font-black ${textMain}`}>{stats.total}</div>
                                                <div className={`text-xs font-bold ${textSub} uppercase`}>Total</div>
                                            </div>
                                            <div className={`${cardBg} rounded-xl p-4 text-center`}>
                                                <div className="text-2xl font-black text-emerald-500">{stats.mastered}</div>
                                                <div className={`text-xs font-bold ${textSub} uppercase`}>Mastered</div>
                                            </div>
                                            <div className={`${cardBg} rounded-xl p-4 text-center`}>
                                                <div className="text-2xl font-black text-amber-500">{stats.learning}</div>
                                                <div className={`text-xs font-bold ${textSub} uppercase`}>Learning</div>
                                            </div>
                                        </div>

                                        {/* Category Breakdown */}
                                        <div className="space-y-3">
                                            <div className={`${cardBg} rounded-xl p-4 flex items-center justify-between`}>
                                                <div className="flex items-center gap-3">
                                                    <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-blue-500 flex items-center justify-center">
                                                        <Book className="w-5 h-5 text-white" />
                                                    </div>
                                                    <div>
                                                        <div className={`font-bold ${textMain}`}>Words</div>
                                                        <div className={`text-xs ${textSub}`}>{stats.vocaMastered} mastered</div>
                                                    </div>
                                                </div>
                                                <div className={`text-xl font-black ${textMain}`}>{stats.vocaCount}</div>
                                            </div>

                                            <div className={`${cardBg} rounded-xl p-4 flex items-center justify-between`}>
                                                <div className="flex items-center gap-3">
                                                    <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center">
                                                        <MessageCircle className="w-5 h-5 text-white" />
                                                    </div>
                                                    <div>
                                                        <div className={`font-bold ${textMain}`}>Phrases</div>
                                                        <div className={`text-xs ${textSub}`}>{stats.phraseMastered} mastered</div>
                                                    </div>
                                                </div>
                                                <div className={`text-xl font-black ${textMain}`}>{stats.phraseCount}</div>
                                            </div>

                                            <div className={`${cardBg} rounded-xl p-4 flex items-center justify-between`}>
                                                <div className="flex items-center gap-3">
                                                    <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-violet-500 to-purple-500 flex items-center justify-center">
                                                        <LinkIcon className="w-5 h-5 text-white" />
                                                    </div>
                                                    <div>
                                                        <div className={`font-bold ${textMain}`}>Synonyms</div>
                                                        <div className={`text-xs ${textSub}`}>{stats.synonymMastered} mastered</div>
                                                    </div>
                                                </div>
                                                <div className={`text-xl font-black ${textMain}`}>{stats.synonymCount}</div>
                                            </div>

                                            <div className={`${cardBg} rounded-xl p-4 flex items-center justify-between`}>
                                                <div className="flex items-center gap-3">
                                                    <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-rose-500 to-pink-500 flex items-center justify-center">
                                                        <ArrowLeftRight className="w-5 h-5 text-white" />
                                                    </div>
                                                    <div>
                                                        <div className={`font-bold ${textMain}`}>Antonyms</div>
                                                        <div className={`text-xs ${textSub}`}>{stats.antonymMastered} mastered</div>
                                                    </div>
                                                </div>
                                                <div className={`text-xl font-black ${textMain}`}>{stats.antonymCount}</div>
                                            </div>
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>

                        {/* Footer Actions */}
                        <div className={`p-6 border-t ${borderColor}`}>
                            {isEditing ? (
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => setIsEditing(false)}
                                        className={`flex-1 py-3 rounded-xl font-bold ${theme === 'dark' ? 'bg-slate-700 text-slate-300 hover:bg-slate-600' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'} transition-colors`}
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={handleSave}
                                        disabled={!editData.displayName.trim() || isSaving}
                                        className="flex-1 py-3 rounded-xl font-bold bg-gradient-to-r from-indigo-500 to-violet-500 text-white hover:from-indigo-600 hover:to-violet-600 transition-all disabled:opacity-50 flex items-center justify-center gap-2"
                                    >
                                        {isSaving ? <Loader2 className="w-4 h-4 animate-spin" /> : <Check className="w-4 h-4" />}
                                        Save Changes
                                    </button>
                                </div>
                            ) : (
                                <button
                                    onClick={() => setIsEditing(true)}
                                    className="w-full py-3 rounded-xl font-bold bg-gradient-to-r from-indigo-500 to-violet-500 text-white hover:from-indigo-600 hover:to-violet-600 transition-all flex items-center justify-center gap-2"
                                >
                                    <Pencil className="w-4 h-4" />
                                    Edit Profile
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- USER PUBLIC PROFILE VIEW ---
        // View another user's public profile with their vocabulary items
        const UserPublicProfile = ({ isOpen, onClose, targetUser, theme, currentUser, showToast }) => {
            const [profileData, setProfileData] = useState(null);
            const [userItems, setUserItems] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [activeCategory, setActiveCategory] = useState('all');
            const [error, setError] = useState(null);
            const [copiedItems, setCopiedItems] = useState({});

            // Reset copied state when modal opens/target changes
            useEffect(() => {
                setCopiedItems({});
            }, [targetUser, isOpen]);

            // Copy a single item directly into the current user's Received Words
            const copyItemToProfile = async (item) => {
                if (!currentUser || copiedItems[item.id]) return;
                try {
                    const senderName = profileData?.displayName || targetUser?.displayName || 'User';
                    const newItem = {
                        type: item.type,
                        mainText: item.mainText,
                        context: item.context || '',
                        pos: item.pos || '',
                        ipa: item.ipa || '',
                        example: item.example || '',
                        collocations: item.collocations || [],
                        related: item.related || [],
                        easiness: 2.5,
                        interval: 0,
                        nextReview: Date.now(),
                        importedAt: Date.now(),
                        sharedBy: {
                            uid: targetUser.uid || targetUser.id,
                            displayName: senderName,
                            photoURL: profileData?.photoURL || targetUser?.photoURL || ''
                        }
                    };
                    await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'vocabulary'), newItem);
                    setCopiedItems(prev => ({ ...prev, [item.id]: true }));
                    if (showToast) showToast(`"${item.mainText}" added to Received Words!`, 'success');
                } catch (err) {
                    console.error('Error copying item:', err);
                    if (showToast) showToast('Failed to copy item', 'error');
                }
            };

            // Load user profile and vocabulary
            useEffect(() => {
                if (!targetUser || !isOpen) return;
                setIsLoading(true);
                setError(null);

                const loadUserData = async () => {
                    try {
                        // Load profile
                        const profileDoc = await getDoc(doc(db, 'artifacts', appId, 'chatUsers', targetUser.uid || targetUser.id));
                        if (profileDoc.exists()) {
                            setProfileData(profileDoc.data());
                        }

                        // Load vocabulary items
                        const vocabQuery = query(collection(db, 'artifacts', appId, 'users', targetUser.uid || targetUser.id, 'vocabulary'));
                        const vocabSnapshot = await getDocs(vocabQuery);
                        const items = vocabSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setUserItems(items);
                    } catch (err) {
                        console.error('Error loading user data:', err);
                        setError('Could not load user profile');
                    }
                    setIsLoading(false);
                };

                loadUserData();
            }, [targetUser, isOpen]);

            // Calculate stats
            const stats = useMemo(() => {
                const total = userItems.length;
                const mastered = userItems.filter(i => i.interval > 21).length;
                const vocaCount = userItems.filter(i => i.type === 'voca').length;
                const phraseCount = userItems.filter(i => i.type === 'phrase').length;
                const synonymCount = userItems.filter(i => i.type === 'synonym').length;
                const antonymCount = userItems.filter(i => i.type === 'antonym').length;
                return { total, mastered, vocaCount, phraseCount, synonymCount, antonymCount };
            }, [userItems]);

            // Filter items by category
            const filteredItems = useMemo(() => {
                if (activeCategory === 'all') return userItems;
                return userItems.filter(i => i.type === activeCategory);
            }, [userItems, activeCategory]);

            if (!isOpen) return null;

            const panelBg = theme === 'dark' ? 'bg-[#0f172a]/95' : 'bg-white/95';
            const borderColor = theme === 'dark' ? 'border-slate-700/50' : 'border-slate-200';
            const textMain = theme === 'dark' ? 'text-white' : 'text-slate-800';
            const textSub = theme === 'dark' ? 'text-slate-400' : 'text-slate-500';
            const cardBg = theme === 'dark' ? 'bg-slate-800/50' : 'bg-slate-50';

            const categories = [
                { id: 'all', label: 'All', icon: Layers, count: stats.total },
                { id: 'voca', label: 'Words', icon: Book, count: stats.vocaCount, color: 'from-indigo-500 to-blue-500' },
                { id: 'phrase', label: 'Phrases', icon: MessageCircle, count: stats.phraseCount, color: 'from-amber-400 to-orange-500' },
                { id: 'synonym', label: 'Synonyms', icon: LinkIcon, count: stats.synonymCount, color: 'from-violet-500 to-purple-500' },
                { id: 'antonym', label: 'Antonyms', icon: ArrowLeftRight, count: stats.antonymCount, color: 'from-rose-500 to-pink-500' }
            ];

            const getItemColor = (type) => {
                switch (type) {
                    case 'voca': return 'from-indigo-500 to-blue-500';
                    case 'phrase': return 'from-amber-400 to-orange-500';
                    case 'synonym': return 'from-violet-500 to-purple-500';
                    case 'antonym': return 'from-rose-500 to-pink-500';
                    default: return 'from-slate-500 to-slate-600';
                }
            };

            const getItemIcon = (type) => {
                switch (type) {
                    case 'voca': return Book;
                    case 'phrase': return MessageCircle;
                    case 'synonym': return LinkIcon;
                    case 'antonym': return ArrowLeftRight;
                    default: return FileText;
                }
            };

            return (
                <div className="fixed inset-0 z-[260] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4" onClick={onClose}>
                    <div className={`${panelBg} backdrop-blur-xl rounded-3xl max-w-2xl w-full shadow-2xl border ${borderColor} animate-in zoom-in-95 max-h-[90vh] overflow-hidden flex flex-col`} onClick={e => e.stopPropagation()}>
                        {/* Header */}
                        <div className={`p-6 border-b ${borderColor} shrink-0`}>
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    {targetUser?.photoURL ? (
                                        <img src={targetUser.photoURL} className="w-14 h-14 rounded-full border-2 border-indigo-500/20" alt="" />
                                    ) : (
                                        <div className="w-14 h-14 rounded-full bg-gradient-to-br from-indigo-500 to-violet-500 flex items-center justify-center text-white text-xl font-bold">
                                            {targetUser?.displayName?.charAt(0) || '?'}
                                        </div>
                                    )}
                                    <div>
                                        <h2 className={`text-xl font-bold ${textMain}`}>{profileData?.displayName || targetUser?.displayName || 'User'}</h2>
                                        {profileData?.location && (
                                            <p className={`text-sm ${textSub} flex items-center gap-1`}>
                                                <span>ðŸ“</span> {profileData.location}
                                            </p>
                                        )}
                                    </div>
                                </div>
                                <button onClick={onClose} className={`p-2 rounded-xl ${theme === 'dark' ? 'hover:bg-slate-700' : 'hover:bg-slate-100'} transition-colors`}>
                                    <X className="w-5 h-5" />
                                </button>
                            </div>
                            {profileData?.bio && (
                                <p className={`mt-4 ${textSub}`}>{profileData.bio}</p>
                            )}
                        </div>

                        {/* Stats Bar */}
                        <div className={`px-6 py-4 border-b ${borderColor} flex items-center gap-6 shrink-0`}>
                            <div className="text-center">
                                <div className={`text-xl font-black ${textMain}`}>{stats.total}</div>
                                <div className={`text-xs ${textSub}`}>Total Items</div>
                            </div>
                            <div className="text-center">
                                <div className="text-xl font-black text-emerald-500">{stats.mastered}</div>
                                <div className={`text-xs ${textSub}`}>Mastered</div>
                            </div>
                        </div>

                        {/* Category Tabs */}
                        <div className={`px-6 py-4 border-b ${borderColor} flex gap-2 overflow-x-auto shrink-0 no-scrollbar`}>
                            {categories.map(cat => (
                                <button
                                    key={cat.id}
                                    onClick={() => setActiveCategory(cat.id)}
                                    className={`flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-bold transition-all whitespace-nowrap shrink-0 min-h-[40px] ${activeCategory === cat.id
                                        ? cat.color ? `bg-gradient-to-r ${cat.color} text-white` : 'bg-indigo-500 text-white'
                                        : theme === 'dark' ? 'bg-slate-800 text-slate-300 hover:bg-slate-700' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                        }`}
                                >
                                    <cat.icon className="w-4 h-4 shrink-0" />
                                    <span className="shrink-0">{cat.label} ({cat.count})</span>
                                </button>
                            ))}
                        </div>

                        {/* Content */}
                        <div className="flex-1 overflow-y-auto p-6">
                            {isLoading ? (
                                <div className="flex justify-center py-12">
                                    <Loader2 className="w-8 h-8 animate-spin text-indigo-500" />
                                </div>
                            ) : error ? (
                                <div className={`text-center py-12 ${textSub}`}>
                                    <AlertCircle className="w-12 h-12 mx-auto mb-4 opacity-30" />
                                    <p>{error}</p>
                                </div>
                            ) : filteredItems.length === 0 ? (
                                <div className={`text-center py-12 ${textSub}`}>
                                    <Layers className="w-12 h-12 mx-auto mb-4 opacity-30" />
                                    <p>No {activeCategory === 'all' ? 'items' : activeCategory + 's'} yet</p>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    {filteredItems.map((item, index) => {
                                        const ItemIcon = getItemIcon(item.type);
                                        const colorClass = getItemColor(item.type);
                                        return (
                                            <div
                                                key={item.id}
                                                className={`${cardBg} rounded-2xl p-4 flex items-center gap-4 animate-in slide-in-from-bottom-2`}
                                                style={{ animationDelay: `${index * 30}ms` }}
                                            >
                                                <div className={`w-12 h-12 rounded-xl bg-gradient-to-br ${colorClass} flex items-center justify-center shrink-0`}>
                                                    <ItemIcon className="w-6 h-6 text-white" />
                                                </div>
                                                <div className="flex-1 min-w-0">
                                                    <div className={`font-bold ${textMain} truncate`}>{item.mainText}</div>
                                                    {item.context && <div className={`text-sm ${textSub} truncate`}>{item.context}</div>}
                                                    {item.related && item.related.length > 0 && (
                                                        <div className={`text-sm ${item.type === 'antonym' ? 'text-rose-500' : 'text-violet-500'} truncate`}>
                                                            {item.type === 'antonym' ? 'â†” ' : 'â†’ '}{item.related.join(', ')}
                                                        </div>
                                                    )}
                                                </div>
                                                <div className="flex items-center gap-2 shrink-0">
                                                    <button
                                                        onClick={() => copyItemToProfile(item)}
                                                        disabled={!!copiedItems[item.id]}
                                                        title={copiedItems[item.id] ? 'Added!' : 'Add to Received Words'}
                                                        className={`p-1.5 rounded-lg transition-all ${copiedItems[item.id]
                                                            ? 'text-emerald-500'
                                                            : theme === 'dark'
                                                                ? 'text-slate-500 hover:text-indigo-400 hover:bg-slate-700'
                                                                : 'text-slate-400 hover:text-indigo-600 hover:bg-slate-100'
                                                            }`}
                                                    >
                                                        {copiedItems[item.id] ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- SHARING SYSTEM COMPONENTS ---

        // Share Vocabulary Modal - Select users and content to share
        const ShareVocabularyModal = ({ isOpen, onClose, user, items, friends, theme }) => {
            const [selectedFriend, setSelectedFriend] = useState(null);
            const [selectedType, setSelectedType] = useState('all'); // 'all', 'voca', 'synonym', 'antonym', 'phrase'
            const [selectedItems, setSelectedItems] = useState([]);
            const [isSending, setIsSending] = useState(false);
            const [step, setStep] = useState(1); // 1: select friend, 2: select content
            const [message, setMessage] = useState('');

            if (!isOpen) return null;

            const panelBg = theme === 'dark' ? 'bg-[#0f172a]/95' : 'bg-white/95';
            const borderColor = theme === 'dark' ? 'border-slate-700/50' : 'border-slate-200';
            const textMain = theme === 'dark' ? 'text-white' : 'text-slate-800';
            const textSub = theme === 'dark' ? 'text-slate-400' : 'text-slate-500';
            const inputBg = theme === 'dark' ? 'bg-slate-800/50 border-slate-700 text-white' : 'bg-slate-50 border-slate-200 text-slate-800';
            const hoverBg = theme === 'dark' ? 'hover:bg-slate-800/50' : 'hover:bg-slate-50';

            const filteredItems = selectedType === 'all'
                ? items
                : items.filter(i => i.type === selectedType);

            const toggleItemSelection = (itemId) => {
                setSelectedItems(prev =>
                    prev.includes(itemId)
                        ? prev.filter(id => id !== itemId)
                        : [...prev, itemId]
                );
            };

            const selectAllItems = () => {
                if (selectedItems.length === filteredItems.length) {
                    setSelectedItems([]);
                } else {
                    setSelectedItems(filteredItems.map(i => i.id));
                }
            };

            const sendShareRequest = async () => {
                if (!selectedFriend || selectedItems.length === 0 || !user) return;
                setIsSending(true);

                try {
                    const itemsToShare = items.filter(i => selectedItems.includes(i.id));

                    // Create a share request in the recipient's inbox
                    await addDoc(collection(db, 'artifacts', appId, 'chatUsers', selectedFriend.id, 'shareRequests'), {
                        senderId: user.uid,
                        senderName: user.displayName || 'Anonymous',
                        senderPhoto: user.photoURL || '',
                        senderEmail: user.email || '',
                        items: itemsToShare.map(item => ({
                            ...item,
                            originalId: item.id,
                            sharedBy: {
                                uid: user.uid,
                                displayName: user.displayName || 'Anonymous',
                                photoURL: user.photoURL || '',
                                email: user.email || ''
                            },
                            sharedAt: Date.now()
                        })),
                        message: message.trim(),
                        timestamp: Date.now(),
                        status: 'pending'
                    });

                    // Reset and close
                    setSelectedFriend(null);
                    setSelectedItems([]);
                    setMessage('');
                    setStep(1);
                    onClose();
                } catch (err) {
                    console.error('Error sending share request:', err);
                }
                setIsSending(false);
            };

            const getTypeIcon = (type) => {
                switch (type) {
                    case 'voca': return <Book className="w-4 h-4" />;
                    case 'synonym': return <LinkIcon className="w-4 h-4" />;
                    case 'antonym': return <ArrowLeftRight className="w-4 h-4" />;
                    case 'phrase': return <MessageCircle className="w-4 h-4" />;
                    default: return <FileText className="w-4 h-4" />;
                }
            };

            const getTypeColor = (type) => {
                switch (type) {
                    case 'voca': return 'text-indigo-500 bg-indigo-500/10';
                    case 'synonym': return 'text-violet-500 bg-violet-500/10';
                    case 'antonym': return 'text-rose-500 bg-rose-500/10';
                    case 'phrase': return 'text-amber-500 bg-amber-500/10';
                    default: return 'text-slate-500 bg-slate-500/10';
                }
            };

            return (
                <div className="fixed inset-0 z-[260] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4" onClick={onClose}>
                    <div
                        className={`${panelBg} backdrop-blur-xl w-full max-w-lg rounded-3xl shadow-2xl border ${borderColor} overflow-hidden animate-messenger-open`}
                        onClick={e => e.stopPropagation()}
                    >
                        {/* Header */}
                        <div className={`p-5 border-b ${borderColor} flex items-center justify-between`}>
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-violet-500 flex items-center justify-center">
                                    <Share2 className="w-5 h-5 text-white" />
                                </div>
                                <div>
                                    <h3 className={`font-bold text-lg ${textMain}`}>Share Vocabulary</h3>
                                    <p className={`text-xs ${textSub}`}>Step {step} of 2</p>
                                </div>
                            </div>
                            <button onClick={onClose} className={`p-2 rounded-xl ${hoverBg} ${textSub}`}>
                                <X className="w-5 h-5" />
                            </button>
                        </div>

                        {/* Content */}
                        <div className="p-5 max-h-[60vh] overflow-y-auto">
                            {step === 1 ? (
                                /* Step 1: Select Friend */
                                <div className="space-y-4">
                                    <p className={`text-sm ${textSub}`}>Select a friend to share your vocabulary with:</p>

                                    {friends.length === 0 ? (
                                        <div className={`p-8 text-center rounded-2xl ${theme === 'dark' ? 'bg-slate-800/50' : 'bg-slate-100'}`}>
                                            <Users className={`w-12 h-12 mx-auto mb-3 ${textSub} opacity-50`} />
                                            <p className={`font-medium ${textMain}`}>No friends yet</p>
                                            <p className={`text-sm ${textSub} mt-1`}>Add friends in the Messages section first!</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-2">
                                            {friends.map(friend => (
                                                <button
                                                    key={friend.id}
                                                    onClick={() => setSelectedFriend(friend)}
                                                    className={`w-full p-3 rounded-xl transition-all flex items-center gap-3 ${selectedFriend?.id === friend.id
                                                        ? 'bg-indigo-500/20 border-2 border-indigo-500'
                                                        : `${hoverBg} border-2 border-transparent`
                                                        }`}
                                                >
                                                    {friend.photoURL ? (
                                                        <img src={friend.photoURL} className="w-10 h-10 rounded-full" alt="" />
                                                    ) : (
                                                        <div className={`w-10 h-10 rounded-full ${theme === 'dark' ? 'bg-indigo-500/20' : 'bg-indigo-100'} flex items-center justify-center`}>
                                                            <User className="w-5 h-5 text-indigo-500" />
                                                        </div>
                                                    )}
                                                    <div className="flex-1 text-left">
                                                        <div className={`font-bold text-sm ${textMain}`}>{friend.displayName}</div>
                                                        <div className={`text-xs ${textSub}`}>{friend.email}</div>
                                                    </div>
                                                    {selectedFriend?.id === friend.id && (
                                                        <Check className="w-5 h-5 text-indigo-500" />
                                                    )}
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            ) : (
                                /* Step 2: Select Content */
                                <div className="space-y-4">
                                    <div className="flex items-center gap-3 mb-4">
                                        {selectedFriend?.photoURL ? (
                                            <img src={selectedFriend.photoURL} className="w-8 h-8 rounded-full" alt="" />
                                        ) : (
                                            <div className={`w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center`}>
                                                <User className="w-4 h-4 text-indigo-500" />
                                            </div>
                                        )}
                                        <span className={`text-sm ${textSub}`}>Sharing with <span className={`font-bold ${textMain}`}>{selectedFriend?.displayName}</span></span>
                                    </div>

                                    {/* Type Filter */}
                                    <div className={`flex flex-wrap gap-2 p-1 rounded-xl ${theme === 'dark' ? 'bg-slate-800/50' : 'bg-slate-100'}`}>
                                        {[
                                            { value: 'all', label: 'All', icon: Layers },
                                            { value: 'voca', label: 'Vocab', icon: Book },
                                            { value: 'synonym', label: 'Syn', icon: LinkIcon },
                                            { value: 'antonym', label: 'Ant', icon: ArrowLeftRight },
                                            { value: 'phrase', label: 'Phr', icon: MessageCircle }
                                        ].map(({ value, label, icon: Icon }) => (
                                            <button
                                                key={value}
                                                onClick={() => { setSelectedType(value); setSelectedItems([]); }}
                                                className={`flex-1 py-2 px-3 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-1 ${selectedType === value
                                                    ? theme === 'dark'
                                                        ? 'bg-indigo-500 text-white'
                                                        : 'bg-white text-indigo-600 shadow'
                                                    : textSub
                                                    }`}
                                            >
                                                <Icon className="w-3 h-3" />
                                                {label}
                                            </button>
                                        ))}
                                    </div>

                                    {/* Select All */}
                                    <div className="flex items-center justify-between">
                                        <span className={`text-sm ${textSub}`}>{filteredItems.length} items available</span>
                                        <button
                                            onClick={selectAllItems}
                                            className={`text-xs font-bold px-3 py-1.5 rounded-lg ${theme === 'dark' ? 'bg-slate-800 text-indigo-400 hover:bg-slate-700' : 'bg-indigo-100 text-indigo-600 hover:bg-indigo-200'} transition-colors`}
                                        >
                                            {selectedItems.length === filteredItems.length ? 'Deselect All' : 'Select All'}
                                        </button>
                                    </div>

                                    {/* Items List */}
                                    <div className="space-y-2 max-h-48 overflow-y-auto">
                                        {filteredItems.length === 0 ? (
                                            <div className={`p-4 text-center ${textSub}`}>
                                                <p className="text-sm">No items in this category</p>
                                            </div>
                                        ) : (
                                            filteredItems.map(item => (
                                                <button
                                                    key={item.id}
                                                    onClick={() => toggleItemSelection(item.id)}
                                                    className={`w-full p-3 rounded-xl transition-all flex items-center gap-3 ${selectedItems.includes(item.id)
                                                        ? 'bg-indigo-500/20 border-2 border-indigo-500'
                                                        : `${hoverBg} border-2 border-transparent`
                                                        }`}
                                                >
                                                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${getTypeColor(item.type)}`}>
                                                        {getTypeIcon(item.type)}
                                                    </div>
                                                    <div className="flex-1 text-left min-w-0">
                                                        <div className={`font-bold text-sm truncate ${textMain}`}>{item.mainText}</div>
                                                        <div className={`text-xs truncate ${textSub}`}>
                                                            {item.type === 'voca' && (item.context || item.pos)}
                                                            {item.type === 'synonym' && item.related?.join(', ')}
                                                            {item.type === 'antonym' && item.related?.[0]}
                                                            {item.type === 'phrase' && item.context}
                                                        </div>
                                                    </div>
                                                    <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${selectedItems.includes(item.id)
                                                        ? 'bg-indigo-500 border-indigo-500'
                                                        : theme === 'dark' ? 'border-slate-600' : 'border-slate-300'
                                                        }`}>
                                                        {selectedItems.includes(item.id) && <Check className="w-3 h-3 text-white" />}
                                                    </div>
                                                </button>
                                            ))
                                        )}
                                    </div>

                                    {/* Optional Message */}
                                    <div className="space-y-2">
                                        <label className={`text-xs uppercase tracking-widest ${textSub} font-bold`}>Message (optional)</label>
                                        <input
                                            type="text"
                                            value={message}
                                            onChange={e => setMessage(e.target.value)}
                                            placeholder="Add a note..."
                                            className={`w-full px-4 py-3 rounded-xl border ${inputBg} outline-none focus:ring-2 focus:ring-indigo-500/50`}
                                        />
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Footer */}
                        <div className={`p-5 border-t ${borderColor} flex gap-3`}>
                            {step === 1 ? (
                                <>
                                    <button
                                        onClick={onClose}
                                        className={`flex-1 py-3 rounded-xl font-bold transition-all ${theme === 'dark' ? 'bg-slate-800 text-slate-300 hover:bg-slate-700' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={() => setStep(2)}
                                        disabled={!selectedFriend}
                                        className="flex-1 py-3 rounded-xl font-bold bg-gradient-to-r from-indigo-500 to-violet-500 text-white hover:from-indigo-600 hover:to-violet-600 transition-all disabled:opacity-50 flex items-center justify-center gap-2"
                                    >
                                        Next <ChevronRight className="w-4 h-4" />
                                    </button>
                                </>
                            ) : (
                                <>
                                    <button
                                        onClick={() => setStep(1)}
                                        className={`py-3 px-4 rounded-xl font-bold transition-all ${theme === 'dark' ? 'bg-slate-800 text-slate-300 hover:bg-slate-700' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                                    >
                                        <ArrowLeft className="w-4 h-4" />
                                    </button>
                                    <button
                                        onClick={sendShareRequest}
                                        disabled={selectedItems.length === 0 || isSending}
                                        className="flex-1 py-3 rounded-xl font-bold bg-gradient-to-r from-indigo-500 to-violet-500 text-white hover:from-indigo-600 hover:to-violet-600 transition-all disabled:opacity-50 flex items-center justify-center gap-2"
                                    >
                                        {isSending ? (
                                            <Loader2 className="w-4 h-4 animate-spin" />
                                        ) : (
                                            <>
                                                <Send className="w-4 h-4" />
                                                Share {selectedItems.length} Item{selectedItems.length !== 1 ? 's' : ''}
                                            </>
                                        )}
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Sharing Inbox - View and accept/reject share requests
        const SharingInbox = ({ isOpen, onClose, user, theme, onAcceptShare, shareRequests, onDeclineShare }) => {
            const [expandedRequest, setExpandedRequest] = useState(null);
            const [processingId, setProcessingId] = useState(null);

            if (!isOpen) return null;

            const panelBg = theme === 'dark' ? 'bg-[#0f172a]/95' : 'bg-white/95';
            const borderColor = theme === 'dark' ? 'border-slate-700/50' : 'border-slate-200';
            const textMain = theme === 'dark' ? 'text-white' : 'text-slate-800';
            const textSub = theme === 'dark' ? 'text-slate-400' : 'text-slate-500';
            const hoverBg = theme === 'dark' ? 'hover:bg-slate-800/50' : 'hover:bg-slate-50';

            const handleAccept = async (request) => {
                setProcessingId(request.id);
                await onAcceptShare(request);
                setProcessingId(null);
            };

            const handleDecline = async (request) => {
                setProcessingId(request.id);
                await onDeclineShare(request.id);
                setProcessingId(null);
            };

            const formatTime = (timestamp) => {
                if (!timestamp) return '';
                const date = new Date(timestamp);
                const now = new Date();
                const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

                if (diffDays === 0) {
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } else if (diffDays === 1) {
                    return 'Yesterday';
                } else if (diffDays < 7) {
                    return date.toLocaleDateString([], { weekday: 'short' });
                }
                return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
            };

            const getTypeIcon = (type) => {
                switch (type) {
                    case 'voca': return <Book className="w-3 h-3" />;
                    case 'synonym': return <LinkIcon className="w-3 h-3" />;
                    case 'antonym': return <ArrowLeftRight className="w-3 h-3" />;
                    case 'phrase': return <MessageCircle className="w-3 h-3" />;
                    default: return <FileText className="w-3 h-3" />;
                }
            };

            const getTypeCounts = (items) => {
                const counts = { voca: 0, synonym: 0, antonym: 0, phrase: 0 };
                items.forEach(item => {
                    if (counts[item.type] !== undefined) counts[item.type]++;
                });
                return counts;
            };

            return (
                <div className="fixed inset-0 z-[260] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4" onClick={onClose}>
                    <div
                        className={`${panelBg} backdrop-blur-xl w-full max-w-lg rounded-3xl shadow-2xl border ${borderColor} overflow-hidden animate-messenger-open`}
                        onClick={e => e.stopPropagation()}
                    >
                        {/* Header */}
                        <div className={`p-5 border-b ${borderColor} flex items-center justify-between`}>
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-500 flex items-center justify-center relative">
                                    <Inbox className="w-5 h-5 text-white" />
                                    {shareRequests.length > 0 && (
                                        <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center">
                                            {shareRequests.length}
                                        </span>
                                    )}
                                </div>
                                <div>
                                    <h3 className={`font-bold text-lg ${textMain}`}>Sharing Inbox</h3>
                                    <p className={`text-xs ${textSub}`}>Vocabulary shared with you</p>
                                </div>
                            </div>
                            <button onClick={onClose} className={`p-2 rounded-xl ${hoverBg} ${textSub}`}>
                                <X className="w-5 h-5" />
                            </button>
                        </div>

                        {/* Content */}
                        <div className="p-4 max-h-[60vh] overflow-y-auto">
                            {shareRequests.length === 0 ? (
                                <div className={`p-12 text-center`}>
                                    <div className={`w-16 h-16 rounded-full ${theme === 'dark' ? 'bg-slate-800' : 'bg-slate-100'} flex items-center justify-center mx-auto mb-4`}>
                                        <Gift className={`w-8 h-8 ${textSub}`} />
                                    </div>
                                    <p className={`font-medium ${textMain}`}>No pending shares</p>
                                    <p className={`text-sm ${textSub} mt-1`}>When friends share vocabulary with you, it will appear here!</p>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    {shareRequests.map(request => {
                                        const typeCounts = getTypeCounts(request.items || []);
                                        const isExpanded = expandedRequest === request.id;
                                        const isProcessing = processingId === request.id;

                                        return (
                                            <div
                                                key={request.id}
                                                className={`rounded-2xl border overflow-hidden transition-all ${theme === 'dark'
                                                    ? 'bg-slate-800/50 border-slate-700'
                                                    : 'bg-white border-slate-200 shadow-sm'
                                                    }`}
                                            >
                                                {/* Request Header */}
                                                <div className="p-4">
                                                    <div className="flex items-start gap-3">
                                                        {request.senderPhoto ? (
                                                            <img src={request.senderPhoto} className="w-11 h-11 rounded-full border-2 border-indigo-500/30" alt="" />
                                                        ) : (
                                                            <div className={`w-11 h-11 rounded-full bg-gradient-to-br from-indigo-500/30 to-violet-500/30 flex items-center justify-center`}>
                                                                <User className="w-5 h-5 text-indigo-500" />
                                                            </div>
                                                        )}
                                                        <div className="flex-1 min-w-0">
                                                            <div className="flex items-center justify-between">
                                                                <span className={`font-bold ${textMain}`}>{request.senderName}</span>
                                                                <span className={`text-xs ${textSub}`}>{formatTime(request.timestamp)}</span>
                                                            </div>
                                                            <p className={`text-sm ${textSub} mt-0.5`}>
                                                                Shared <span className="font-semibold text-indigo-500">{request.items?.length || 0} items</span> with you
                                                            </p>
                                                            {request.message && (
                                                                <p className={`text-sm mt-2 italic ${textSub}`}>"{request.message}"</p>
                                                            )}
                                                        </div>
                                                    </div>

                                                    {/* Type Summary */}
                                                    <div className="flex flex-wrap gap-2 mt-3">
                                                        {typeCounts.voca > 0 && (
                                                            <span className="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-indigo-500/10 text-indigo-500 text-xs font-bold">
                                                                <Book className="w-3 h-3" /> {typeCounts.voca} Vocab
                                                            </span>
                                                        )}
                                                        {typeCounts.synonym > 0 && (
                                                            <span className="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-violet-500/10 text-violet-500 text-xs font-bold">
                                                                <LinkIcon className="w-3 h-3" /> {typeCounts.synonym} Syn
                                                            </span>
                                                        )}
                                                        {typeCounts.antonym > 0 && (
                                                            <span className="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-rose-500/10 text-rose-500 text-xs font-bold">
                                                                <ArrowLeftRight className="w-3 h-3" /> {typeCounts.antonym} Ant
                                                            </span>
                                                        )}
                                                        {typeCounts.phrase > 0 && (
                                                            <span className="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-amber-500/10 text-amber-500 text-xs font-bold">
                                                                <MessageCircle className="w-3 h-3" /> {typeCounts.phrase} Phr
                                                            </span>
                                                        )}
                                                    </div>

                                                    {/* Expand/Collapse Button */}
                                                    <button
                                                        onClick={() => setExpandedRequest(isExpanded ? null : request.id)}
                                                        className={`w-full mt-3 py-2 text-xs font-bold ${textSub} hover:text-indigo-500 transition-colors flex items-center justify-center gap-1`}
                                                    >
                                                        {isExpanded ? 'Hide Details' : 'View Items'}
                                                        <ChevronDown className={`w-4 h-4 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
                                                    </button>
                                                </div>

                                                {/* Expanded Items List */}
                                                {isExpanded && (
                                                    <div className={`px-4 pb-4 border-t ${borderColor} pt-3`}>
                                                        <div className="space-y-2 max-h-40 overflow-y-auto">
                                                            {request.items?.map((item, index) => (
                                                                <div
                                                                    key={index}
                                                                    className={`p-2 rounded-lg ${theme === 'dark' ? 'bg-slate-900/50' : 'bg-slate-50'} flex items-center gap-2`}
                                                                >
                                                                    <span className={`p-1.5 rounded ${item.type === 'voca' ? 'bg-indigo-500/20 text-indigo-500' :
                                                                        item.type === 'synonym' ? 'bg-violet-500/20 text-violet-500' :
                                                                            item.type === 'antonym' ? 'bg-rose-500/20 text-rose-500' :
                                                                                'bg-amber-500/20 text-amber-500'
                                                                        }`}>
                                                                        {getTypeIcon(item.type)}
                                                                    </span>
                                                                    <div className="flex-1 min-w-0">
                                                                        <div className={`font-medium text-sm truncate ${textMain}`}>{item.mainText}</div>
                                                                        <div className={`text-xs truncate ${textSub}`}>
                                                                            {item.context || item.related?.join(', ') || item.pos}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Action Buttons */}
                                                <div className={`flex gap-2 p-4 border-t ${borderColor}`}>
                                                    <button
                                                        onClick={() => handleDecline(request)}
                                                        disabled={isProcessing}
                                                        className={`flex-1 py-2.5 rounded-xl font-bold transition-all disabled:opacity-50 ${theme === 'dark'
                                                            ? 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                                                            : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                                            }`}
                                                    >
                                                        Decline
                                                    </button>
                                                    <button
                                                        onClick={() => handleAccept(request)}
                                                        disabled={isProcessing}
                                                        className="flex-1 py-2.5 rounded-xl font-bold bg-gradient-to-r from-emerald-500 to-teal-500 text-white hover:from-emerald-600 hover:to-teal-600 transition-all disabled:opacity-50 flex items-center justify-center gap-2"
                                                    >
                                                        {isProcessing ? (
                                                            <Loader2 className="w-4 h-4 animate-spin" />
                                                        ) : (
                                                            <>
                                                                <Check className="w-4 h-4" />
                                                                Accept All
                                                            </>
                                                        )}
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- ADMIN PANEL COMPONENT ---
        const AdminPanel = ({ user, theme }) => {
            const [activeSection, setActiveSection] = useState('posts'); // 'posts', 'users', 'messages'
            const [allPosts, setAllPosts] = useState([]);
            const [allUsers, setAllUsers] = useState([]);
            const [allConversations, setAllConversations] = useState([]);
            const [selectedConversation, setSelectedConversation] = useState(null);
            const [conversationMessages, setConversationMessages] = useState([]);
            const [loading, setLoading] = useState(true);
            const [deleteConfirm, setDeleteConfirm] = useState(null);
            const [isDeleting, setIsDeleting] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [userToDelete, setUserToDelete] = useState(null);
            const [isDeletingUser, setIsDeletingUser] = useState(false);

            // Theme styles
            const panelBg = theme === 'dark' ? 'bg-slate-800/50' : 'bg-white';
            const cardBg = theme === 'dark' ? 'bg-slate-900/50' : 'bg-slate-50';
            const textMain = theme === 'dark' ? 'text-white' : 'text-slate-800';
            const textSub = theme === 'dark' ? 'text-slate-400' : 'text-slate-500';
            const borderColor = theme === 'dark' ? 'border-slate-700' : 'border-slate-200';
            const inputBg = theme === 'dark' ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-slate-200 text-slate-800';

            // Check if user is admin
            if (!isAdmin(user)) {
                return (
                    <div className="pt-44 px-4 text-center">
                        <Shield className="w-16 h-16 mx-auto text-red-500 mb-4" />
                        <h2 className={`text-2xl font-bold ${textMain}`}>Access Denied</h2>
                        <p className={textSub}>You don't have permission to access this page.</p>
                    </div>
                );
            }

            // Load all posts
            useEffect(() => {
                const q = query(collection(db, 'artifacts', appId, 'peerPosts'), orderBy('createdAt', 'desc'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setAllPosts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // Load all users
            useEffect(() => {
                const unsubscribe = onSnapshot(
                    collection(db, 'artifacts', appId, 'chatUsers'),
                    (snapshot) => {
                        setAllUsers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    }
                );
                return () => unsubscribe();
            }, []);

            // Load all conversations
            useEffect(() => {
                const unsubscribe = onSnapshot(
                    collection(db, 'artifacts', appId, 'conversations'),
                    async (snapshot) => {
                        const convos = await Promise.all(snapshot.docs.map(async (docSnap) => {
                            const data = docSnap.data();
                            // Get participant info
                            const participants = await Promise.all(data.participants?.map(async (uid) => {
                                try {
                                    const userDoc = await getDoc(doc(db, 'artifacts', appId, 'chatUsers', uid));
                                    return userDoc.exists() ? { uid, ...userDoc.data() } : { uid, displayName: 'Unknown' };
                                } catch {
                                    return { uid, displayName: 'Unknown' };
                                }
                            }) || []);
                            return { id: docSnap.id, ...data, participantInfo: participants };
                        }));
                        convos.sort((a, b) => (b.lastMessageTime || 0) - (a.lastMessageTime || 0));
                        setAllConversations(convos);
                    }
                );
                return () => unsubscribe();
            }, []);

            // Load messages for selected conversation
            useEffect(() => {
                if (!selectedConversation) {
                    setConversationMessages([]);
                    return;
                }
                const q = query(
                    collection(db, 'artifacts', appId, 'conversations', selectedConversation.id, 'messages'),
                    orderBy('timestamp', 'asc')
                );
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setConversationMessages(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return () => unsubscribe();
            }, [selectedConversation]);

            // Delete post (admin)
            const handleDeletePost = async (postId) => {
                setIsDeleting(true);
                try {
                    // Delete all comments first
                    const commentsSnapshot = await getDocs(collection(db, 'artifacts', appId, 'peerPosts', postId, 'comments'));
                    for (const commentDoc of commentsSnapshot.docs) {
                        await deleteDoc(doc(db, 'artifacts', appId, 'peerPosts', postId, 'comments', commentDoc.id));
                    }
                    // Delete the post
                    await deleteDoc(doc(db, 'artifacts', appId, 'peerPosts', postId));
                    setDeleteConfirm(null);
                } catch (err) {
                    console.error('Error deleting post:', err);
                }
                setIsDeleting(false);
            };

            // Delete user data (Firestore only - Firebase Auth deletion requires Cloud Functions)
            const handleDeleteUserData = async (userId) => {
                setIsDeletingUser(true);
                try {
                    // Delete user's posts
                    const userPosts = allPosts.filter(p => p.authorId === userId);
                    for (const post of userPosts) {
                        const commentsSnapshot = await getDocs(collection(db, 'artifacts', appId, 'peerPosts', post.id, 'comments'));
                        for (const commentDoc of commentsSnapshot.docs) {
                            await deleteDoc(doc(db, 'artifacts', appId, 'peerPosts', post.id, 'comments', commentDoc.id));
                        }
                        await deleteDoc(doc(db, 'artifacts', appId, 'peerPosts', post.id));
                    }

                    // Delete user's vocabulary
                    const vocabSnapshot = await getDocs(collection(db, 'artifacts', appId, 'users', userId, 'vocabulary'));
                    for (const vocabDoc of vocabSnapshot.docs) {
                        await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'vocabulary', vocabDoc.id));
                    }

                    // Delete user's metadata
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'metadata', 'stats'));
                    } catch { }

                    // Delete from chatUsers
                    await deleteDoc(doc(db, 'artifacts', appId, 'chatUsers', userId));

                    // Delete user profile
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'profile', 'info'));
                    } catch { }

                    setUserToDelete(null);
                    alert('User data deleted from Firestore. Note: To fully delete the Firebase Auth account, you need to use Firebase Admin SDK via Cloud Functions.');
                } catch (err) {
                    console.error('Error deleting user data:', err);
                    alert('Error deleting user data: ' + err.message);
                }
                setIsDeletingUser(false);
            };

            // Delete a specific message
            const handleDeleteMessage = async (messageId) => {
                if (!selectedConversation) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'conversations', selectedConversation.id, 'messages', messageId));
                } catch (err) {
                    console.error('Error deleting message:', err);
                }
            };

            const formatTime = (timestamp) => {
                if (!timestamp) return '';
                const date = new Date(timestamp);
                return date.toLocaleString();
            };

            // Filter posts/users based on search
            const filteredPosts = allPosts.filter(post =>
                post.content?.toLowerCase().includes(searchQuery.toLowerCase()) ||
                post.authorName?.toLowerCase().includes(searchQuery.toLowerCase())
            );

            const filteredUsers = allUsers.filter(u =>
                u.displayName?.toLowerCase().includes(searchQuery.toLowerCase()) ||
                u.email?.toLowerCase().includes(searchQuery.toLowerCase())
            );

            return (
                <div className="pt-44 pb-12 px-4 max-w-6xl mx-auto">
                    {/* Header */}
                    <div className="mb-8">
                        <div className="flex items-center gap-3 mb-2">
                            <div className="w-12 h-12 rounded-2xl bg-gradient-to-br from-red-500 to-rose-600 flex items-center justify-center">
                                <Shield className="w-6 h-6 text-white" />
                            </div>
                            <div>
                                <h1 className={`text-3xl font-black ${textMain}`}>Admin Panel</h1>
                                <p className={textSub}>Manage posts, users, and messages</p>
                            </div>
                        </div>
                    </div>

                    {/* Section Tabs */}
                    <div className={`flex gap-2 p-1.5 rounded-2xl ${cardBg} mb-6`}>
                        {[
                            { id: 'posts', label: 'Posts', icon: FileText, count: allPosts.length },
                            { id: 'users', label: 'Users', icon: Users, count: allUsers.length },
                            { id: 'messages', label: 'Messages', icon: Mail, count: allConversations.length }
                        ].map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => { setActiveSection(tab.id); setSearchQuery(''); setSelectedConversation(null); }}
                                className={`flex-1 flex items-center justify-center gap-2 py-3 px-4 rounded-xl font-bold transition-all ${activeSection === tab.id
                                    ? 'bg-gradient-to-r from-red-500 to-rose-500 text-white shadow-lg'
                                    : `${textSub} hover:bg-white/10`
                                    }`}
                            >
                                <tab.icon className="w-4 h-4" />
                                {tab.label}
                                <span className={`px-2 py-0.5 rounded-full text-xs ${activeSection === tab.id ? 'bg-white/20' : theme === 'dark' ? 'bg-slate-700' : 'bg-slate-200'
                                    }`}>{tab.count}</span>
                            </button>
                        ))}
                    </div>

                    {/* Search Bar */}
                    {activeSection !== 'messages' && (
                        <div className="mb-6">
                            <div className={`flex items-center gap-3 px-4 py-3 rounded-2xl border ${inputBg}`}>
                                <Search className={`w-5 h-5 ${textSub}`} />
                                <input
                                    type="text"
                                    placeholder={`Search ${activeSection}...`}
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    className="flex-1 bg-transparent outline-none"
                                />
                                {searchQuery && (
                                    <button onClick={() => setSearchQuery('')} className={textSub}>
                                        <X className="w-4 h-4" />
                                    </button>
                                )}
                            </div>
                        </div>
                    )}

                    {/* POSTS SECTION */}
                    {activeSection === 'posts' && (
                        <div className="space-y-4">
                            {loading ? (
                                <div className="text-center py-12">
                                    <Loader2 className={`w-8 h-8 animate-spin mx-auto ${textSub}`} />
                                </div>
                            ) : filteredPosts.length === 0 ? (
                                <div className={`text-center py-12 ${textSub}`}>
                                    <FileText className="w-12 h-12 mx-auto mb-3 opacity-50" />
                                    <p>No posts found</p>
                                </div>
                            ) : (
                                filteredPosts.map(post => (
                                    <div key={post.id} className={`${panelBg} rounded-2xl border ${borderColor} p-4`}>
                                        <div className="flex items-start gap-3">
                                            {post.authorPhoto ? (
                                                <img src={post.authorPhoto} className="w-10 h-10 rounded-full" alt="" />
                                            ) : (
                                                <div className="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-violet-500 flex items-center justify-center text-white font-bold">
                                                    {post.authorName?.charAt(0) || '?'}
                                                </div>
                                            )}
                                            <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-2 flex-wrap">
                                                    <span className={`font-bold ${textMain}`}>{post.authorName}</span>
                                                    <span className={`text-xs ${textSub}`}>({post.authorId?.slice(0, 8)}...)</span>
                                                    <span className={`text-xs ${textSub}`}>{formatTime(post.createdAt)}</span>
                                                </div>
                                                <p className={`mt-1 ${textMain}`}>{post.content}</p>
                                                <div className={`flex items-center gap-4 mt-2 text-xs ${textSub}`}>
                                                    <span>â¤ï¸ {post.likeCount || 0}</span>
                                                    <span>ðŸ’¬ {post.commentCount || 0}</span>
                                                    <span>ðŸ‘ï¸ {post.viewCount || 0}</span>
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => setDeleteConfirm(post)}
                                                className="p-2 rounded-xl bg-red-500/10 text-red-500 hover:bg-red-500/20 transition-colors"
                                            >
                                                <Trash2 className="w-5 h-5" />
                                            </button>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    )}

                    {/* USERS SECTION */}
                    {activeSection === 'users' && (
                        <div className="space-y-4">
                            {filteredUsers.length === 0 ? (
                                <div className={`text-center py-12 ${textSub}`}>
                                    <Users className="w-12 h-12 mx-auto mb-3 opacity-50" />
                                    <p>No users found</p>
                                </div>
                            ) : (
                                filteredUsers.map(u => (
                                    <div key={u.id} className={`${panelBg} rounded-2xl border ${borderColor} p-4`}>
                                        <div className="flex items-center gap-3">
                                            {u.photoURL ? (
                                                <img src={u.photoURL} className="w-12 h-12 rounded-full" alt="" />
                                            ) : (
                                                <div className="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-500 to-violet-500 flex items-center justify-center text-white font-bold text-lg">
                                                    {u.displayName?.charAt(0) || '?'}
                                                </div>
                                            )}
                                            <div className="flex-1 min-w-0">
                                                <div className={`font-bold ${textMain}`}>{u.displayName}</div>
                                                <div className={`text-sm ${textSub}`}>{u.email}</div>
                                                <div className={`text-xs ${textSub} mt-1`}>
                                                    UID: {u.uid?.slice(0, 20)}...
                                                    {u.lastSeen && ` â€¢ Last seen: ${formatTime(u.lastSeen)}`}
                                                </div>
                                            </div>
                                            {u.email !== ADMIN_EMAIL && (
                                                <button
                                                    onClick={() => setUserToDelete(u)}
                                                    className="p-2 rounded-xl bg-red-500/10 text-red-500 hover:bg-red-500/20 transition-colors"
                                                    title="Delete user data"
                                                >
                                                    <Ban className="w-5 h-5" />
                                                </button>
                                            )}
                                            {u.email === ADMIN_EMAIL && (
                                                <span className="px-3 py-1 rounded-full bg-gradient-to-r from-amber-500 to-orange-500 text-white text-xs font-bold">
                                                    ADMIN
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    )}

                    {/* MESSAGES SECTION */}
                    {activeSection === 'messages' && (
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                            {/* Conversations List */}
                            <div className={`${panelBg} rounded-2xl border ${borderColor} overflow-hidden lg:col-span-1`}>
                                <div className={`p-4 border-b ${borderColor}`}>
                                    <h3 className={`font-bold ${textMain}`}>All Conversations</h3>
                                    <p className={`text-xs ${textSub}`}>{allConversations.length} total</p>
                                </div>
                                <div className="max-h-96 overflow-y-auto">
                                    {allConversations.map(convo => (
                                        <button
                                            key={convo.id}
                                            onClick={() => setSelectedConversation(convo)}
                                            className={`w-full p-3 text-left border-b ${borderColor} transition-colors ${selectedConversation?.id === convo.id
                                                ? theme === 'dark' ? 'bg-indigo-500/20' : 'bg-indigo-50'
                                                : 'hover:bg-white/5'
                                                }`}
                                        >
                                            <div className={`font-medium text-sm ${textMain} truncate`}>
                                                {convo.participantInfo?.map(p => p.displayName).join(' â†” ')}
                                            </div>
                                            <div className={`text-xs ${textSub} truncate mt-1`}>
                                                {convo.lastMessage || 'No messages'}
                                            </div>
                                            <div className={`text-xs ${textSub} mt-1`}>
                                                {formatTime(convo.lastMessageTime)}
                                            </div>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Messages View */}
                            <div className={`${panelBg} rounded-2xl border ${borderColor} overflow-hidden lg:col-span-2`}>
                                {selectedConversation ? (
                                    <>
                                        <div className={`p-4 border-b ${borderColor} flex items-center justify-between`}>
                                            <div>
                                                <h3 className={`font-bold ${textMain}`}>
                                                    {selectedConversation.participantInfo?.map(p => p.displayName).join(' â†” ')}
                                                </h3>
                                                <p className={`text-xs ${textSub}`}>{conversationMessages.length} messages</p>
                                            </div>
                                            <button
                                                onClick={() => setSelectedConversation(null)}
                                                className={`p-2 rounded-lg ${textSub} hover:bg-white/10`}
                                            >
                                                <X className="w-4 h-4" />
                                            </button>
                                        </div>
                                        <div className="max-h-96 overflow-y-auto p-4 space-y-3">
                                            {conversationMessages.map(msg => (
                                                <div key={msg.id} className={`${cardBg} rounded-xl p-3`}>
                                                    <div className="flex items-start justify-between gap-2">
                                                        <div className="flex-1 min-w-0">
                                                            <div className="flex items-center gap-2">
                                                                <span className={`font-bold text-sm ${textMain}`}>{msg.senderName}</span>
                                                                <span className={`text-xs ${textSub}`}>{formatTime(msg.timestamp)}</span>
                                                            </div>
                                                            <p className={`text-sm mt-1 ${textMain}`}>{msg.text}</p>
                                                            {msg.imageUrl && (
                                                                <img src={msg.imageUrl} className="mt-2 max-w-xs rounded-lg" alt="" />
                                                            )}
                                                        </div>
                                                        <button
                                                            onClick={() => handleDeleteMessage(msg.id)}
                                                            className="p-1.5 rounded-lg text-red-500 hover:bg-red-500/10 transition-colors"
                                                        >
                                                            <Trash2 className="w-4 h-4" />
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                            {conversationMessages.length === 0 && (
                                                <div className={`text-center py-8 ${textSub}`}>
                                                    <Mail className="w-8 h-8 mx-auto mb-2 opacity-50" />
                                                    <p>No messages in this conversation</p>
                                                </div>
                                            )}
                                        </div>
                                    </>
                                ) : (
                                    <div className={`flex flex-col items-center justify-center h-64 ${textSub}`}>
                                        <Mail className="w-12 h-12 mb-3 opacity-50" />
                                        <p>Select a conversation to view messages</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Delete Post Confirmation Modal */}
                    {deleteConfirm && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] flex items-center justify-center p-4" onClick={() => setDeleteConfirm(null)}>
                            <div className={`${panelBg} rounded-3xl max-w-md w-full p-6 border ${borderColor}`} onClick={e => e.stopPropagation()}>
                                <div className="text-center">
                                    <div className="w-16 h-16 rounded-full bg-red-500/10 flex items-center justify-center mx-auto mb-4">
                                        <AlertCircle className="w-8 h-8 text-red-500" />
                                    </div>
                                    <h3 className={`text-xl font-bold ${textMain} mb-2`}>Delete Post?</h3>
                                    <p className={`${textSub} mb-6`}>
                                        This will permanently delete the post by <strong>{deleteConfirm.authorName}</strong> and all its comments. This action cannot be undone.
                                    </p>
                                    <div className="flex gap-3">
                                        <button
                                            onClick={() => setDeleteConfirm(null)}
                                            className={`flex-1 py-3 rounded-xl font-bold ${theme === 'dark' ? 'bg-slate-700 text-white' : 'bg-slate-100 text-slate-600'}`}
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onClick={() => handleDeletePost(deleteConfirm.id)}
                                            disabled={isDeleting}
                                            className="flex-1 py-3 rounded-xl font-bold bg-red-500 text-white hover:bg-red-600 transition-colors flex items-center justify-center gap-2"
                                        >
                                            {isDeleting ? <Loader2 className="w-4 h-4 animate-spin" /> : <Trash2 className="w-4 h-4" />}
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Delete User Confirmation Modal */}
                    {userToDelete && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] flex items-center justify-center p-4" onClick={() => setUserToDelete(null)}>
                            <div className={`${panelBg} rounded-3xl max-w-md w-full p-6 border ${borderColor}`} onClick={e => e.stopPropagation()}>
                                <div className="text-center">
                                    <div className="w-16 h-16 rounded-full bg-red-500/10 flex items-center justify-center mx-auto mb-4">
                                        <Ban className="w-8 h-8 text-red-500" />
                                    </div>
                                    <h3 className={`text-xl font-bold ${textMain} mb-2`}>Delete User Data?</h3>
                                    <p className={`${textSub} mb-2`}>
                                        This will permanently delete all data for:
                                    </p>
                                    <div className={`${cardBg} rounded-xl p-3 mb-4`}>
                                        <div className={`font-bold ${textMain}`}>{userToDelete.displayName}</div>
                                        <div className={`text-sm ${textSub}`}>{userToDelete.email}</div>
                                    </div>
                                    <p className={`text-xs ${textSub} mb-6`}>
                                        This includes: posts, vocabulary, profile, and chat data. The Firebase Auth account will remain (use Cloud Functions to delete it completely).
                                    </p>
                                    <div className="flex gap-3">
                                        <button
                                            onClick={() => setUserToDelete(null)}
                                            className={`flex-1 py-3 rounded-xl font-bold ${theme === 'dark' ? 'bg-slate-700 text-white' : 'bg-slate-100 text-slate-600'}`}
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onClick={() => handleDeleteUserData(userToDelete.uid)}
                                            disabled={isDeletingUser}
                                            className="flex-1 py-3 rounded-xl font-bold bg-red-500 text-white hover:bg-red-600 transition-colors flex items-center justify-center gap-2"
                                        >
                                            {isDeletingUser ? <Loader2 className="w-4 h-4 animate-spin" /> : <Ban className="w-4 h-4" />}
                                            Delete Data
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [items, setItems] = useState([]);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('landing');
            const [authError, setAuthError] = useState(null);
            const [isAdding, setIsAdding] = useState(false);
            const [streak, setStreak] = useState(1);

            const [reviewQueue, setReviewQueue] = useState(null);
            const [reviewMode, setReviewMode] = useState('srs');
            const [theme, setTheme] = useState('light');
            const toggleTheme = () => setTheme(prev => prev === 'light' ? 'dark' : 'light');

            // Confirmation modal state
            const [confirmModal, setConfirmModal] = useState({ isOpen: false, type: null, count: 0 });

            // Toast notification state
            const [toasts, setToasts] = useState([]);
            const showToast = (message, type = 'info') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
            };
            const removeToast = (id) => {
                setToasts(prev => prev.filter(t => t.id !== id));
            };

            // Messenger state
            const [isMessengerOpen, setIsMessengerOpen] = useState(false);
            const [totalUnreadMessages, setTotalUnreadMessages] = useState(0);

            // Sharing system state
            const [isShareModalOpen, setIsShareModalOpen] = useState(false);
            const [isSharingInboxOpen, setIsSharingInboxOpen] = useState(false);
            const [shareRequests, setShareRequests] = useState([]);
            const [friends, setFriends] = useState([]);

            // User profile modal state
            const [isProfileModalOpen, setIsProfileModalOpen] = useState(false);
            const [isPublicProfileOpen, setIsPublicProfileOpen] = useState(false);
            const [viewingUser, setViewingUser] = useState(null);

            // Game state
            const [isGameOpen, setIsGameOpen] = useState(false);

            // Function to view another user's profile
            const openPublicProfile = (targetUser) => {
                setViewingUser(targetUser);
                setIsPublicProfileOpen(true);
            };

            // --- Body scroll lock: prevent background scroll when any modal is open ---
            const isAnyModalOpen = confirmModal.isOpen || isMessengerOpen || isShareModalOpen || isSharingInboxOpen || isProfileModalOpen || isPublicProfileOpen || !!reviewQueue || isGameOpen;
            useEffect(() => {
                if (isAnyModalOpen) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = '';
                }
                return () => { document.body.style.overflow = ''; };
            }, [isAnyModalOpen]);

            // --- Mobile back button: exit confirmation when no modals are open ---
            useEffect(() => {
                window.history.pushState({ bureaucRatis: true }, '');

                const handlePopState = () => {
                    // Always re-push so the next back press is interceptable
                    window.history.pushState({ bureaucRatis: true }, '');

                    // Close modals in priority order (topmost first)
                    if (isGameOpen) { setIsGameOpen(false); return; }
                    if (isPublicProfileOpen) { setIsPublicProfileOpen(false); setViewingUser(null); return; }
                    if (isProfileModalOpen) { setIsProfileModalOpen(false); return; }
                    if (isSharingInboxOpen) { setIsSharingInboxOpen(false); return; }
                    if (isShareModalOpen) { setIsShareModalOpen(false); return; }
                    if (confirmModal.isOpen) { setConfirmModal({ isOpen: false, type: null, count: 0 }); return; }
                    if (isMessengerOpen) { setIsMessengerOpen(false); return; }
                    if (reviewQueue) { setReviewQueue(null); return; }

                    // No modal open â€” prompt exit confirmation
                    if (window.confirm('Are you sure you want to exit the app?')) {
                        window.removeEventListener('popstate', handlePopState);
                        window.history.back();
                    }
                };

                window.addEventListener('popstate', handlePopState);
                return () => window.removeEventListener('popstate', handlePopState);
            }, [isPublicProfileOpen, isProfileModalOpen, isSharingInboxOpen, isShareModalOpen, confirmModal.isOpen, isMessengerOpen, reviewQueue, isGameOpen]);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setLoading(false);
                    if (u) checkStreak(u);
                });
                return () => unsubscribe();
            }, []);
            // ... (omitting unchanged useEffects) ...
            // Instead of replacing the huge chunk, I will target specific chunks with multi_replace_file_content if I could, but wait, the instruction is replace_file_content.
            // I will target the rendering part separately or try to catch state definition and useEffects here.
            // Actually, using `replace_file_content` for non-contiguous changes is risky. 
            // I should use `multi_replace_file_content` because I'm touching state def, back button logic, and rendering logic which are far apart.


            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'vocabulary'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    // Ensure doc.id takes precedence over any stored id field
                    const data = snapshot.docs.map(docSnap => {
                        const docData = docSnap.data();
                        // Remove any stored 'id' field to prevent conflicts
                        const { id: storedId, ...restData } = docData;
                        return { ...restData, id: docSnap.id };
                    });
                    setItems(data);
                }, (err) => console.error("Sync Error:", err));
                return () => unsubscribe();
            }, [user]);

            // Load friends list for sharing
            useEffect(() => {
                if (!user) return;
                const unsubscribe = onSnapshot(
                    collection(db, 'artifacts', appId, 'chatUsers', user.uid, 'friends'),
                    async (snapshot) => {
                        const friendsData = await Promise.all(snapshot.docs.map(async (docSnap) => {
                            const friendId = docSnap.id;
                            try {
                                const userDoc = await getDoc(doc(db, 'artifacts', appId, 'chatUsers', friendId));
                                if (userDoc.exists()) {
                                    return { id: friendId, ...userDoc.data() };
                                }
                            } catch (err) {
                                console.log('Could not fetch friend profile');
                            }
                            return null;
                        }));
                        setFriends(friendsData.filter(f => f !== null));
                    }
                );
                return () => unsubscribe();
            }, [user]);

            // Load incoming share requests
            useEffect(() => {
                if (!user) return;
                const unsubscribe = onSnapshot(
                    collection(db, 'artifacts', appId, 'chatUsers', user.uid, 'shareRequests'),
                    (snapshot) => {
                        const requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        // Sort by timestamp, newest first
                        requests.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                        setShareRequests(requests);
                    }
                );
                return () => unsubscribe();
            }, [user]);

            const checkStreak = async (currentUser) => {
                try {
                    const statsRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'metadata', 'stats');
                    const statsSnap = await getDoc(statsRef);
                    const today = new Date().toDateString();
                    let newStreak = 1;
                    if (statsSnap.exists()) {
                        const data = statsSnap.data();
                        const lastLoginDate = new Date(data.lastLogin);
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        if (data.lastLogin === today) { newStreak = data.currentStreak; }
                        else if (lastLoginDate.toDateString() === yesterday.toDateString()) { newStreak = data.currentStreak + 1; }
                        else { newStreak = 1; }
                    }
                    await setDoc(statsRef, { lastLogin: today, currentStreak: newStreak }, { merge: true });
                    setStreak(newStreak);
                } catch (e) { console.error("Streak Error:", e); }
            };

            const handleAdd = async (data) => { if (user) await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'vocabulary'), data); };
            const handleDelete = async (id) => { if (user) await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'vocabulary', id)); };

            // Accept share request - add items to user's vocabulary
            const handleAcceptShare = async (request) => {
                if (!user || !request.items) return;
                try {
                    // Add each shared item to the user's vocabulary
                    for (const item of request.items) {
                        // Remove originalId and id fields to avoid conflicts with the new document ID
                        const { originalId, id, ...itemData } = item;
                        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'vocabulary'), {
                            ...itemData,
                            // Reset spaced repetition values for the new user
                            easiness: 2.5,
                            interval: 0,
                            nextReview: Date.now(),
                            importedAt: Date.now()
                        });
                    }

                    // Delete the share request
                    await deleteDoc(doc(db, 'artifacts', appId, 'chatUsers', user.uid, 'shareRequests', request.id));

                    showToast(`Added ${request.items.length} items from ${request.senderName}!`, 'success');
                } catch (err) {
                    console.error('Error accepting share:', err);
                    showToast('Failed to accept share', 'error');
                }
            };

            // Decline share request
            const handleDeclineShare = async (requestId) => {
                if (!user) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'chatUsers', user.uid, 'shareRequests', requestId));
                    showToast('Share request declined', 'info');
                } catch (err) {
                    console.error('Error declining share:', err);
                }
            };

            // Show confirmation modal for delete all
            const showDeleteAllConfirm = (type) => {
                if (!user) return;
                const itemsToDelete = items.filter(item => item.type === type);
                if (itemsToDelete.length === 0) return;
                setConfirmModal({ isOpen: true, type, count: itemsToDelete.length });
            };

            // Execute delete all after confirmation
            const executeDeleteAll = async () => {
                if (!user || !confirmModal.type) return;
                const itemsToDelete = items.filter(item => item.type === confirmModal.type);
                for (const item of itemsToDelete) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'vocabulary', item.id));
                }
                setConfirmModal({ isOpen: false, type: null, count: 0 });
            };

            const handleUpdate = async (id, data) => { if (user) await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'vocabulary', id), data); };
            const handleUpdateSRS = async (id, data) => {
                setReviewQueue(prevQueue => { if (!prevQueue) return null; return prevQueue.filter(item => item.id !== id); });
                if (user) await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'vocabulary', id), data);
            };

            const handleLogin = async () => {
                if (window.location.protocol === 'file:') {
                    showToast("Google Login requires a server. Please use the 'Live Server' extension in VS Code.", 'warning');
                    return;
                }
                const provider = new GoogleAuthProvider();
                try { await signInWithPopup(auth, provider); } catch (err) { setAuthError(err.message); }
            };

            const handleLogout = async () => { await signOut(auth); window.location.reload(); };

            const handleLoadDemo = async () => {
                if (!user) return;
                setIsAdding(true);
                const demoItems = [
                    { type: 'synonym', mainText: 'Happy', related: ['Joyful', 'Ecstatic', 'Content', 'Elated'], easiness: 2.5, interval: 0, nextReview: Date.now() - 10000 },
                    { type: 'antonym', mainText: 'Artificial', related: ['Natural'], easiness: 2.5, interval: 0, nextReview: Date.now() - 10000 },
                    { type: 'phrase', mainText: 'Could you do me a favor?', context: 'Polite Request', easiness: 2.5, interval: 0, nextReview: Date.now() - 10000 },
                    { type: 'phrase', mainText: 'It slipped my mind completely.', context: 'Apologizing for forgetting', easiness: 2.5, interval: 0, nextReview: Date.now() - 10000 }
                ];
                for (const item of demoItems) { await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'vocabulary'), item); }
                setIsAdding(false);
            };

            // Share item to Peers feed
            const handleShareToPeers = async (item, customMessage) => {
                if (!user || !customMessage) return;
                try {
                    const postType = item.type === 'phrase' ? 'phrase' : 'vocabulary';

                    await addDoc(collection(db, 'artifacts', appId, 'peerPosts'), {
                        content: customMessage,
                        type: postType,
                        authorId: user.uid,
                        authorName: user.displayName || 'Anonymous',
                        authorPhoto: user.photoURL || null,
                        createdAt: Date.now(),
                        likes: [],
                        likeCount: 0,
                        commentCount: 0,
                        sharedItem: {
                            type: item.type,
                            mainText: item.mainText,
                            context: item.context || null,
                            related: item.related || null,
                            pos: item.pos || null
                        }
                    });

                    showToast('Shared to Peers!', 'success');
                } catch (err) {
                    console.error('Error sharing to peers:', err);
                    showToast('Failed to share', 'error');
                }
            };

            const dueItems = items.filter(i => i.nextReview < Date.now());

            const startDueReview = (category = 'all') => {
                let queue = dueItems;
                if (category !== 'all') { queue = dueItems.filter(i => i.type === category); }
                if (queue.length === 0) { showToast("No due items in this category!", 'info'); return; }
                setReviewMode('srs');
                setReviewQueue(queue);
            };

            const startFlashcardSession = (type) => {
                const filtered = items.filter(i => i.type === type);
                if (filtered.length === 0) { showToast(`No ${type}s found! Add some first.`, 'info'); return; }
                const shuffled = [...filtered].sort(() => 0.5 - Math.random()).slice(0, 20); // Create copy before sort
                setReviewMode('flashcard');
                setReviewQueue(shuffled);
            };

            if (loading) return <div className="h-screen flex items-center justify-center text-indigo-400 bg-slate-900">Loading...</div>;
            if (!user) return (
                <>
                    <div className="fixed inset-0 z-[-1] bg-[radial-gradient(ellipse_at_top_left,_var(--tw-gradient-stops))] from-indigo-300 via-purple-300 to-orange-200"></div>
                    <LoginPage onLogin={handleLogin} error={authError} />
                </>
            );

            // Dynamic Background based on Theme
            const bgGradient = theme === 'dark'
                ? 'bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-slate-900 via-indigo-950 to-slate-900'
                : 'bg-[radial-gradient(ellipse_at_top_left,_var(--tw-gradient-stops))] from-indigo-300 via-purple-300 to-orange-200';

            return (
                <div className={`min-h-screen pb-20 selection:bg-indigo-500 selection:text-white relative transition-colors duration-500 ${theme === 'dark' ? 'text-slate-200' : 'text-slate-900'}`}>
                    <div className={`fixed inset-0 z-[-1] ${bgGradient} transition-colors duration-700`}></div>

                    <Navigation activeTab={activeTab} setActiveTab={setActiveTab} user={user} onLogout={handleLogout} items={items} streak={streak} theme={theme} toggleTheme={toggleTheme} setIsMessengerOpen={setIsMessengerOpen} totalUnreadMessages={totalUnreadMessages} setIsShareModalOpen={setIsShareModalOpen} setIsSharingInboxOpen={setIsSharingInboxOpen} shareRequestCount={shareRequests.length} setIsProfileModalOpen={setIsProfileModalOpen} />

                    <main>
                        {activeTab === 'landing' && (<LandingPage setActiveTab={setActiveTab} theme={theme} />)}
                        {activeTab === 'dashboard' && (<Dashboard items={items} dueCount={dueItems.length} onReview={startDueReview} onLoadDemo={handleLoadDemo} isAdding={isAdding} onFlashcards={startFlashcardSession} theme={theme} onStartGame={() => setIsGameOpen(true)} />)}
                        {activeTab === 'mylearning' && (<MyLearning items={items} onAdd={handleAdd} onDelete={handleDelete} onDeleteAll={showDeleteAllConfirm} onUpdate={handleUpdate} theme={theme} user={user} onShareToPeers={handleShareToPeers} />)}
                        {activeTab === 'peers' && (<Peers user={user} theme={theme} onViewProfile={openPublicProfile} />)}
                        {activeTab === 'admin' && (<AdminPanel user={user} theme={theme} />)}
                    </main>
                    {reviewQueue && (<ReviewSession dueItems={reviewQueue} mode={reviewMode} onClose={() => setReviewQueue(null)} onComplete={handleUpdateSRS} theme={theme} />)}

                    {/* Game Manager */}
                    {isGameOpen && (<GameManager user={user} onClose={() => setIsGameOpen(false)} items={items} theme={theme} />)}

                    {/* Custom Confirmation Modal */}
                    <ConfirmModal
                        isOpen={confirmModal.isOpen}
                        onClose={() => setConfirmModal({ isOpen: false, type: null, count: 0 })}
                        onConfirm={executeDeleteAll}
                        title="Delete All Items?"
                        message={`You're about to permanently delete ${confirmModal.count} ${confirmModal.type || ''} item${confirmModal.count !== 1 ? 's' : ''}. This action cannot be undone.`}
                        confirmText="Delete All"
                        theme={theme}
                    />

                    {/* Toast Notifications */}
                    <ToastContainer toasts={toasts} removeToast={removeToast} theme={theme} />

                    {/* Messenger */}
                    <Messenger isOpen={isMessengerOpen} onClose={() => setIsMessengerOpen(false)} user={user} theme={theme} onUnreadChange={setTotalUnreadMessages} onViewProfile={openPublicProfile} />

                    {/* Sharing System */}
                    <ShareVocabularyModal
                        isOpen={isShareModalOpen}
                        onClose={() => setIsShareModalOpen(false)}
                        user={user}
                        items={items}
                        friends={friends}
                        theme={theme}
                    />
                    <SharingInbox
                        isOpen={isSharingInboxOpen}
                        onClose={() => setIsSharingInboxOpen(false)}
                        user={user}
                        theme={theme}
                        shareRequests={shareRequests}
                        onAcceptShare={handleAcceptShare}
                        onDeclineShare={handleDeclineShare}
                    />

                    {/* User Profile Modal - View and edit own profile */}
                    <UserProfileModal
                        isOpen={isProfileModalOpen}
                        onClose={() => setIsProfileModalOpen(false)}
                        user={user}
                        theme={theme}
                        items={items}
                        onSaveProfile={(data) => showToast('Profile updated successfully!', 'success')}
                    />

                    {/* Public Profile View - View other users' profiles */}
                    <UserPublicProfile
                        isOpen={isPublicProfileOpen}
                        onClose={() => { setIsPublicProfileOpen(false); setViewingUser(null); }}
                        targetUser={viewingUser}
                        theme={theme}
                        currentUser={user}
                        showToast={showToast}
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>